<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔力音乐</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20viewBox%3D%270%200%2064%2064%27%3E%3Cdefs%3E%3ClinearGradient%20id%3D%27g%27%20x1%3D%270%27%20y1%3D%270%27%20x2%3D%271%27%20y2%3D%271%27%3E%3Cstop%20stop-color%3D%27%237B1FA2%27/%3E%3Cstop%20offset%3D%271%27%20stop-color%3D%27%23E040FB%27/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect%20width%3D%2764%27%20height%3D%2764%27%20rx%3D%2716%27%20fill%3D%27url(%23g)%27/%3E%3Cpath%20d%3D%27M16%2048V20l16%2012%2016-12v28%27%20stroke%3D%27white%27%20stroke-width%3D%276%27%20stroke-linecap%3D%27round%27%20stroke-linejoin%3D%27round%27%20fill%3D%27none%27/%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Roboto', 'sans-serif'],
                    },
                    colors: {
                        // Using CSS variables for dynamic theming
                        'material-bg': 'rgb(var(--bg-color) / <alpha-value>)',
                        'material-surface': 'rgb(var(--surface-color) / <alpha-value>)',
                        'material-text': 'rgb(var(--text-color) / <alpha-value>)',
                        'material-text-secondary': 'rgb(var(--text-secondary-color) / <alpha-value>)',
                        'material-border': 'rgb(var(--border-color) / <alpha-value>)',
                        'material-primary': 'rgb(var(--primary-color) / <alpha-value>)',
                        'material-on-primary': 'rgb(var(--on-primary-color) / <alpha-value>)',
                        'material-secondary': '#03DAC6',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Default Dark Theme */
            --bg-color: 18 18 18;
            --surface-color: 30 30 30;
            --text-color: 255 255 255;
            --text-secondary-color: 156 163 175;
            --border-color: 55 65 81;
            --primary-color: 187 134 252;
            --on-primary-color: 0 0 0;
        }

        body {
            overflow-x: hidden;
        }

        :root.light {
            /* Light Theme */
            --bg-color: 245 245 245;
            --surface-color: 255 255 255;
            --text-color: 18 18 18;
            --text-secondary-color: 97 97 97;
            --border-color: 224 224 224;
            --primary-color: 98 0 238;
            --on-primary-color: 255 255 255;
        }

        /* Material Ripple Effect */
        .ripple {
            position: relative;
            overflow: hidden;
            transform: translate3d(0, 0, 0);
        }
        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }
        .ripple:active:after {
            transform: scale(0, 0);
            opacity: 0.2;
            transition: 0s;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #121212; 
        }
        ::-webkit-scrollbar-thumb {
            background: #333; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }

        :root {
            scrollbar-color: #333 #121212;
            scrollbar-width: thin;
        }

        :root.light ::-webkit-scrollbar-track {
            background: #ffffff;
        }
        :root.light ::-webkit-scrollbar-thumb {
            background: #d1d5db;
        }
        :root.light ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        :root.light {
            scrollbar-color: #d1d5db #ffffff;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        .nav-active {
            background-color: rgb(var(--primary-color) / 0.12);
            color: rgb(var(--primary-color) / 1);
        }

        @keyframes mmPsyShift {
            0% { transform: translate3d(-8%, -6%, 0) scale(1.05) rotate(0deg); filter: hue-rotate(0deg) saturate(1.35); }
            50% { transform: translate3d(6%, 8%, 0) scale(1.18) rotate(10deg); filter: hue-rotate(140deg) saturate(1.65); }
            100% { transform: translate3d(-8%, -6%, 0) scale(1.05) rotate(0deg); filter: hue-rotate(360deg) saturate(1.35); }
        }

        @keyframes mmSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .mm-psy-shell {
            position: relative;
            overflow: hidden;
            border-radius: 24px;
        }

        #player-page-section .mm-psy-shell {
            min-height: calc(100vh - 140px);
            overflow: hidden;
            position: relative;
        }

        @media (min-width: 768px) {
            #player-page-section .mm-psy-shell {
                min-height: calc(100vh - 110px);
            }
        }

        #player-page-section .mm-psy-bg,
        #player-page-section .mm-psy-vignette {
            clip-path: inset(0 round 24px);
            border-radius: 24px;
        }

        .mm-sidebar-collapsed #desktop-sidebar {
            display: none;
        }

        .mm-psy-bg {
            position: absolute;
            inset: -35%;
            background:
                radial-gradient(closest-side at 20% 30%, rgba(187, 134, 252, 0.55), transparent 60%),
                radial-gradient(closest-side at 80% 35%, rgba(3, 218, 198, 0.45), transparent 60%),
                radial-gradient(closest-side at 50% 85%, rgba(255, 90, 205, 0.45), transparent 58%),
                radial-gradient(closest-side at 30% 75%, rgba(0, 153, 255, 0.35), transparent 55%),
                radial-gradient(closest-side at 70% 70%, rgba(98, 0, 238, 0.22), transparent 55%);
            animation: mmPsyShift 14s ease-in-out infinite;
            will-change: transform, filter;
            opacity: 0.95;
        }

        .mm-psy-vignette {
            position: absolute;
            inset: 0;
            background:
                radial-gradient(1200px 600px at 50% 10%, rgba(0, 0, 0, 0.25), transparent 60%),
                radial-gradient(900px 500px at 50% 100%, rgba(0, 0, 0, 0.45), transparent 65%),
                linear-gradient(to bottom, rgba(0,0,0,0.08), rgba(0,0,0,0.28));
            pointer-events: none;
        }

        :root.light .mm-psy-vignette {
            background:
                radial-gradient(1200px 600px at 50% 10%, rgba(255, 255, 255, 0.55), transparent 60%),
                radial-gradient(900px 500px at 50% 100%, rgba(255, 255, 255, 0.35), transparent 65%),
                linear-gradient(to bottom, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
        }

        .mm-glass {
            background: rgba(20, 20, 24, 0.44);
            border: 1px solid rgba(255, 255, 255, 0.10);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        :root.light .mm-glass {
            background: rgba(255, 255, 255, 0.55);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .mm-vinyl {
            position: relative;
            border-radius: 9999px;
            background:
                radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), transparent 45%),
                radial-gradient(circle at 70% 70%, rgba(255,255,255,0.10), transparent 55%),
                radial-gradient(circle at 50% 50%, rgba(0,0,0,0.55), rgba(0,0,0,0.92) 62%),
                repeating-radial-gradient(circle at 50% 50%, rgba(255,255,255,0.08) 0 1px, rgba(0,0,0,0) 1px 6px);
            box-shadow:
                0 24px 60px rgba(0,0,0,0.55),
                inset 0 0 0 1px rgba(255,255,255,0.08);
            transform-origin: 50% 50%;
        }

        .mm-vinyl:after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            background:
                conic-gradient(from 180deg, rgba(255,255,255,0.00), rgba(255,255,255,0.10), rgba(255,255,255,0.00), rgba(255,255,255,0.08), rgba(255,255,255,0.00));
            mix-blend-mode: overlay;
            opacity: 0.75;
            pointer-events: none;
        }

        .mm-vinyl.is-playing {
            animation: mmSpin 6.5s linear infinite;
        }

        .mm-vinyl-float {
            padding: 26px 26px 44px;
        }

        .mm-vinyl-inner {
            position: absolute;
            inset: 17%;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow:
                inset 0 0 0 1px rgba(255,255,255,0.12),
                0 10px 30px rgba(0,0,0,0.35);
            background: rgba(255,255,255,0.06);
        }

        .mm-vinyl-hole {
            position: absolute;
            inset: 46%;
            border-radius: 9999px;
            background: radial-gradient(circle, rgba(0,0,0,0.9), rgba(0,0,0,0.2));
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
            pointer-events: none;
        }

        .mm-lyrics {
            max-height: 42vh;
            overflow: auto;
            touch-action: pan-y;
        }

        .mm-carousel {
            touch-action: pan-x;
        }

        #player-page-carousel-track > div:first-child,
        #player-page-vinyl,
        #player-page-single-lyric,
        #player-page-carousel .mm-player-wave {
            touch-action: pan-x;
        }

        #player-page-carousel {
            overflow-x: hidden !important;
            overflow-y: visible !important;
            height: clamp(380px, 58vh, 560px);
        }

        #player-page-carousel-track {
            height: 100%;
        }

        #player-page-carousel-track > div {
            height: 100%;
        }

        #player-page-section .mm-vinyl-float {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        #player-page-carousel-track > div:nth-child(2) .mm-glass {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: transparent !important;
            border: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        :root.light #player-page-carousel-track > div:nth-child(2) .mm-glass {
            background: transparent !important;
            border: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
        }

        #player-page-section .mm-lyrics {
            max-height: none;
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            scrollbar-width: none;
        }

        #player-page-section .mm-lyrics::-webkit-scrollbar {
            display: none;
        }

        .mm-lyric-line {
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
            opacity: 0.5;
            filter: blur(0.8px);
            transform: scale(0.95);
            cursor: pointer;
        }

        .mm-lyric-line:hover {
            opacity: 0.8;
            filter: blur(0px);
        }

        @keyframes mmRainbowFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .mm-lyric-line.is-active {
            opacity: 1;
            filter: blur(0);
            transform: scale(1.18);
            font-weight: 700;
            background: linear-gradient(120deg, #ff0080, #7928ca, #03dac6, #ff4d4d, #bb86fc, #7928ca);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback */
            animation: mmRainbowFlow 8s ease infinite;
        }

        /* Dynamic Single Lyric Style */
        #player-page-single-lyric {
            background: linear-gradient(120deg, #ff0080, #7928ca, #03dac6, #ff4d4d, #bb86fc, #7928ca);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
            animation: mmRainbowFlow 8s ease infinite;
            font-weight: 700;
        }

        #playlist-square-section > div:first-child,
        #hot-songs-section > div:first-child,
        #charts-section > div:first-child,
        #artists-section > div:first-child {
            display: none !important;
        }

        body.mm-route-player #player-progress-row {
            display: flex !important;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            gap: 0 !important;
        }

        body.mm-route-player #player-time-current,
        body.mm-route-player #player-time-total {
            display: none !important;
        }

        body.mm-route-player #player-progress {
            height: 3px;
            border-radius: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        body.mm-route-player #player-progress-fill {
            height: 3px;
            border-radius: 0;
        }

        body.mm-route-player #player-progress-knob {
            display: none !important;
        }

        body.mm-route-player.mm-seeking #player-progress-knob {
            display: block !important;
            width: 12px;
            height: 12px;
            opacity: 1 !important;
            background-color: #7928ca !important;
        }

        @media (max-width: 767px) {
            nav.md\:hidden {
                position: fixed !important;
                left: 0;
                right: 0;
                bottom: 0;
                height: calc(56px + env(safe-area-inset-bottom, 0px)) !important;
                padding-bottom: env(safe-area-inset-bottom, 0px);
            }

            #player-bar {
                position: fixed !important;
                left: 0;
                right: 0;
                bottom: calc(56px + env(safe-area-inset-bottom, 0px));
                margin-bottom: 0 !important;
            }

            :root {
                --mm-mobile-lyric-font-size: 18px;
                --mm-mobile-lyric-line-height: 1.7;
            }

            #player-page-section .mm-lyrics {
                font-size: var(--mm-mobile-lyric-font-size) !important;
                line-height: var(--mm-mobile-lyric-line-height) !important;
            }

            #player-page-single-lyric {
                font-size: var(--mm-mobile-lyric-font-size) !important;
                line-height: var(--mm-mobile-lyric-line-height) !important;
            }

            #auth-captcha-img {
                width: 9.5rem !important;
                height: 3.25rem !important;
                flex: 0 0 auto !important;
            }

            #auth-captcha-img svg {
                width: 100% !important;
                height: 100% !important;
            }

            .mm-lyric-line {
                filter: blur(0.4px);
                transform: scale(0.98);
            }

            .mm-lyric-line.is-active {
                transform: scale(1.08);
            }

            body.mm-player-page-open #app-scroll {
                overflow: hidden !important;
            }

            body.mm-player-page-open #player-page-section {
                position: fixed;
                inset: 0;
                margin: 0 !important;
                padding: 0 !important;
                z-index: 60;
            }

            body.mm-player-page-open header.md\:hidden {
                display: none !important;
            }

            body.mm-player-page-open #player-page-section .mm-psy-shell {
                height: 100vh;
                border-radius: 0 !important;
                border-left: none !important;
                border-right: none !important;
            }

            body.mm-player-page-open #player-page-section .mm-psy-shell > .relative {
                padding-bottom: calc(72px + env(safe-area-inset-bottom, 0px));
            }

            body.mm-player-page-open #player-page-section .mm-vinyl-float {
                padding-top: 44px !important;
                padding-bottom: 34px !important;
            }

            body.mm-player-page-open #player-page-section .mm-player-wave {
                margin-top: 20px;
            }

            body.mm-player-page-open #player-page-section #player-page-single-lyric {
                margin-top: 18px !important;
            }

            body.mm-player-page-open #player-page-section .mm-psy-bg,
            body.mm-player-page-open #player-page-section .mm-psy-vignette {
                clip-path: none !important;
                border-radius: 0 !important;
            }

            body.mm-player-page-open #player-bar {
                position: fixed !important;
                left: 0;
                right: 0;
                bottom: 0;
                margin-bottom: 0 !important;
                z-index: 70;
            }

            body.mm-player-page-open nav.md\:hidden {
                display: none !important;
            }

            body.mm-player-page-open #player-controls {
                max-width: none !important;
                width: 100% !important;
                padding-left: 14px;
                padding-right: 14px;
            }

            body.mm-player-page-open #player-progress-row {
                display: flex !important;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                width: 100%;
                gap: 0 !important;
            }

            body.mm-player-page-open #player-progress {
                height: 3px;
                border-radius: 0;
                padding-top: 0;
                padding-bottom: 0;
            }

            body.mm-player-page-open #player-progress-fill {
                height: 3px;
                border-radius: 0;
            }

            body.mm-player-page-open #player-progress-knob {
                display: none !important;
            }

            body.mm-player-page-open #player-time-current,
            body.mm-player-page-open #player-time-total {
                display: none !important;
            }

            body.mm-player-page-open.mm-seeking #player-progress-knob {
                display: block !important;
                width: 12px;
                height: 12px;
                opacity: 1 !important;
                background-color: #7928ca !important;
            }
        }

        /* Playing Icon Animation */
        .playing-icon {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 16px;
            width: 16px;
        }
        .playing-icon span {
            width: 3px;
            background-color: rgb(var(--color-primary, 255, 0, 128)); /* Fallback to pinkish */
            border-radius: 1px;
            animation: playing-bounce 1s infinite ease-in-out;
        }
        /* Use material-primary color variable if available, otherwise inherit or specific color */
        .playing-icon span {
            background-color: currentColor;
        }
        
        .playing-icon span:nth-child(1) { animation-delay: 0s; height: 40%; }
        .playing-icon span:nth-child(2) { animation-delay: 0.2s; height: 100%; }
        .playing-icon span:nth-child(3) { animation-delay: 0.4s; height: 60%; }
        
        @keyframes playing-bounce {
            0%, 100% { height: 30%; }
            50% { height: 100%; }
        }

        #sidebar-toggle-btn {
            position: fixed !important;
            top: 50% !important;
            left: 240px !important;
            transform: translate(-50%, -50%) !important;
            width: 18px !important;
            height: 72px !important;
            border-radius: 9999px !important;
            background: rgba(255, 255, 255, 0.06) !important;
            border: 1px solid rgba(255, 255, 255, 0.12) !important;
            backdrop-filter: blur(14px) !important;
            -webkit-backdrop-filter: blur(14px) !important;
            z-index: 60 !important;
        }

        :root.light #sidebar-toggle-btn {
            background: rgba(0, 0, 0, 0.04) !important;
            border: 1px solid rgba(0, 0, 0, 0.10) !important;
        }

        .mm-sidebar-collapsed #sidebar-toggle-btn {
            left: 0 !important;
            transform: translate(50%, -50%) !important;
        }

        #sidebar-toggle-btn-sidebar {
            display: none !important;
        }

        /* App Loader */
        #app-loader {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out;
        }
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(187, 134, 252, 0.3);
            border-radius: 50%;
            border-top-color: #bb86fc;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .home-radio-card {
            --mm-c1: rgba(124, 58, 237, 0.95);
            --mm-c2: rgba(236, 72, 153, 0.95);
            --mm-c3: rgba(99, 102, 241, 0.75);
            position: relative;
            overflow: hidden;
            border-radius: 18px;
            color: rgba(255, 255, 255, 0.96);
            background:
                linear-gradient(180deg, rgba(17, 24, 39, 0.72), rgba(17, 24, 39, 0.46));
            transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
            transform: translateZ(0);
            will-change: transform;
        }
        .home-radio-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
            border-color: rgba(255, 255, 255, 0.18);
        }
        .home-radio-card:active {
            transform: translateY(-1px) scale(0.985);
        }
        .home-radio-card::before {
            content: '';
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(closest-side at 25% 25%, var(--mm-c1), transparent 60%),
                radial-gradient(closest-side at 75% 30%, var(--mm-c2), transparent 62%),
                radial-gradient(closest-side at 50% 85%, var(--mm-c3), transparent 65%);
            opacity: 0.85;
            filter: blur(22px);
            transform: translate3d(0, 0, 0) scale(1.05);
            animation: mmRadioFloat 7s ease-in-out infinite;
        }
        .home-radio-card::after {
            content: '';
            position: absolute;
            inset: -60%;
            background:
                linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.0) 25%, rgba(255, 255, 255, 0.28) 40%, rgba(255, 255, 255, 0.0) 58%, transparent 100%),
                linear-gradient(120deg, transparent 0%, rgba(255, 255, 255, 0.0) 35%, rgba(255, 255, 255, 0.16) 48%, rgba(255, 255, 255, 0.0) 62%, transparent 100%);
            opacity: 0.85;
            transform: translate3d(-30%, 0, 0) rotate(0.001deg);
            animation: mmRadioLightFlow 3.8s linear infinite;
        }
        :root:not(.light) .home-radio-card-guess::after,
        :root:not(.light) .home-radio-card-daily::after {
            animation: none;
            opacity: 0;
        }
        @keyframes mmRadioFloat {
            0% { transform: translate3d(-2%, -1%, 0) scale(1.06); }
            50% { transform: translate3d(2%, 1.5%, 0) scale(1.02); }
            100% { transform: translate3d(-2%, -1%, 0) scale(1.06); }
        }
        @keyframes mmRadioLightFlow {
            0% { transform: translate3d(-45%, -6%, 0) rotate(0.001deg); }
            100% { transform: translate3d(45%, 6%, 0) rotate(0.001deg); }
        }
        @media (prefers-reduced-motion: reduce) {
            .home-radio-card::before,
            .home-radio-card::after {
                animation: none;
            }
            .home-radio-card {
                transition: none;
            }
        }
        .home-radio-card-inner {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 122px;
        }
        @media (min-width: 768px) {
            .home-radio-card-inner {
                min-height: 150px;
            }
        }
        .home-radio-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            width: max-content;
            padding: 6px 10px;
            border-radius: 9999px;
            background: rgba(0, 0, 0, 0.18);
            border: 1px solid rgba(255, 255, 255, 0.14);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: rgba(255, 255, 255, 0.92);
            font-size: 12px;
            line-height: 1;
        }
        .home-radio-title {
            color: inherit;
            letter-spacing: 0.2px;
        }
        .home-radio-sub {
            color: rgba(255, 255, 255, 0.78);
        }
        .home-radio-cta {
            width: 44px;
            height: 44px;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.14);
            border: 1px solid rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.25);
            transition: transform 180ms ease, background-color 180ms ease;
        }
        .home-radio-card:hover .home-radio-cta {
            transform: translateY(-1px) scale(1.03);
            background: rgba(255, 255, 255, 0.18);
        }
        :root.light .home-radio-card {
            box-shadow: 0 16px 40px rgba(124, 58, 237, 0.15);
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.4);
            color: #000;
        }
        :root.light .home-radio-card .home-radio-sub {
            color: rgba(0, 0, 0, 0.7);
        }
        :root.light .home-radio-card .home-radio-cta {
             background: rgba(0, 0, 0, 0.08);
             border-color: rgba(0, 0, 0, 0.1);
             color: #000;
        }
        :root.light .home-radio-card .home-radio-cta span {
             color: #000;
        }
        :root.light .home-radio-card:hover .home-radio-cta {
             background: rgba(0, 0, 0, 0.12);
        }
        :root.light .home-radio-visualizer span {
            background: #000;
        }

        :root.light #player-page-vinyl.mm-vinyl {
            box-shadow:
                0 18px 44px rgba(0,0,0,0.18),
                inset 0 0 0 1px rgba(0,0,0,0.10);
        }
        
        .mm-player-wave {
            width: min(420px, 78vw);
            height: 56px;
            margin-top: 18px;
            margin-bottom: 4px;
            opacity: 0.95;
            display: block;
            filter: drop-shadow(0 8px 14px rgba(0,0,0,0.35));
        }
        .home-radio-card-guess {
            --mm-c1: rgba(124, 58, 237, 0.95);
            --mm-c2: rgba(236, 72, 153, 0.9);
            --mm-c3: rgba(168, 85, 247, 0.75);
        }
        .home-radio-card-daily {
            --mm-c1: rgba(14, 165, 233, 0.95);
            --mm-c2: rgba(99, 102, 241, 0.9);
            --mm-c3: rgba(34, 211, 238, 0.75);
        }

        .home-radio-visualizer {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 28px;
            position: absolute;
            bottom: 0;
            right: 0;
            z-index: 5;
            opacity: 0.7;
            pointer-events: none;
        }
        .home-radio-visualizer span {
            width: 5px;
            background: #fff;
            border-radius: 99px;
            animation: mmEqualizer 1s ease-in-out infinite;
            transform-origin: bottom;
        }
        .home-radio-visualizer span:nth-child(1) { height: 40%; animation-duration: 0.8s; animation-delay: 0.1s; }
        .home-radio-visualizer span:nth-child(2) { height: 80%; animation-duration: 1.1s; animation-delay: 0.2s; }
        .home-radio-visualizer span:nth-child(3) { height: 50%; animation-duration: 1.3s; animation-delay: 0.0s; }
        .home-radio-visualizer span:nth-child(4) { height: 90%; animation-duration: 0.9s; animation-delay: 0.3s; }
        @keyframes mmEqualizer {
            0%, 100% { transform: scaleY(0.4); opacity: 0.8; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        /* Copyright Modal */
        #copyright-modal {
            position: fixed;
            inset: 0;
            z-index: 9990;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        #copyright-modal.open {
            display: flex;
        }
    </style>
</head>
<body class="bg-material-bg text-material-text h-screen flex flex-col md:flex-row overflow-hidden transition-colors duration-300">
    <div id="app-loader">
        <div class="loader-spinner"></div>
    </div>
    <script>
        (() => {
            const loader = document.getElementById('app-loader');
            if (!loader) return;
            const hide = () => {
                if (!document.getElementById('app-loader')) return;
                loader.style.opacity = '0';
                setTimeout(() => loader.remove(), 500);
            };
            window.addEventListener('load', () => setTimeout(hide, 800));
            setTimeout(hide, 2500);
        })();
    </script>

    <!-- Desktop Sidebar (Hidden on Mobile) -->
    <aside id="desktop-sidebar" class="hidden md:flex flex-col w-60 bg-material-surface h-full border-r border-material-border transition-colors duration-300 select-none">
        <div class="h-[60px] flex items-center px-5 gap-2 shrink-0 justify-between">
            <a id="brand-home-desktop" href="/" class="flex items-center gap-2 min-w-0">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center shadow-md shrink-0 overflow-hidden">
                    <svg width="32" height="32" viewBox="0 0 64 64" aria-hidden="true" class="block">
                        <defs>
                            <linearGradient id="mmLogoGrad" x1="0" y1="0" x2="1" y2="1">
                                <stop stop-color="#7B1FA2"></stop>
                                <stop offset="1" stop-color="#E040FB"></stop>
                            </linearGradient>
                        </defs>
                        <rect width="64" height="64" rx="16" fill="url(#mmLogoGrad)"></rect>
                        <path d="M16 48V20l16 12 16-12v28" stroke="white" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
                    </svg>
                </div>
                <h1 class="text-lg font-bold tracking-tight text-material-text truncate">魔力音乐</h1>
            </a>
            <button id="sidebar-toggle-btn-sidebar" class="w-8 h-8 rounded-full bg-material-text/5 hover:bg-material-text/10 flex items-center justify-center transition text-material-text-secondary hover:text-material-text shrink-0" type="button" title="隐藏侧边栏">
                <span class="material-icons text-[18px]">chevron_left</span>
            </button>
        </div>
        
        <!-- Scrollable Nav -->
        <nav class="flex-1 overflow-y-auto px-3 space-y-6 py-2 custom-scrollbar">
            <!-- Group: Online Music -->
            <div>
                <p class="px-3 text-xs text-material-text-secondary mb-2 font-medium">在线音乐</p>
                <div class="space-y-1">
                    <a id="nav-recommend" href="/" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group nav-active">
                        <span class="material-icons text-[20px]">recommend</span>
                        <span class="text-sm font-medium">推荐</span>
                    </a>
                    <a id="nav-playlist-square" href="/playlist-square" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">library_music</span>
                        <span class="text-sm font-medium">歌单</span>
                    </a>
                    <a id="nav-radio" href="/hot" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">local_fire_department</span>
                        <span class="text-sm font-medium">热歌</span>
                    </a>
                    <a id="nav-artists" href="/artists" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">person</span>
                        <span class="text-sm font-medium">歌手</span>
                    </a>
                </div>
            </div>

            <!-- Group: My Music -->
            <div>
                <p class="px-3 text-xs text-material-text-secondary mb-2 font-medium">我的音乐</p>
                <div class="space-y-1">
                    <a id="nav-liked" href="/favorites" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">favorite</span>
                        <span class="text-sm font-medium">我喜欢的</span>
                    </a>
                    <a id="nav-downloads" href="/downloads" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">download</span>
                        <span class="text-sm font-medium">下载记录</span>
                    </a>
                    <a id="nav-recent" href="/recent" class="flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group">
                        <span class="material-icons text-[20px]">history</span>
                        <span class="text-sm font-medium">最近播放</span>
                    </a>
                </div>
            </div>
        </nav>
        
        
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-material-bg transition-colors duration-300">
        
        <!-- Desktop Top Bar -->
        <header class="hidden md:flex items-center justify-between px-8 py-4 shrink-0 z-20">
            <div class="flex items-center gap-4">
                <button id="sidebar-toggle-btn" class="w-8 h-8 rounded-full bg-material-text/5 hover:bg-material-text/10 flex items-center justify-center transition text-material-text-secondary hover:text-material-text" type="button" title="隐藏侧边栏">
                    <span class="material-icons text-[18px]">chevron_left</span>
                </button>
                <!-- History Nav -->
                <div class="flex items-center gap-2 text-material-text-secondary">
                    <button id="history-back-btn" class="w-7 h-7 rounded-full bg-material-text/5 hover:bg-material-text/10 flex items-center justify-center transition" type="button">
                        <span class="material-icons text-sm">arrow_back_ios_new</span>
                    </button>
                    <button id="history-forward-btn" class="w-7 h-7 rounded-full bg-material-text/5 hover:bg-material-text/10 flex items-center justify-center transition" type="button">
                        <span class="material-icons text-sm">arrow_forward_ios</span>
                    </button>
                </div>
                <!-- Search Bar -->
                <div class="relative group">
                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-material-text-secondary text-lg group-focus-within:text-material-primary transition-colors">search</span>
                    <input id="search-input-desktop" type="text" placeholder="搜索在线音乐" autocomplete="off" class="bg-material-text/5 text-material-text text-sm rounded-full pl-10 pr-4 py-2 w-64 focus:outline-none focus:bg-material-text/10 transition-colors placeholder-material-text-secondary/70">
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <a id="user-center-trigger-desktop" href="/login" class="flex items-center gap-3 mr-2 cursor-pointer hover:bg-material-text/5 p-1 px-2 rounded-full transition-colors">
                     <div class="w-7 h-7 rounded-full bg-material-text/10 overflow-hidden flex items-center justify-center">
                         <img id="user-avatar-img" src="" alt="User" class="w-full h-full object-cover hidden">
                         <span id="user-avatar-fallback" class="material-icons text-material-text-secondary text-[18px]">person</span>
                     </div>
                     <span id="user-display-name" class="text-sm font-medium text-material-text hidden lg:block">登录 / 注册</span>
                </a>
                <div class="h-4 w-px bg-material-border"></div>
                <button id="theme-toggle-desktop" class="text-material-text-secondary hover:text-material-text transition p-2 rounded-full hover:bg-material-text/5" title="Toggle Theme">
                    <span class="material-icons">dark_mode</span>
                </button>
                <button id="copyright-btn" class="text-material-text-secondary hover:text-material-text transition p-2 rounded-full hover:bg-material-text/5" title="版权声明">
                    <span class="material-icons">info</span>
                </button>
            </div>
        </header>

        <!-- Tab Navigation (Desktop) -->
        <div class="hidden md:flex px-8 mb-4 gap-6 shrink-0 border-b border-material-border/50 pb-2">
            <a id="top-tab-recommend" href="/" class="text-lg font-bold text-material-text border-b-2 border-material-primary pb-2">推荐</a>
            <a id="top-tab-playlists" href="/playlists" class="text-lg font-medium text-material-text-secondary hover:text-material-text transition pb-2">歌单</a>
            <a id="top-tab-hot" href="/hot" class="text-lg font-medium text-material-text-secondary hover:text-material-text transition pb-2">热歌</a>
            <a id="top-tab-charts" href="/charts" class="text-lg font-medium text-material-text-secondary hover:text-material-text transition pb-2">榜单</a>
            <a id="top-tab-artists" href="/artists" class="text-lg font-medium text-material-text-secondary hover:text-material-text transition pb-2">歌手</a>
        </div>

        <header class="md:hidden sticky top-0 z-20 bg-material-surface shadow-md transition-colors duration-300">
            <div class="flex items-center gap-2 p-4">
                <div class="relative flex-1 group">
                    <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-material-text-secondary text-lg group-focus-within:text-material-primary transition-colors">search</span>
                    <input id="search-input-mobile" type="search" placeholder="搜索在线音乐" autocomplete="off" class="w-full bg-material-text/5 text-material-text text-sm rounded-full pl-10 pr-4 py-2 focus:outline-none focus:bg-material-text/10 transition-colors placeholder-material-text-secondary/70">
                </div>
                <button id="theme-toggle-mobile" class="text-material-text ripple p-2 rounded-full shrink-0">
                     <span class="material-icons">dark_mode</span>
                </button>
                <button id="copyright-btn-mobile" class="text-material-text ripple p-2 rounded-full shrink-0" title="版权声明" type="button">
                    <span class="material-icons">info</span>
                </button>
            </div>
            <div class="flex px-4 overflow-x-auto gap-6 hide-scrollbar pb-2">
                <a id="mobile-tab-recommend" href="/" class="text-material-text font-bold border-b-2 border-material-primary pb-1 shrink-0">推荐</a>
                <a id="mobile-tab-playlists" href="/playlists" class="text-material-text-secondary font-medium pb-1 shrink-0">歌单</a>
                <a id="mobile-tab-hot" href="/hot" class="text-material-text-secondary font-medium pb-1 shrink-0">热歌</a>
                <a id="mobile-tab-charts" href="/charts" class="text-material-text-secondary font-medium pb-1 shrink-0">榜单</a>
                <a id="mobile-tab-artists" href="/artists" class="text-material-text-secondary font-medium pb-1 shrink-0">歌手</a>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div id="app-scroll" class="flex-1 overflow-y-auto px-4 md:px-8 pb-32 md:pb-32 custom-scrollbar">
            <section id="search-results-section" class="hidden mt-4 mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h2 id="search-results-title" class="text-lg md:text-xl font-bold text-material-text">搜索结果</h2>
                    <button id="search-results-close" class="text-material-text-secondary hover:text-material-text transition p-2 rounded-full hover:bg-material-text/5">
                        <span class="material-icons text-xl">close</span>
                    </button>
                </div>
                <div id="search-results-list" class="bg-material-surface/50 border border-material-border/60 rounded-xl overflow-hidden divide-y divide-material-border/50"></div>
            </section>

            <section id="login-page-section" class="hidden mt-4 mb-8">
                <div class="space-y-4 max-w-md w-full mx-auto">
                    <div class="bg-material-surface/50 border border-material-border/60 rounded-xl p-4">
                        <div class="flex items-center justify-between gap-3 mb-3">
                            <div class="flex items-center gap-3 min-w-0">
                                <div class="w-10 h-10 rounded-full bg-material-text/10 flex items-center justify-center shrink-0 overflow-hidden">
                                    <img id="user-center-avatar-img" src="" alt="User" class="w-full h-full object-cover hidden">
                                    <span id="user-center-avatar-fallback" class="material-icons text-material-text-secondary">person</span>
                                </div>
                                <div class="min-w-0">
                                    <div id="user-center-name" class="text-sm font-medium text-material-text truncate">未登录</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button id="user-logout-btn" type="button" class="hidden text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition">退出登录</button>
                            </div>
                        </div>
                        <div id="auth-forms-wrapper" class="mt-2">
                            <div class="border border-material-border/60 rounded-xl p-4">
                                <div class="flex items-center justify-between gap-3">
                                    <div class="flex items-center gap-2 bg-material-text/5 rounded-full p-1">
                                        <button id="auth-mode-login" type="button" class="px-4 py-1.5 rounded-full text-xs font-medium bg-material-primary text-material-on-primary">登录</button>
                                        <button id="auth-mode-register" type="button" class="px-4 py-1.5 rounded-full text-xs font-medium text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition">注册</button>
                                    </div>
                                    <div id="auth-mode-hint" class="text-xs text-material-text-secondary truncate">使用已有账号登录</div>
                                </div>
                                <div class="mt-4 space-y-2">
                                    <input id="login-username" type="text" placeholder="用户名（3-20 字符）" class="w-full text-sm rounded-md px-3 py-2 bg-material-text/5 text-material-text placeholder-material-text-secondary/70 focus:outline-none focus:bg-material-text/10">
                                    <input id="login-password" type="password" placeholder="密码（至少 6 位）" class="w-full text-sm rounded-md px-3 py-2 bg-material-text/5 text-material-text placeholder-material-text-secondary/70 focus:outline-none focus:bg-material-text/10">
                                    <div class="mt-2">
                                        <input id="auth-captcha-id" type="hidden">
                                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                                            <div class="flex items-center gap-2">
                                                <div id="auth-captcha-img" class="h-10 w-28 shrink-0 rounded-md bg-material-text/5 border border-material-border/60 flex items-center justify-center overflow-hidden select-none"></div>
                                                <button id="auth-captcha-refresh" type="button" class="text-xs px-3 py-2 rounded-md bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition shrink-0">刷新</button>
                                            </div>
                                            <input id="auth-captcha-code" type="text" placeholder="验证码" class="w-full sm:flex-1 text-sm rounded-md px-3 py-2 bg-material-text/5 text-material-text placeholder-material-text-secondary/70 focus:outline-none focus:bg-material-text/10">
                                        </div>
                                    </div>
                                    <button id="login-submit" type="button" class="w-full text-xs px-3 py-2 rounded-full bg-material-primary text-material-on-primary hover:bg-material-primary/80 transition">登录</button>
                                    <div class="text-[11px] text-material-text-secondary leading-5">
                                        登录后可同步喜欢/下载/最近播放与歌单。
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="login-after-auth" class="hidden space-y-4">
                        <div class="bg-material-surface/50 border border-material-border/60 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-material-text/10 flex items-center justify-center shrink-0">
                                    <span class="material-icons text-material-text-secondary">person</span>
                                </div>
                                <div class="min-w-0">
                                    <div class="text-sm font-medium text-material-text truncate">我的</div>
                                    <div class="text-xs text-material-text-secondary truncate">快速入口</div>
                                </div>
                            </div>
                            <div class="mt-3 grid grid-cols-3 gap-2">
                                <a href="/favorites" class="text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition flex items-center justify-center">我喜欢的</a>
                                <a href="/downloads" class="text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition flex items-center justify-center">下载记录</a>
                                <a href="/recent" class="text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition flex items-center justify-center">最近播放</a>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <div id="recommend-page-section">
            <section class="mb-7 mt-2 grid grid-cols-2 md:grid-cols-2 gap-3 md:gap-4">
                <button id="home-card-guess" type="button" aria-label="猜你喜欢电台，点击即播" class="home-radio-card home-radio-card-guess text-left border border-material-border/60 px-4 py-4 md:px-5 md:py-5">
                    <div class="home-radio-card-inner">
                        <div class="flex items-start gap-3 relative z-10">
                            <div class="min-w-0 pr-12 md:pr-14">
                                <div class="home-radio-title text-base md:text-xl font-bold whitespace-nowrap">猜你喜欢</div>
                                <div class="mt-1 home-radio-sub text-[12px] md:text-sm line-clamp-2" id="home-card-guess-sub">加载中…</div>
                            </div>
                        </div>
                        <div id="home-card-guess-play" class="home-radio-cta absolute bottom-2 right-2 md:bottom-3 md:right-3 shrink-0" aria-hidden="true">
                            <span class="material-icons text-white text-[22px]">play_arrow</span>
                        </div>
                    </div>
                </button>
                <button id="home-card-daily" type="button" aria-label="每日推荐电台，点击即播" class="home-radio-card home-radio-card-daily text-left border border-material-border/60 px-4 py-4 md:px-5 md:py-5">
                    <div class="home-radio-card-inner">
                        <div class="flex items-start gap-3 relative z-10">
                            <div class="min-w-0 pr-12 md:pr-14">
                                <div class="home-radio-title text-base md:text-xl font-bold whitespace-nowrap">每日推荐</div>
                                <div class="mt-1 home-radio-sub text-[12px] md:text-sm line-clamp-2" id="home-card-daily-sub">加载中…</div>
                            </div>
                        </div>
                        <div id="home-card-daily-play" class="home-radio-cta absolute bottom-2 right-2 md:bottom-3 md:right-3 shrink-0" aria-hidden="true">
                            <span class="material-icons text-white text-[22px]">play_arrow</span>
                        </div>
                    </div>
                </button>
            </section>

            <section class="mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        推荐歌单 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                
                <div id="recommend-playlists-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
            </section>
             
             <section class="mt-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        最新音乐 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="recommend-newsongs-list" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2"></div>
             </section>
            </div>
             
            <section id="radio-recommend-section" class="mt-10 mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        精选电台 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="radio-recommend-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
             </section>

             <section id="playlist-square-section" class="mt-10 mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        歌单 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="playlist-square-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
             </section>

             <section id="hot-songs-section" class="mt-10 mb-8 hidden">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        热歌 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="hot-songs-list" class="bg-material-surface/50 border border-material-border/60 rounded-xl overflow-hidden divide-y divide-material-border/50"></div>
             </section>

             <section id="charts-section" class="mt-10 mb-8 hidden">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        榜单 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="charts-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 md:gap-6"></div>
             </section>

             <section id="artists-section" class="mt-10 mb-8 hidden">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        歌手 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="artists-initial-bar" class="flex flex-wrap gap-2 mb-4"></div>
                <div id="artists-hot-grid" class="grid grid-cols-6 gap-2 md:gap-3 mb-6 hidden"></div>
                <div id="artists-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-4"></div>
                <div class="mt-6 flex justify-center">
                    <button id="artists-load-more" type="button" class="text-sm px-5 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition hidden">加载更多</button>
                </div>
             </section>

             <section id="favorites-section" class="mt-10 mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        我喜欢的 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="favorites-list" class="bg-material-surface/50 border border-material-border/60 rounded-xl overflow-hidden divide-y divide-material-border/50"></div>
             </section>

             <section id="downloads-section" class="mt-10 mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        下载 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="downloads-list" class="bg-material-surface/50 border border-material-border/60 rounded-xl overflow-hidden divide-y divide-material-border/50"></div>
             </section>

            <section id="recent-section" class="mt-10 mb-8">
                <div class="flex justify-between items-end mb-4">
                    <h2 class="text-xl font-bold text-material-text flex items-center gap-1">
                        最近播放 <span class="material-icons text-lg">chevron_right</span>
                    </h2>
                </div>
                <div id="recent-list" class="bg-material-surface/50 border border-material-border/60 rounded-xl overflow-hidden divide-y divide-material-border/50"></div>
             </section>

             <section id="player-page-section" class="mt-6 mb-10">
                <div class="mm-psy-shell border border-material-border/60">
                    <div class="mm-psy-bg"></div>
                    <div class="mm-psy-vignette"></div>
                    <div class="relative z-10 p-4 md:p-7">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex items-center gap-2 min-w-0">
                                <div class="playing-icon text-material-primary">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <div class="min-w-0">
                                    <div class="text-xs text-material-text-secondary">正在播放</div>
                                    <div id="player-page-title" class="text-lg md:text-2xl font-bold text-material-text truncate">未播放</div>
                                    <div id="player-page-artist" class="text-sm md:text-base text-material-text-secondary truncate mt-1">—</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 shrink-0">
                                <button id="player-page-like-btn" type="button" class="w-10 h-10 rounded-full mm-glass text-material-text-secondary hover:text-material-text transition flex items-center justify-center" title="喜欢">
                                    <span class="material-icons">favorite_border</span>
                                </button>
                                <button id="player-page-download-btn" type="button" class="w-10 h-10 rounded-full mm-glass text-material-text-secondary hover:text-material-text transition flex items-center justify-center" title="下载">
                                    <span class="material-icons">download</span>
                                </button>
                            </div>
                        </div>

                        <div id="player-page-meta" class="mt-2 text-xs text-material-text-secondary truncate hidden"></div>

                        <div class="mt-6 w-full flex flex-col items-center">
                            <div id="player-page-carousel" class="mm-carousel w-full max-w-2xl overflow-hidden relative group">
                                <button id="player-page-prev-btn" class="absolute left-0 top-1/2 -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center rounded-full bg-black/10 hover:bg-black/30 text-material-text/50 hover:text-material-text transition backdrop-blur-sm" title="上一页">
                                    <span class="material-icons text-3xl">chevron_left</span>
                                </button>
                                <button id="player-page-next-btn" class="absolute right-0 top-1/2 -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center rounded-full bg-black/10 hover:bg-black/30 text-material-text/50 hover:text-material-text transition backdrop-blur-sm" title="下一页">
                                    <span class="material-icons text-3xl">chevron_right</span>
                                </button>
                                <div id="player-page-carousel-track" class="flex w-full transition-transform duration-300 ease-out">
                                    <div class="w-full shrink-0 flex flex-col items-center">
                                        <div class="mm-vinyl-float flex flex-col items-center">
                                            <div id="player-page-vinyl" class="mm-vinyl w-[210px] h-[210px] md:w-[320px] md:h-[320px]">
                                                <div class="mm-vinyl-inner">
                                                    <img id="player-page-cover" src="" alt="cover" class="w-full h-full object-cover hidden">
                                                    <div id="player-page-cover-fallback" class="w-full h-full flex items-center justify-center text-material-text-secondary">
                                                        <span class="material-icons text-5xl">album</span>
                                                    </div>
                                                </div>
                                                <div class="mm-vinyl-hole"></div>
                                            </div>
                                            
                                            <canvas id="player-wave-canvas" class="mm-player-wave"></canvas>

                                            <!-- Single line lyric display -->
                                            <div id="player-page-single-lyric" class="mt-6 md:mt-8 text-center text-3xl md:text-4xl font-bold min-h-[3rem] px-4 line-clamp-2 transition-opacity duration-300"></div>
                                        </div>
                                    </div>
                                    <div class="w-full shrink-0">
                                        <div class="mm-glass rounded-2xl p-4 h-full box-border">
                                            <div id="player-page-lyrics" class="mm-lyrics text-sm md:text-base text-material-text-secondary whitespace-pre-line leading-7 md:leading-8">暂无歌词</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center justify-center gap-2">
                                <button id="player-page-dot-0" type="button" class="w-2.5 h-2.5 rounded-full bg-material-primary opacity-100 transition" aria-label="播放页"></button>
                                <button id="player-page-dot-1" type="button" class="w-2.5 h-2.5 rounded-full bg-material-text/20 opacity-60 transition" aria-label="歌词页"></button>
                            </div>
                        </div>
                    </div>
                </div>
             </section>
        </div>

        <div id="player-bar" class="absolute bottom-0 md:bottom-0 left-0 right-0 mm-glass border-t border-material-border px-4 flex items-center justify-between z-30 mb-[56px] md:mb-0 transition-all duration-300 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] h-[72px] md:h-[88px]">
            <!-- Track Info (Left) -->
            <div class="flex items-center gap-4 flex-1 min-w-0">
                <div id="player-cover-trigger" class="relative group shrink-0">
                    <div class="w-12 h-12 md:w-14 md:h-14 rounded-md bg-material-text/10 shadow-sm overflow-hidden flex items-center justify-center">
                        <img id="player-cover" src="" class="w-full h-full object-cover hidden" alt="Mini Cover">
                        <span id="player-cover-fallback" class="material-icons text-material-text-secondary text-2xl">album</span>
                    </div>
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-md cursor-pointer">
                        <span id="player-cover-overlay-icon" class="material-icons text-white text-xl">expand_less</span>
                    </div>
                </div>
                <div class="overflow-hidden min-w-0 flex flex-col justify-center">
                    <h4 id="player-title" class="text-sm md:text-base font-medium text-material-text truncate cursor-pointer hover:underline">未播放</h4>
                    <p id="player-artist" class="text-xs md:text-sm text-material-text-secondary truncate hover:underline cursor-pointer">—</p>
                </div>
                <button id="player-like-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-primary hover:bg-material-text/5 transition hidden sm:flex shrink-0" type="button" title="喜欢">
                    <span class="material-icons text-xl">favorite_border</span>
                </button>
                <button id="player-download-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition hidden sm:flex shrink-0" title="下载">
                    <span class="material-icons text-xl">download</span>
                </button>
            </div>

            <!-- Player Controls (Center) -->
            <div id="player-controls" class="flex flex-col items-center justify-center flex-1 max-w-[40%] md:max-w-[35%] shrink-0 px-2">
                <div class="flex items-center justify-center gap-2 md:gap-6 mb-1">
                    <button id="player-shuffle-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition hidden md:flex" title="Shuffle" type="button">
                        <span class="material-icons text-xl">shuffle</span>
                    </button>
                    <button id="player-prev-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition" title="Previous" type="button">
                        <span class="material-icons text-2xl">skip_previous</span>
                    </button>
                    <button id="main-play-btn" class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-material-primary text-material-on-primary flex items-center justify-center hover:scale-105 hover:shadow-lg transition shadow-md ripple mx-2">
                        <span class="material-icons text-2xl md:text-3xl">play_arrow</span>
                    </button>
                    <button id="player-next-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition" title="Next" type="button">
                        <span class="material-icons text-2xl">skip_next</span>
                    </button>
                    <button id="player-repeat-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition hidden md:flex" title="Repeat" type="button">
                        <span class="material-icons text-xl">repeat</span>
                    </button>
                </div>
                <div id="player-progress-row" class="hidden w-full items-center gap-3 text-xs text-material-text-secondary">
                    <span id="player-time-current" class="hidden sm:block w-8 text-right font-mono">0:00</span>
                    <div id="player-progress" class="flex-1 h-1 bg-material-text/10 rounded-full cursor-pointer group relative py-1">
                        <div class="absolute top-1/2 -translate-y-1/2 left-0 w-full h-1 bg-transparent"></div> <!-- Hit area -->
                        <div id="player-progress-fill" class="absolute top-1/2 -translate-y-1/2 left-0 w-0 h-1 bg-material-primary rounded-full group-hover:bg-material-primary/80 transition-colors"></div>
                        <div id="player-progress-knob" class="absolute top-1/2 -translate-y-1/2 left-0 w-3 h-3 bg-material-primary rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity transform -translate-x-1.5"></div>
                    </div>
                    <span id="player-time-total" class="hidden sm:block w-8 font-mono">0:00</span>
                </div>
            </div>

            <!-- Volume/Extra (Right) -->
            <div class="flex items-center justify-end gap-2 md:gap-4 flex-1 min-w-0">
                <button id="player-add-to-playlist-btn" class="w-8 h-8 flex sm:hidden items-center justify-center rounded-full text-material-text-secondary hover:text-material-primary hover:bg-material-text/5 transition shrink-0" type="button" title="喜欢">
                    <span class="material-icons text-xl">favorite_border</span>
                </button>
                <button id="player-queue-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition" title="播放列表" type="button">
                    <span class="material-icons text-xl">queue_music</span>
                </button>
                <div class="hidden md:flex items-center gap-2 w-20 sm:w-24 lg:w-32 shrink-0 group">
                    <button id="player-volume-btn" class="w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text transition" type="button" title="静音/取消静音">
                        <span class="material-icons text-xl">volume_up</span>
                    </button>
                    <div id="player-volume-bar" class="flex-1 h-1 bg-material-text/10 rounded-full cursor-pointer relative py-1 select-none">
                        <div class="absolute top-1/2 -translate-y-1/2 left-0 w-full h-1 bg-transparent"></div>
                        <div id="player-volume-fill" class="absolute top-1/2 -translate-y-1/2 left-0 w-0 h-1 bg-material-text rounded-full group-hover:bg-material-primary transition-colors"></div>
                        <div id="player-volume-knob" class="absolute top-1/2 -translate-y-1/2 left-0 w-3 h-3 bg-white rounded-full shadow opacity-0 group-hover:opacity-100 transition-opacity transform -translate-x-1.5"></div>
                    </div>
                </div>
            </div>
        </div>

        <nav class="md:hidden absolute bottom-0 w-full bg-material-surface border-t border-material-border flex justify-around items-center h-[56px] z-40 transition-colors duration-300">
            <a id="mobile-nav-home" href="/" class="flex flex-col items-center justify-center text-material-primary w-full h-full ripple">
                <span class="material-icons text-2xl">home</span>
                <span class="text-[10px] mt-1">首页</span>
            </a>
            <a id="mobile-nav-playlists" href="/playlists" class="flex flex-col items-center justify-center text-material-text-secondary w-full h-full ripple">
                <span class="material-icons text-2xl">library_music</span>
                <span class="text-[10px] mt-1">歌单</span>
            </a>
            <a id="mobile-nav-hot" href="/hot" class="flex flex-col items-center justify-center text-material-text-secondary w-full h-full ripple">
                <span class="material-icons text-2xl">local_fire_department</span>
                <span class="text-[10px] mt-1">热歌</span>
            </a>
             <a id="mobile-nav-user" href="/login" class="flex flex-col items-center justify-center text-material-text-secondary w-full h-full ripple">
                <span class="material-icons text-2xl">person_outline</span>
                <span class="text-[10px] mt-1">我的</span>
            </a>
        </nav>

        <div id="queue-modal" class="hidden fixed inset-0 z-[90]">
            <div id="queue-modal-backdrop" class="absolute inset-0 bg-black/45 backdrop-blur-sm"></div>
            <div id="queue-modal-wrap" class="relative w-full h-full flex items-center justify-center p-4">
                <div class="w-full max-w-md md:max-w-lg mm-glass border border-material-border/60 rounded-2xl overflow-hidden shadow-2xl">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-material-border/50">
                        <div class="flex items-center gap-2">
                            <span class="material-icons text-material-primary">queue_music</span>
                            <div class="text-sm font-semibold text-material-text">播放列表</div>
                        </div>
                        <button id="queue-modal-close" type="button" class="w-9 h-9 rounded-full bg-material-text/5 hover:bg-material-text/10 text-material-text-secondary hover:text-material-text transition flex items-center justify-center" title="关闭">
                            <span class="material-icons text-xl">close</span>
                        </button>
                    </div>
                    <div id="queue-modal-list" class="max-h-[60vh] overflow-auto divide-y divide-material-border/40"></div>
                    <div id="queue-modal-empty" class="hidden px-4 py-6 text-sm text-material-text-secondary">播放列表为空</div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const audio = document.createElement('audio');
        audio.crossOrigin = 'anonymous';
        audio.preload = 'none';
        audio.playsInline = true;
        audio.setAttribute('playsinline', '');
        audio.setAttribute('webkit-playsinline', '');
        audio.style.position = 'fixed';
        audio.style.left = '-9999px';
        audio.style.top = '0';
        audio.style.width = '1px';
        audio.style.height = '1px';
        audio.style.opacity = '0';
        audio.style.pointerEvents = 'none';
        document.body.appendChild(audio);
        window.__mmAudio = audio;
        const isAndroidApp = !!(window.MagicMusicAndroid);
        const mmDiag = {
            logs: [],
            lastPlayRequestAt: 0,
            lastPlayContext: '',
            lastPlayCallStack: '',
            lastPauseCallStack: '',
            lastGestureAt: 0,
            lastPopupAt: 0,
            popupCount: 0,
        };
        function mmDiagPush(type, data) {
            if (!isAndroidApp) return;
            try {
                mmDiag.logs.push({ t: Date.now(), type: String(type || ''), data });
                if (mmDiag.logs.length > 60) mmDiag.logs.splice(0, mmDiag.logs.length - 60);
            } catch {}
        }
        (function () {
            const origPlay = audio.play ? audio.play.bind(audio) : null;
            const origPause = audio.pause ? audio.pause.bind(audio) : null;
            const captureStack = () => {
                try {
                    throw new Error('mm_stack');
                } catch (e) {
                    try { return String(e && e.stack ? e.stack : ''); } catch { return ''; }
                }
            };

            if (origPlay) {
                audio.play = function (...args) {
                    if (isAndroidApp) {
                        mmDiag.lastPlayCallStack = captureStack();
                        mmDiagPush('audio.play', { paused: !!audio.paused, src: (() => { try { return String(audio.currentSrc || audio.src || ''); } catch { return ''; } })() });
                    }
                    return origPlay(...args);
                };
            }
            if (origPause) {
                audio.pause = function (...args) {
                    if (isAndroidApp) {
                        mmDiag.lastPauseCallStack = captureStack();
                        const delta = mmDiag.lastPlayRequestAt ? (Date.now() - mmDiag.lastPlayRequestAt) : -1;
                        mmDiagPush('audio.pause', { deltaFromLastPlayRequestMs: delta, currentTime: (() => { try { return Number(audio.currentTime); } catch { return -1; } })() });
                        const shouldShow =
                            delta >= 0
                            && delta < 1300
                            && !audio.ended
                            && (() => { try { return Number.isFinite(audio.currentTime) ? audio.currentTime < 2 : true; } catch { return true; } })();
                        if (shouldShow) {
                            try { mmShowDiag(`pauseSoonAfterPlay:${delta}ms`); } catch {}
                        }
                    }
                    return origPause(...args);
                };
            }
        })();
        function mmDiagSnapshot() {
            const snap = {};
            try {
                snap.now = new Date().toISOString();
                snap.href = String(location.href || '');
                snap.visibility = String(document.visibilityState || '');
                snap.hasFocus = !!document.hasFocus();
            } catch {}
            try {
                snap.audio = {
                    src: (() => { try { return String(audio.src || ''); } catch { return ''; } })(),
                    currentSrc: (() => { try { return String(audio.currentSrc || ''); } catch { return ''; } })(),
                    paused: !!audio.paused,
                    ended: !!audio.ended,
                    readyState: (() => { try { return Number(audio.readyState); } catch { return -1; } })(),
                    networkState: (() => { try { return Number(audio.networkState); } catch { return -1; } })(),
                    currentTime: (() => { try { return Number(audio.currentTime); } catch { return -1; } })(),
                    duration: (() => { try { return Number(audio.duration); } catch { return -1; } })(),
                    muted: !!audio.muted,
                    volume: (() => { try { return Number(audio.volume); } catch { return -1; } })(),
                    playbackRate: (() => { try { return Number(audio.playbackRate); } catch { return -1; } })(),
                    preload: (() => { try { return String(audio.preload || ''); } catch { return ''; } })(),
                    crossOrigin: (() => { try { return String(audio.crossOrigin || ''); } catch { return ''; } })(),
                    errorCode: (() => { try { return audio.error && typeof audio.error.code === 'number' ? Number(audio.error.code) : 0; } catch { return 0; } })(),
                };
            } catch {}
            try {
                snap.lastPlayRequestAt = mmDiag.lastPlayRequestAt;
                snap.lastPlayContext = mmDiag.lastPlayContext;
                snap.lastGestureAgoMs = mmDiag.lastGestureAt ? (Date.now() - mmDiag.lastGestureAt) : -1;
            } catch {}
            return snap;
        }
        function mmEnsureDiagOverlay() {
            if (!isAndroidApp) return null;
            let overlay = document.getElementById('mm-diag-overlay');
            if (overlay) return overlay;
            overlay = document.createElement('div');
            overlay.id = 'mm-diag-overlay';
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.right = '0';
            overlay.style.bottom = '0';
            overlay.style.zIndex = '999999';
            overlay.style.background = 'rgba(0,0,0,0.72)';
            overlay.style.display = 'none';
            overlay.style.padding = '16px';
            const panel = document.createElement('div');
            panel.style.maxWidth = '960px';
            panel.style.margin = '0 auto';
            panel.style.height = '100%';
            panel.style.display = 'flex';
            panel.style.flexDirection = 'column';
            panel.style.background = 'rgba(18,18,18,0.95)';
            panel.style.border = '1px solid rgba(255,255,255,0.12)';
            panel.style.borderRadius = '14px';
            panel.style.overflow = 'hidden';
            const header = document.createElement('div');
            header.style.display = 'flex';
            header.style.alignItems = 'center';
            header.style.justifyContent = 'space-between';
            header.style.gap = '10px';
            header.style.padding = '12px 12px';
            header.style.borderBottom = '1px solid rgba(255,255,255,0.10)';
            const title = document.createElement('div');
            title.style.color = '#fff';
            title.style.fontSize = '14px';
            title.style.fontWeight = '700';
            title.textContent = '诊断信息（长按/全选复制）';
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.gap = '8px';
            const copyBtn = document.createElement('button');
            copyBtn.type = 'button';
            copyBtn.textContent = '复制';
            copyBtn.style.padding = '8px 10px';
            copyBtn.style.borderRadius = '10px';
            copyBtn.style.background = 'rgba(255,255,255,0.10)';
            copyBtn.style.color = '#fff';
            copyBtn.style.fontSize = '13px';
            copyBtn.style.border = '1px solid rgba(255,255,255,0.12)';
            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.textContent = '关闭';
            closeBtn.style.padding = '8px 10px';
            closeBtn.style.borderRadius = '10px';
            closeBtn.style.background = 'rgba(255,255,255,0.06)';
            closeBtn.style.color = '#fff';
            closeBtn.style.fontSize = '13px';
            closeBtn.style.border = '1px solid rgba(255,255,255,0.12)';
            actions.appendChild(copyBtn);
            actions.appendChild(closeBtn);
            header.appendChild(title);
            header.appendChild(actions);
            const ta = document.createElement('textarea');
            ta.id = 'mm-diag-textarea';
            ta.style.flex = '1 1 auto';
            ta.style.width = '100%';
            ta.style.padding = '12px';
            ta.style.border = '0';
            ta.style.outline = 'none';
            ta.style.resize = 'none';
            ta.style.background = 'transparent';
            ta.style.color = '#fff';
            ta.style.fontFamily = 'monospace';
            ta.style.fontSize = '12px';
            ta.style.lineHeight = '1.35';
            ta.style.whiteSpace = 'pre';
            copyBtn.addEventListener('click', async () => {
                const text = ta.value || '';
                let ok = false;
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(text);
                        ok = true;
                    }
                } catch {}
                try {
                    if (!ok) {
                        ta.focus();
                        ta.select();
                        ok = !!document.execCommand && document.execCommand('copy');
                    }
                } catch {}
                if (ok) mmAlert('已复制到剪贴板');
                else mmAlert('复制失败，请长按全选复制');
            });
            closeBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
            });
            panel.appendChild(header);
            panel.appendChild(ta);
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            return overlay;
        }
        function mmShowDiag(reason) {
            if (!isAndroidApp) return;
            const now = Date.now();
            if (now - mmDiag.lastPopupAt < 1200) return;
            mmDiag.lastPopupAt = now;
            mmDiag.popupCount += 1;
            const overlay = mmEnsureDiagOverlay();
            const ta = overlay ? overlay.querySelector('#mm-diag-textarea') : null;
            const snap = mmDiagSnapshot();
            const lines = [];
            lines.push(`reason=${String(reason || '')}`);
            lines.push(`popupCount=${mmDiag.popupCount}`);
            try { lines.push(`ua=${navigator.userAgent}`); } catch {}
            lines.push('');
            try { lines.push(`snapshot=${JSON.stringify(snap, null, 2)}`); } catch { lines.push(`snapshot=${String(snap)}`); }
            lines.push('');
            lines.push('lastPlayCallStack=');
            lines.push(mmDiag.lastPlayCallStack || '');
            lines.push('');
            lines.push('lastPauseCallStack=');
            lines.push(mmDiag.lastPauseCallStack || '');
            lines.push('');
            lines.push('logs=');
            for (const it of mmDiag.logs) {
                try {
                    const ts = new Date(it.t).toISOString();
                    lines.push(`[${ts}] ${it.type} ${typeof it.data === 'string' ? it.data : JSON.stringify(it.data)}`);
                } catch {
                    lines.push(String(it && it.type ? it.type : 'log'));
                }
            }
            const text = lines.join('\n');
            if (ta) {
                ta.value = text;
                overlay.style.display = 'block';
                try {
                    ta.focus();
                    ta.setSelectionRange(0, ta.value.length);
                } catch {}
                return;
            }
            alert(text);
        }
        let mmLastAudioErrorAt = 0;
        let mmLastAlertAt = 0;
        function mmAlert(text) {
            if (!isAndroidApp) return;
            const now = Date.now();
            if (now - mmLastAlertAt < 1200) return;
            mmLastAlertAt = now;
            alert(String(text || '发生错误'));
        }
        function mmDescribeError(err) {
            try {
                if (!err) return '';
                const name = typeof err.name === 'string' ? err.name : '';
                const msg = typeof err.message === 'string' ? err.message : '';
                const tail = msg || (typeof err === 'string' ? err : '');
                if (name && tail) return `${name}: ${tail}`;
                return name || tail || '';
            } catch {
                return '';
            }
        }
        async function mmPlay(context) {
            try {
                if (isAndroidApp) {
                    mmDiag.lastPlayRequestAt = Date.now();
                    mmDiag.lastPlayContext = String(context || '');
                    mmDiagPush('mmPlay', { context: mmDiag.lastPlayContext });
                }
                try {
                    if (playerPageVizCtx && playerPageVizCtx.state === 'suspended') {
                        await playerPageVizCtx.resume();
                    }
                } catch {}
                const p = audio.play();
                if (p && typeof p.then === 'function') await p;
            } catch (err) {
                const ctx = String(context || '').trim();
                const detail = mmDescribeError(err);
                const prefix = ctx ? `音频播放失败(${ctx})` : '音频播放失败';
                const src = (() => {
                    try { return String(audio.currentSrc || audio.src || ''); } catch { return ''; }
                })();
                const code = (() => {
                    try { return String(audio.error && typeof audio.error.code === 'number' ? audio.error.code : ''); } catch { return ''; }
                })();
                const rs = (() => {
                    try { return String(audio.readyState); } catch { return ''; }
                })();
                const ns = (() => {
                    try { return String(audio.networkState); } catch { return ''; }
                })();
                const extra = `src=${src || '-'} readyState=${rs || '-'} networkState=${ns || '-'} errorCode=${code || '-'}`;
                try {
                    if (isAndroidApp) {
                        mmDiagPush('mmPlayError', { context: ctx, detail: mmDescribeError(err), extra });
                        mmShowDiag(`mmPlayError:${ctx || '-'}`);
                    }
                } catch {}
                throw new Error(`${detail ? `${prefix}：${detail}` : prefix}\n${extra}`);
            }
        }
        audio.addEventListener('error', () => {
            if (!isAndroidApp) return;
            const now = Date.now();
            if (now - mmLastAudioErrorAt < 1500) return;
            mmLastAudioErrorAt = now;
            const err = audio.error;
            const code = err && typeof err.code === 'number' ? err.code : 0;
            alert(`音频加载失败(code=${code})`);
        });
        let audioUnlocked = false;
        let audioUnlocking = false;
        let audioUnlockEl = null;

        function mmBytesToBase64(bytes) {
            let bin = '';
            const chunk = 0x8000;
            for (let i = 0; i < bytes.length; i += chunk) {
                bin += String.fromCharCode.apply(null, bytes.subarray(i, i + chunk));
            }
            return btoa(bin);
        }

        function makeSilentWavDataUri() {
            const sampleRate = 8000;
            const numChannels = 1;
            const bitsPerSample = 8;
            const dataSize = 1;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            const writeStr = (offset, str) => {
                for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
            };

            writeStr(0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeStr(8, 'WAVE');
            writeStr(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true);
            view.setUint16(32, numChannels * (bitsPerSample / 8), true);
            view.setUint16(34, bitsPerSample, true);
            writeStr(36, 'data');
            view.setUint32(40, dataSize, true);
            view.setUint8(44, 128);

            const bytes = new Uint8Array(buffer);
            return `data:audio/wav;base64,${mmBytesToBase64(bytes)}`;
        }

        function unlockAudioPlayback() {
            if (!isAndroidApp) return;
            mmDiag.lastGestureAt = Date.now();

            if (audioUnlocked || audioUnlocking) return;
            audioUnlocking = true;
            try {
                if (!audioUnlockEl) {
                    audioUnlockEl = document.createElement('audio');
                    audioUnlockEl.preload = 'auto';
                    audioUnlockEl.playsInline = true;
                    audioUnlockEl.setAttribute('playsinline', '');
                    audioUnlockEl.setAttribute('webkit-playsinline', '');
                    audioUnlockEl.style.position = 'fixed';
                    audioUnlockEl.style.left = '-9999px';
                    audioUnlockEl.style.top = '0';
                    audioUnlockEl.style.width = '1px';
                    audioUnlockEl.style.height = '1px';
                    audioUnlockEl.style.opacity = '0';
                    audioUnlockEl.style.pointerEvents = 'none';
                    document.body.appendChild(audioUnlockEl);
                }
                audioUnlockEl.muted = true;
                audioUnlockEl.volume = 0;
                audioUnlockEl.src = makeSilentWavDataUri();
                try { audioUnlockEl.load(); } catch {}
                const p = audioUnlockEl.play();
                if (p && typeof p.then === 'function') {
                    p.then(() => {
                        try { audioUnlockEl.pause(); } catch {}
                        try { audioUnlockEl.currentTime = 0; } catch {}
                        audioUnlocked = true;
                    }).catch(() => {
                        audioUnlocked = false;
                    }).finally(() => {
                        audioUnlocking = false;
                    });
                    return;
                }
                audioUnlocked = true;
            } catch {
                audioUnlocked = false;
            } finally {
                if (!audioUnlocking) audioUnlocking = false;
            }
        }

        document.addEventListener('pointerdown', unlockAudioPlayback, { passive: true });
        document.addEventListener('touchend', unlockAudioPlayback, { passive: true });
        document.addEventListener('click', unlockAudioPlayback, { passive: true });

        const playBtn = document.getElementById('main-play-btn');
        const playerBar = document.getElementById('player-bar');
        const playerCover = document.getElementById('player-cover');
        const playerCoverFallback = document.getElementById('player-cover-fallback');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerDownloadBtn = document.getElementById('player-download-btn');
        const playerAddToPlaylistBtn = document.getElementById('player-add-to-playlist-btn');
        const playerQueueBtn = document.getElementById('player-queue-btn');
        const timeCurrent = document.getElementById('player-time-current');
        const timeTotal = document.getElementById('player-time-total');
        const progress = document.getElementById('player-progress');
        const progressFill = document.getElementById('player-progress-fill');
        const progressKnob = document.getElementById('player-progress-knob');

        const searchInputDesktop = document.getElementById('search-input-desktop');
        const searchInputMobile = document.getElementById('search-input-mobile');
        const searchResultsSection = document.getElementById('search-results-section');
        const searchResultsTitle = document.getElementById('search-results-title');
        const searchResultsList = document.getElementById('search-results-list');
        const searchResultsClose = document.getElementById('search-results-close');

        const themeToggleDesktop = document.getElementById('theme-toggle-desktop');
        const themeToggleMobile = document.getElementById('theme-toggle-mobile');
        const html = document.documentElement;

        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarToggleBtnSidebar = document.getElementById('sidebar-toggle-btn-sidebar');

        const brandHomeDesktop = document.getElementById('brand-home-desktop');
        const brandHomeMobile = document.getElementById('brand-home-mobile');
        const userCenterTriggerDesktop = document.getElementById('user-center-trigger-desktop');
        const loginPageSection = document.getElementById('login-page-section');
        const recommendPageSection = document.getElementById('recommend-page-section');
        const bottomNavUser = document.getElementById('mobile-nav-user');
        const bottomNavHome = document.getElementById('mobile-nav-home');
        const bottomNavPlaylists = document.getElementById('mobile-nav-playlists');
        const bottomNavHot = document.getElementById('mobile-nav-hot');

        const volumeBtn = document.getElementById('player-volume-btn');
        const volumeBar = document.getElementById('player-volume-bar');
        const volumeFill = document.getElementById('player-volume-fill');
        const volumeKnob = document.getElementById('player-volume-knob');

        const prevBtn = document.getElementById('player-prev-btn');
        const nextBtn = document.getElementById('player-next-btn');
        const repeatBtn = document.getElementById('player-repeat-btn');
        const shuffleBtn = document.getElementById('player-shuffle-btn');

        const playerPageSection = document.getElementById('player-page-section');
        const playerPageVinyl = document.getElementById('player-page-vinyl');
        const playerPageCover = document.getElementById('player-page-cover');
        const playerPageCoverFallback = document.getElementById('player-page-cover-fallback');
        const playerPageTitle = document.getElementById('player-page-title');
        const playerPageArtist = document.getElementById('player-page-artist');
        const playerPageMeta = document.getElementById('player-page-meta');
        const playerPageLikeBtn = document.getElementById('player-page-like-btn');
        const playerPageDownloadBtn = document.getElementById('player-page-download-btn');
        const playerPagePrev = document.getElementById('player-page-prev');
        const playerPagePlay = document.getElementById('player-page-play');
        const playerPageNext = document.getElementById('player-page-next');
        const playerPageRepeat = document.getElementById('player-page-repeat');
        const playerPageShuffle = document.getElementById('player-page-shuffle');
        const playerPageTimeCurrent = document.getElementById('player-page-time-current');
        const playerPageTimeTotal = document.getElementById('player-page-time-total');
        const playerPageProgress = document.getElementById('player-page-progress');
        const playerPageProgressFill = document.getElementById('player-page-progress-fill');
        const playerPageProgressKnob = document.getElementById('player-page-progress-knob');
        const playerPageVolume = document.getElementById('player-page-volume');
        const playerPageLyrics = document.getElementById('player-page-lyrics');
        const playerPageCarousel = document.getElementById('player-page-carousel');
        const playerPageCarouselTrack = document.getElementById('player-page-carousel-track');
        const playerPageDot0 = document.getElementById('player-page-dot-0');
        const playerPageDot1 = document.getElementById('player-page-dot-1');
        const playerPageSingleLyric = document.getElementById('player-page-single-lyric');
        const playerPageWaveCanvas = document.getElementById('player-wave-canvas');

        const queueModal = document.getElementById('queue-modal');
        const queueModalBackdrop = document.getElementById('queue-modal-backdrop');
        const queueModalClose = document.getElementById('queue-modal-close');
        const queueModalWrap = document.getElementById('queue-modal-wrap');
        const queueModalList = document.getElementById('queue-modal-list');
        const queueModalEmpty = document.getElementById('queue-modal-empty');
        const playlistSelectModal = document.getElementById('playlist-select-modal');
        const playlistSelectBackdrop = document.getElementById('playlist-select-backdrop');
        const playlistSelectClose = document.getElementById('playlist-select-close');
        const playlistSelectList = document.getElementById('playlist-select-list');
        const playlistSelectEmpty = document.getElementById('playlist-select-empty');
        const playlistSelectCreateName = document.getElementById('playlist-select-create-name');
        const playlistSelectCreateBtn = document.getElementById('playlist-select-create-btn');

        const createdPlaylistsList = document.getElementById('created-playlists-list');
        const userCreatedPlaylistsList = document.getElementById('user-created-playlists-list');
        const createPlaylistBtn = document.getElementById('create-playlist-btn');
        const userCreatePlaylistBtn = document.getElementById('user-create-playlist-btn');
        const userAddCurrentToPlaylistBtn = document.getElementById('user-add-current-to-playlist-btn');

        const topTabRecommend = document.getElementById('top-tab-recommend');
        const topTabPlaylists = document.getElementById('top-tab-playlists');
        const topTabHot = document.getElementById('top-tab-hot');
        const topTabCharts = document.getElementById('top-tab-charts');
        const topTabArtists = document.getElementById('top-tab-artists');
        const userPlaylistsSummary = document.getElementById('user-playlists-summary');
        const sidebarCreatePlaylistForm = document.getElementById('sidebar-create-playlist-form');
        const sidebarPlaylistNameInput = document.getElementById('sidebar-playlist-name');
        const sidebarPlaylistCreateConfirm = document.getElementById('sidebar-playlist-create-confirm');
        const sidebarPlaylistCreateCancel = document.getElementById('sidebar-playlist-create-cancel');
        const userCreatePlaylistForm = document.getElementById('user-create-playlist-form');
        const userPlaylistNameInput = document.getElementById('user-playlist-name');
        const userPlaylistCreateConfirm = document.getElementById('user-playlist-create-confirm');
        const userPlaylistCreateCancel = document.getElementById('user-playlist-create-cancel');

        const navRecommend = document.getElementById('nav-recommend');
        const navRadio = document.getElementById('nav-radio');
        const navPlaylistSquare = document.getElementById('nav-playlist-square');
        const navArtists = document.getElementById('nav-artists');
        const navLiked = document.getElementById('nav-liked');
        const navDownloads = document.getElementById('nav-downloads');
        const navRecent = document.getElementById('nav-recent');

        const mobileTabRecommend = document.getElementById('mobile-tab-recommend');
        const mobileTabPlaylists = document.getElementById('mobile-tab-playlists');
        const mobileTabHot = document.getElementById('mobile-tab-hot');
        const mobileTabCharts = document.getElementById('mobile-tab-charts');
        const mobileTabArtists = document.getElementById('mobile-tab-artists');

        const playerLikeBtn = document.getElementById('player-like-btn');

        const userDisplayName = document.getElementById('user-display-name');
        const userAvatarImg = document.getElementById('user-avatar-img');
        const userAvatarFallback = document.getElementById('user-avatar-fallback');
        const userCenterName = document.getElementById('user-center-name');
        const userCenterAvatarImg = document.getElementById('user-center-avatar-img');
        const userCenterAvatarFallback = document.getElementById('user-center-avatar-fallback');
        const userLogoutBtn = document.getElementById('user-logout-btn');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const authCaptchaIdInput = document.getElementById('auth-captcha-id');
        const authCaptchaCodeInput = document.getElementById('auth-captcha-code');
        const authCaptchaImg = document.getElementById('auth-captcha-img');
        const authCaptchaRefreshBtn = document.getElementById('auth-captcha-refresh');
        const loginSubmitBtn = document.getElementById('login-submit');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerSubmitBtn = document.getElementById('register-submit');
        const authModeLoginBtn = document.getElementById('auth-mode-login');
        const authModeRegisterBtn = document.getElementById('auth-mode-register');
        const authModeHint = document.getElementById('auth-mode-hint');

        let currentTrack = null;
        let playQueue = [];
        let queueIndex = -1;
        let defaultTrackPreloaded = false;

        const PLAY_MODE_KEY = 'magicMusic_playMode_v1';
        const SHUFFLE_KEY = 'magicMusic_shuffle_v1';
        const LIKED_KEY = 'magicMusic_liked_v1';
        const DOWNLOADS_KEY = 'magicMusic_downloads_v1';
        const RECENT_KEY = 'magicMusic_recent_v1';
        const DEFAULT_PLAYLIST_NAME = '我喜欢';
        let playMode = 'order';
        let isShuffle = false;
        let likedTracks = [];
        let downloadedTracks = [];
        let recentTracks = [];

        let currentUser = null;
        let defaultServerPlaylistId = '';
        let authMode = 'login';
        let playlistEditing = null;
        let playlistEditingName = '';
        let playlistDeleting = null;

        function platformLabel(platform) {
            const p = platform ? String(platform) : '';
            if (!p) return '';
            if (p === 'kugou') return '酷狗';
            if (p === 'netease') return '网易云';
            if (p === 'local') return '本地库';
            if (p === 'spotify') return 'Spotify';
            return p;
        }

        function formatTime(sec) {
            const s = Math.max(0, Math.floor(sec || 0));
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${m}:${String(r).padStart(2, '0')}`;
        }

        function loadPlayerSettings() {
            const rawMode = localStorage.getItem(PLAY_MODE_KEY);
            if (rawMode === 'order' || rawMode === 'repeat_all' || rawMode === 'repeat_one') playMode = rawMode;
            isShuffle = localStorage.getItem(SHUFFLE_KEY) === '1';
            updatePlayModeUI();
        }

        function setButtonActive(btn, active) {
            if (!btn) return;
            if (active) {
                btn.classList.add('text-material-primary');
                btn.classList.remove('text-material-text-secondary');
            } else {
                btn.classList.remove('text-material-primary');
                btn.classList.add('text-material-text-secondary');
            }
        }

        function updatePlayModeUI() {
            if (repeatBtn) {
                const icon = repeatBtn.querySelector('.material-icons');
                if (icon) icon.innerText = playMode === 'repeat_one' ? 'repeat_one' : 'repeat';
                setButtonActive(repeatBtn, playMode !== 'order');
            }
            setButtonActive(shuffleBtn, isShuffle);
        }

        function cycleRepeatMode() {
            if (playMode === 'order') playMode = 'repeat_all';
            else if (playMode === 'repeat_all') playMode = 'repeat_one';
            else playMode = 'order';
            localStorage.setItem(PLAY_MODE_KEY, playMode);
            updatePlayModeUI();
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            localStorage.setItem(SHUFFLE_KEY, isShuffle ? '1' : '0');
            updatePlayModeUI();
        }

        function setQueue(list, startIndex, queueKey = '') {
            playQueue = Array.isArray(list) ? list.filter(Boolean) : [];
            const idx = Number(startIndex);
            queueIndex = Number.isFinite(idx) ? Math.max(-1, Math.min(playQueue.length - 1, idx)) : -1;
            activeQueueKey = queueKey ? String(queueKey) : '';
        }

        function ensureQueueIndexForTrack(track) {
            if (!track || !Array.isArray(playQueue) || playQueue.length === 0) return;
            const idx = playQueue.findIndex((t) => t && t.platform === track.platform && String(t.id) === String(track.id));
            if (idx >= 0) queueIndex = idx;
        }

        function pickNextIndex(delta, fromEndEvent = false) {
            const len = playQueue.length;
            if (!len) return -1;
            if (playMode === 'repeat_one' && fromEndEvent) return queueIndex >= 0 ? queueIndex : 0;
            if (isShuffle) {
                if (len === 1) return 0;
                const base = queueIndex >= 0 ? queueIndex : 0;
                let tries = 0;
                while (tries < 8) {
                    const next = Math.floor(Math.random() * len);
                    if (next !== base) return next;
                    tries += 1;
                }
                return (base + 1) % len;
            }
            const cur = queueIndex >= 0 ? queueIndex : 0;
            const next = cur + delta;
            if (next < 0) return playMode === 'repeat_all' ? len - 1 : (fromEndEvent ? -1 : 0);
            if (next >= len) return playMode === 'repeat_all' ? 0 : (fromEndEvent ? -1 : len - 1);
            return next;
        }

        async function playByIndex(idx) {
            const len = playQueue.length;
            if (!len) return;
            const next = Math.max(0, Math.min(len - 1, idx));
            queueIndex = next;
            const track = playQueue[next];
            if (!track) return;
            try {
                await playTrack(track);
            } catch (err) {
                const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                alert(`播放失败：${msg}`);
            }
        }

        async function skip(delta, fromEndEvent = false) {
            if (!playQueue.length) {
                if (currentTrack) {
                    try {
                        await playTrack(currentTrack);
                    } catch {}
                }
                return;
            }
            const next = pickNextIndex(delta, fromEndEvent);
            if (next < 0) {
                setPlayIcon(false);
                return;
            }
            if (next === queueIndex && playMode === 'repeat_one' && fromEndEvent) {
                audio.currentTime = 0;
                try {
                    await mmPlay('单曲循环');
                } catch (err) {
                    mmAlert(err instanceof Error ? err.message : '音频播放失败');
                }
                return;
            }
            await playByIndex(next);
        }

        function proxify(url) {
            if (!url) return '';
            const fixed = String(url).replace(/\{size\}/g, '400');
            try {
                if (fixed.startsWith('/')) return fixed;
                const u = new URL(fixed, window.location.href);
                if (u.origin === window.location.origin) return u.pathname + u.search + u.hash;
                if (u.protocol === 'http:' || u.protocol === 'https:') return `/proxy?url=${encodeURIComponent(u.toString())}`;
            } catch {}
            return fixed;
        }

        function toProxyMediaUrl(rawUrl) {
            if (!rawUrl) return '';
            if (rawUrl.startsWith('/proxy?')) return rawUrl;
            return proxify(rawUrl);
        }

        function toProxyDownloadUrl(rawUrl, filename) {
            if (!rawUrl) return '';
            const name = (filename || '').trim() || 'music';
            if (rawUrl.startsWith('/proxy?')) {
                return `${rawUrl}${rawUrl.includes('?') ? '&' : '?'}download=1&filename=${encodeURIComponent(name)}`;
            }
            try {
                const u = new URL(rawUrl);
                if (u.protocol === 'http:' || u.protocol === 'https:') {
                    return `/proxy?download=1&filename=${encodeURIComponent(name)}&url=${encodeURIComponent(u.toString())}`;
                }
            } catch {}
            return rawUrl;
        }

        function setPlayIcon(isPlaying) {
            if (!playBtn) return;
            const icon = playBtn.querySelector('.material-icons');
            if (icon) icon.innerText = isPlaying ? 'pause' : 'play_arrow';
        }

        function setInlinePlayButtonIcon(btn, isPlaying) {
            if (!btn) return;
            const icon = btn.querySelector('.material-icons');
            if (icon) icon.innerText = isPlaying ? 'pause' : 'play_arrow';
        }

        let activeQueueKey = '';

        function updateInlinePlayButtonsUI() {
            const curKey = currentTrack ? trackKey(currentTrack) : '';
            const playing = !!(audio.src && !audio.paused);
            const btns = document.querySelectorAll('[data-mm-play-btn="1"]');
            btns.forEach((btn) => {
                const qk = btn.getAttribute('data-queue-key') || '';
                const k = btn.getAttribute('data-track-key') || '';
                if (qk) {
                    setInlinePlayButtonIcon(btn, !!(playing && activeQueueKey && qk === activeQueueKey));
                    return;
                }
                setInlinePlayButtonIcon(btn, !!(playing && curKey && k && k === curKey));
            });
        }

        function setupTrackPlayButton(btn, track, queueList, queueIdx, queueKey = '') {
            if (!btn) return;
            btn.setAttribute('data-mm-play-btn', '1');
            btn.setAttribute('data-track-key', trackKey(track) || '');
            if (queueKey) btn.setAttribute('data-queue-key', String(queueKey));
            setInlinePlayButtonIcon(btn, !!(currentTrack && trackKey(track) === trackKey(currentTrack) && audio.src && !audio.paused));

            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const same = !!(currentTrack && trackKey(track) === trackKey(currentTrack));
                if (same && audio.src) {
                    if (queueKey) activeQueueKey = String(queueKey);
                    try {
                        if (audio.paused) await mmPlay('列表按钮');
                        else audio.pause();
                    } catch (err) {
                        mmAlert(err instanceof Error ? err.message : '音频播放失败');
                    }
                    updateInlinePlayButtonsUI();
                    return;
                }

                setQueue(queueList, queueIdx, queueKey);
                try {
                    await playTrack(track);
                } catch (err) {
                    const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                    alert(`播放失败：${msg}`);
                } finally {
                    updateInlinePlayButtonsUI();
                }
            });
        }

        let lastProgressTimeText = '';
        let lastProgressTotalText = '';
        let lastProgressRatio = -1;
        let lastPlayerPageTimeText = '';
        let lastPlayerPageTotalText = '';
        let lastPlayerPageRatio = -1;
        let lastLyricsSyncAt = 0;
        let lastUpdateUI = 0;
        let seekDragging = false;
        let seekDragRatio = 0;
        let seekDragWasPlaying = false;

        function updateProgressUI() {
            if (Date.now() - lastUpdateUI < 33) return;
            lastUpdateUI = Date.now();

            const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
            let cur = Number.isFinite(audio.currentTime) ? audio.currentTime : 0;
            if (seekDragging && dur > 0) cur = Math.min(dur, Math.max(0, seekDragRatio * dur));
            const ratio = dur > 0 ? Math.min(1, Math.max(0, cur / dur)) : 0;

            const curText = formatTime(cur);
            const durText = formatTime(dur);
            if (timeCurrent && curText !== lastProgressTimeText) {
                timeCurrent.textContent = curText;
                lastProgressTimeText = curText;
            }
            if (timeTotal && durText !== lastProgressTotalText) {
                timeTotal.textContent = durText;
                lastProgressTotalText = durText;
            }
            if (progressFill && progressKnob && progress) {
                if (ratio !== lastProgressRatio) {
                    const pct = `${ratio * 100}%`;
                    progressFill.style.width = pct;
                    progressKnob.style.left = pct;
                    lastProgressRatio = ratio;
                }
            }

            const isPlayerVisible = !!(playerPageSection && !playerPageSection.classList.contains('hidden'));
            if (isPlayerVisible) {
                if (playerPageTimeCurrent && curText !== lastPlayerPageTimeText) {
                    playerPageTimeCurrent.textContent = curText;
                    lastPlayerPageTimeText = curText;
                }
                if (playerPageTimeTotal && durText !== lastPlayerPageTotalText) {
                    playerPageTimeTotal.textContent = durText;
                    lastPlayerPageTotalText = durText;
                }
                if (playerPageProgressFill && playerPageProgressKnob) {
                    if (ratio !== lastPlayerPageRatio) {
                        const pct = `${ratio * 100}%`;
                        playerPageProgressFill.style.width = pct;
                        playerPageProgressKnob.style.left = pct;
                        lastPlayerPageRatio = ratio;
                    }
                }
                const now = Date.now();
                if (now - lastLyricsSyncAt >= 120) {
                    lastLyricsSyncAt = now;
                    updatePlayerPageLyricsSync();
                }
            }
        }

        const VOLUME_KEY = 'magicMusic_volume_v1';
        let lastNonZeroVolume = 0.7;

        function clamp01(n) {
            const x = Number(n);
            if (!Number.isFinite(x)) return 0;
            return Math.min(1, Math.max(0, x));
        }

        function setVolume(v, persist = true) {
            const next = clamp01(v);
            audio.volume = next;
            if (next > 0) lastNonZeroVolume = next;
            if (persist) localStorage.setItem(VOLUME_KEY, String(next));
            updateVolumeUI();
        }

        function updateVolumeUI() {
            if (!volumeFill || !volumeKnob || !volumeBtn) return;
            const v = clamp01(audio.volume);
            const pct = v * 100;
            volumeFill.style.width = `${pct}%`;
            volumeKnob.style.left = `${pct}%`;
            const icon = volumeBtn.querySelector('.material-icons');
            if (icon) {
                if (v === 0) icon.innerText = 'volume_off';
                else if (v < 0.5) icon.innerText = 'volume_down';
                else icon.innerText = 'volume_up';
            }
        }

        function initVolume() {
            const raw = localStorage.getItem(VOLUME_KEY);
            const parsed = raw == null ? 0.7 : Number(raw);
            setVolume(Number.isFinite(parsed) ? parsed : 0.7, false);
            if (playerPageVolume) playerPageVolume.value = String(clamp01(audio.volume));

            if (volumeBtn) {
                volumeBtn.addEventListener('click', () => {
                    const v = clamp01(audio.volume);
                    if (v === 0) setVolume(lastNonZeroVolume || 0.7);
                    else setVolume(0);
                });
            }

            if (volumeBar) {
                const setFromPointer = (e) => {
                    const rect = volumeBar.getBoundingClientRect();
                    const x = Math.min(rect.width, Math.max(0, e.clientX - rect.left));
                    setVolume(rect.width ? x / rect.width : 0);
                    if (playerPageVolume) playerPageVolume.value = String(clamp01(audio.volume));
                };

                volumeBar.addEventListener('click', (e) => {
                    setFromPointer(e);
                });

                volumeBar.addEventListener('pointerdown', (e) => {
                    if (e.pointerType === 'mouse' && e.button !== 0) return;
                    volumeBar.setPointerCapture(e.pointerId);
                    setFromPointer(e);
                });

                volumeBar.addEventListener('pointermove', (e) => {
                    if (!volumeBar.hasPointerCapture(e.pointerId)) return;
                    setFromPointer(e);
                });

                volumeBar.addEventListener('pointerup', (e) => {
                    if (!volumeBar.hasPointerCapture(e.pointerId)) return;
                    volumeBar.releasePointerCapture(e.pointerId);
                });

                volumeBar.addEventListener('pointercancel', (e) => {
                    if (!volumeBar.hasPointerCapture(e.pointerId)) return;
                    volumeBar.releasePointerCapture(e.pointerId);
                });
            }
        }

        async function apiJson(url) {
            const r = await fetch(url, { credentials: 'same-origin' });
            const data = await r.json().catch(() => null);
            if (!r.ok || !data || data.ok === false) throw new Error('api error');
            return data;
        }

        async function apiRequest(path, options) {
            const opts = options || {};
            const r = await fetch(path, { credentials: 'same-origin', ...opts });
            const data = await r.json().catch(() => null);
            if (!r.ok) {
                const msg = data && (data.error || data.message) ? String(data.error || data.message) : 'api error';
                throw new Error(msg);
            }
            return data;
        }

        function updateUserUI() {
            const user = currentUser;
            const isAuthed = !!(user && user.id);
            if (userDisplayName) userDisplayName.innerText = isAuthed ? (user.username || '已登录') : '登录 / 注册';
            if (userCenterName) userCenterName.innerText = isAuthed ? (user.username || '已登录') : '未登录';
            if (userLogoutBtn) userLogoutBtn.classList.toggle('hidden', !isAuthed);
            const authWrapper = document.getElementById('auth-forms-wrapper');
            if (authWrapper) authWrapper.classList.toggle('hidden', isAuthed);
            const loginAfterAuth = document.getElementById('login-after-auth');
            if (loginAfterAuth) loginAfterAuth.classList.toggle('hidden', !isAuthed);
        }

        async function refreshCurrentUser() {
            try {
                const data = await apiRequest('/api/auth/me', { method: 'GET' });
                currentUser = data && data.user ? data.user : null;
            } catch {
                currentUser = null;
            }
            updateUserUI();
            await syncUserDataFromServer();
        }

        async function syncUserDataFromServer() {
            if (!currentUser || !currentUser.id) {
                loadLocalLists();
                renderMyLists();
                ensureDefaultLocalPlaylist();
                renderCreatedPlaylists();
                return;
            }
            try {
                const [likes, downloads, recents] = await Promise.all([
                    apiRequest('/api/user/likes', { method: 'GET' }).catch(() => ({ likes: [] })),
                    apiRequest('/api/user/downloads', { method: 'GET' }).catch(() => ({ downloads: [] })),
                    apiRequest('/api/user/recents', { method: 'GET' }).catch(() => ({ recents: [] })),
                ]);
                likedTracks = Array.isArray(likes.likes) ? likes.likes.map(sanitizeTrack).filter(Boolean) : [];
                downloadedTracks = Array.isArray(downloads.downloads) ? downloads.downloads.map(sanitizeTrack).filter(Boolean) : [];
                recentTracks = Array.isArray(recents.recents) ? recents.recents.map(sanitizeTrack).filter(Boolean) : [];
            } catch {
                likedTracks = [];
                downloadedTracks = [];
                recentTracks = [];
            }
            renderMyLists();
            await ensureDefaultServerPlaylistId().catch(() => {});
            renderCreatedPlaylists();
        }

        function trackKey(track) {
            if (!track) return '';
            return `${track.platform || ''}:${String(track.id || '')}`;
        }

        function sanitizeTrack(track) {
            if (!track) return null;
            return normalizeTrack({
                platform: track.platform || '',
                id: track.id || '',
                name: track.name || '',
                artist: track.artist || '',
                album: track.album || '',
                coverUrl: track.coverUrl || '',
                album_audio_id: track.album_audio_id || '',
            });
        }

        function loadLocalLists() {
            const parseArr = (key) => {
                const raw = localStorage.getItem(key);
                if (!raw) return [];
                try {
                    const list = JSON.parse(raw);
                    return Array.isArray(list) ? list.map(sanitizeTrack).filter(Boolean) : [];
                } catch {
                    return [];
                }
            };
            likedTracks = parseArr(LIKED_KEY);
            downloadedTracks = parseArr(DOWNLOADS_KEY);
            recentTracks = parseArr(RECENT_KEY);
        }

        function saveLocalList(key, list) {
            localStorage.setItem(key, JSON.stringify(Array.isArray(list) ? list : []));
        }

        function isTrackLiked(track) {
            const k = trackKey(track);
            if (!k) return false;
            return likedTracks.some((t) => trackKey(t) === k);
        }

        function updateLikeButtonUI() {
            const btns = [playerLikeBtn, playerAddToPlaylistBtn].filter(Boolean);
            if (!btns.length) return;
            const liked = !!currentTrack && isTrackLiked(currentTrack);
            for (const btn of btns) {
                const icon = btn.querySelector('.material-icons');
                if (!icon) continue;
                icon.innerText = liked ? 'favorite' : 'favorite_border';
                icon.style.color = liked ? 'red' : '';
                btn.title = liked ? '已喜欢' : '喜欢';
            }
        }

        function updatePlayerPageLikeUI() {
            if (!playerPageLikeBtn) return;
            const icon = playerPageLikeBtn.querySelector('.material-icons');
            const liked = !!currentTrack && isTrackLiked(currentTrack);
            if (icon) {
                icon.innerText = liked ? 'favorite' : 'favorite_border';
                icon.style.color = liked ? 'red' : '';
            }
            playerPageLikeBtn.title = liked ? '已喜欢' : '喜欢';
            if (!currentTrack) {
                return;
            }
        }

        function updatePlayerPagePlayUI() {
            if (playerPagePlay) {
                const icon = playerPagePlay.querySelector('.material-icons');
                if (icon) icon.innerText = audio.paused ? 'play_arrow' : 'pause';
            }
            if (playerPageVinyl) {
                playerPageVinyl.classList.toggle('is-playing', !audio.paused && !!audio.src);
            }
            if (!audio.paused && !!audio.src) startPlayerPageWave();
            else stopPlayerPageWave();
        }

        function updatePlayerPageModeUI() {
            if (playerPageRepeat) {
                const icon = playerPageRepeat.querySelector('.material-icons');
                if (icon) icon.innerText = playMode === 'repeat_one' ? 'repeat_one' : 'repeat';
                setButtonActive(playerPageRepeat, playMode !== 'order');
            }
            setButtonActive(playerPageShuffle, isShuffle);
        }

        let playerPageViewIndex = 0;
        let playerPagePointerDown = false;
        let playerPageStartX = 0;
        let playerPageStartY = 0;
        let playerPageActivePointerId = null;
        let playerPageDragLocked = null;
        let playerPageIsDragging = false;

        let playerPageWaveRaf = 0;
        let playerPageWaveCtx2d = null;
        let playerPageWaveParticles = [];

        function stopPlayerPageWave() {
            if (playerPageWaveRaf) cancelAnimationFrame(playerPageWaveRaf);
            playerPageWaveRaf = 0;
            if (playerPageWaveCtx2d && playerPageWaveCanvas) {
                const w = playerPageWaveCanvas.clientWidth || 1;
                const h = playerPageWaveCanvas.clientHeight || 1;
                playerPageWaveCtx2d.clearRect(0, 0, w, h);
            }
            playerPageWaveParticles = [];
        }

        function getMmPrimaryRgb() {
            try {
                const raw = String(getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '').trim();
                const parts = raw.split(/[\s,\/]+/).map((s) => Number(s)).filter((n) => Number.isFinite(n));
                const r = Math.max(0, Math.min(255, parts[0] ?? 124));
                const g = Math.max(0, Math.min(255, parts[1] ?? 58));
                const b = Math.max(0, Math.min(255, parts[2] ?? 237));
                return { r, g, b };
            } catch {
                return { r: 124, g: 58, b: 237 };
            }
        }

        function ensurePlayerPageWaveCanvas() {
            if (!playerPageWaveCanvas) return false;
            if (!playerPageWaveCtx2d) {
                try {
                    playerPageWaveCtx2d = playerPageWaveCanvas.getContext('2d', { alpha: true, desynchronized: true });
                } catch {
                    playerPageWaveCtx2d = null;
                }
            }
            if (!playerPageWaveCtx2d) return false;
            const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
            const w = Math.max(1, Math.floor(playerPageWaveCanvas.clientWidth || 1));
            const h = Math.max(1, Math.floor(playerPageWaveCanvas.clientHeight || 1));
            const pw = Math.max(1, Math.floor(w * dpr));
            const ph = Math.max(1, Math.floor(h * dpr));
            if (playerPageWaveCanvas.width !== pw || playerPageWaveCanvas.height !== ph) {
                playerPageWaveCanvas.width = pw;
                playerPageWaveCanvas.height = ph;
            }
            playerPageWaveCtx2d.setTransform(dpr, 0, 0, dpr, 0, 0);
            return true;
        }

        function startPlayerPageWave() {
            if (!ensurePlayerPageWaveCanvas()) return;
            if (playerPageWaveRaf) return;

            const { r, g, b } = getMmPrimaryRgb();
            const ctx = playerPageWaveCtx2d;
            const render = () => {
                playerPageWaveRaf = 0;
                if (!ctx || !playerPageWaveCanvas) return;

                if (!ensurePlayerPageWaveCanvas()) return;
                const w = Math.max(1, playerPageWaveCanvas.clientWidth || 1);
                const h = Math.max(1, playerPageWaveCanvas.clientHeight || 1);
                const cx = w / 2;
                const cy = h / 2;

                const playing = !audio.paused && !!audio.src && !audio.ended;
                const t = (performance.now() || 0) / 1000;
                const ct = (() => { try { return Number(audio.currentTime || 0); } catch { return 0; } })();
                const speed = playing ? 1 : 0.45;
                const phase = (t * 2.2 * speed) + (ct * 0.35);
                const amp = (playing ? 1 : 0.55) * (0.35 + 0.25 * Math.sin(phase * 1.2) + 0.15 * Math.sin(phase * 2.1));
                const a = Math.max(0.12, Math.min(1, amp));

                ctx.clearRect(0, 0, w, h);
                ctx.globalCompositeOperation = 'lighter';

                const grad = ctx.createLinearGradient(0, 0, w, 0);
                grad.addColorStop(0, `rgba(${r},${g},${b},${0.10 + a * 0.15})`);
                grad.addColorStop(0.5, `rgba(${Math.min(255, r + 60)},${Math.min(255, g + 40)},${Math.min(255, b + 20)},${0.18 + a * 0.22})`);
                grad.addColorStop(1, `rgba(${r},${g},${b},${0.10 + a * 0.15})`);

                const baseAmp = (h * 0.38) * a;
                const step = 2;
                const drawWave = (lw, alpha, blur, f1, f2, s1, s2, yOff = 0) => {
                    ctx.lineWidth = lw;
                    ctx.strokeStyle = grad;
                    ctx.globalAlpha = alpha;
                    ctx.shadowColor = `rgba(${r},${g},${b},${0.25 + a * 0.35})`;
                    ctx.shadowBlur = blur;
                    ctx.beginPath();
                    for (let x = 0; x <= w; x += step) {
                        const p = x / w;
                        const env = Math.sin(Math.PI * p);
                        const y =
                            cy + yOff
                            + (Math.sin((p * f1) + phase * s1) + 0.55 * Math.sin((p * f2) - phase * s2)) * baseAmp * env;
                        if (x === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    }
                    ctx.stroke();
                };

                drawWave(7, 0.08 + a * 0.07, 18, 10.5, 25.0, 1.15, 0.85, 0);
                drawWave(4, 0.16 + a * 0.10, 10, 12.0, 28.0, 1.25, 0.92, 0);
                drawWave(2, 0.24 + a * 0.12, 6, 14.0, 31.0, 1.35, 1.00, 0);

                const spawnRate = playing ? (0.6 + a * 2.4) : 0.35;
                if (Math.random() < spawnRate * 0.06 && playerPageWaveParticles.length < 28) {
                    const px = Math.random() * w;
                    const py = cy + (Math.random() - 0.5) * baseAmp * 0.9;
                    const dir = Math.random() < 0.5 ? -1 : 1;
                    playerPageWaveParticles.push({
                        x: px,
                        y: py,
                        vx: dir * (22 + Math.random() * 46),
                        vy: (Math.random() - 0.5) * (22 + Math.random() * 40),
                        life: 0.55 + Math.random() * 0.55,
                        age: 0,
                        s: 1 + Math.random() * 2.5,
                    });
                }

                const dt = 1 / 60;
                ctx.shadowBlur = 0;
                for (let i = playerPageWaveParticles.length - 1; i >= 0; i--) {
                    const p = playerPageWaveParticles[i];
                    p.age += dt;
                    if (p.age >= p.life) {
                        playerPageWaveParticles.splice(i, 1);
                        continue;
                    }
                    p.x += p.vx * dt;
                    p.y += p.vy * dt;
                    p.vy *= 0.985;
                    const k = 1 - (p.age / p.life);
                    const pr = Math.min(255, r + 90);
                    const pg = Math.min(255, g + 70);
                    const pb = Math.min(255, b + 35);
                    ctx.globalAlpha = Math.max(0, Math.min(1, k)) * (0.08 + a * 0.10);
                    ctx.fillStyle = `rgba(${pr},${pg},${pb},1)`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.s * (0.6 + 0.9 * k), 0, Math.PI * 2);
                    ctx.fill();
                }

                ctx.globalAlpha = 1;
                ctx.globalCompositeOperation = 'source-over';

                if (playing) playerPageWaveRaf = requestAnimationFrame(render);
                else stopPlayerPageWave();
            };

            playerPageWaveRaf = requestAnimationFrame(render);
        }

        function updatePlayerPageDots() {
            if (!playerPageDot0 || !playerPageDot1) return;
            const setDot = (dot, active) => {
                if (!dot) return;
                dot.classList.toggle('bg-material-primary', active);
                dot.classList.toggle('bg-material-text/20', !active);
                dot.classList.toggle('opacity-100', active);
                dot.classList.toggle('opacity-60', !active);
            };
            setDot(playerPageDot0, playerPageViewIndex === 0);
            setDot(playerPageDot1, playerPageViewIndex === 1);
        }

        function setPlayerPageView(index, animate = true) {
            if (!playerPageCarouselTrack) return;
            const next = index === 1 ? 1 : 0;
            playerPageViewIndex = next;
            playerPageCarouselTrack.style.transition = animate ? '' : 'none';
            playerPageCarouselTrack.style.transform = `translateX(-${next * 100}%)`;
            updatePlayerPageDots();
            if (!animate) {
                requestAnimationFrame(() => {
                    if (playerPageCarouselTrack) playerPageCarouselTrack.style.transition = '';
                });
            }
        }

        function initPlayerPageCarousel() {
            if (!playerPageCarousel || !playerPageCarouselTrack) return;
            setPlayerPageView(0, false);

            if (playerPageDot0) playerPageDot0.addEventListener('click', () => setPlayerPageView(0));
            if (playerPageDot1) playerPageDot1.addEventListener('click', () => setPlayerPageView(1));

            const playerPagePrevBtn = document.getElementById('player-page-prev-btn');
            const playerPageNextBtn = document.getElementById('player-page-next-btn');

            if (playerPagePrevBtn) {
                playerPagePrevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    setPlayerPageView(0);
                });
            }
            if (playerPageNextBtn) {
                playerPageNextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    setPlayerPageView(1);
                });
            }

            const isMobile = () => window.matchMedia && window.matchMedia('(max-width: 767px)').matches;

            const getTrackWidth = () => {
                if (!playerPageCarousel) return 0;
                return Math.max(1, playerPageCarousel.getBoundingClientRect().width || 0);
            };

            const onPointerDown = (e) => {
                if (!isMobile()) return;
                if (playerPagePointerDown) return;
                playerPagePointerDown = true;
                playerPageActivePointerId = e.pointerId;
                playerPageStartX = e.clientX;
                playerPageStartY = e.clientY;
                playerPageDragLocked = null;
                playerPageIsDragging = false;
                if (playerPageCarousel && playerPageCarousel.setPointerCapture) {
                    try { playerPageCarousel.setPointerCapture(e.pointerId); } catch {}
                }
            };

            const onPointerMove = (e) => {
                if (!playerPagePointerDown) return;
                if (playerPageActivePointerId != null && e.pointerId !== playerPageActivePointerId) return;
                if (!playerPageCarouselTrack) return;
                const dx = e.clientX - playerPageStartX;
                const dy = e.clientY - playerPageStartY;

                if (!playerPageDragLocked) {
                    const adx = Math.abs(dx);
                    const ady = Math.abs(dy);
                    if (adx < 10 && ady < 10) return;
                    playerPageDragLocked = adx > ady * 0.6 ? 'x' : 'y';
                }

                if (playerPageDragLocked !== 'x') return;
                playerPageIsDragging = true;
                e.preventDefault();
                const w = getTrackWidth();
                const offset = (-playerPageViewIndex * w) + dx;
                playerPageCarouselTrack.style.transition = 'none';
                playerPageCarouselTrack.style.transform = `translateX(${offset}px)`;
            };

            const onPointerUp = (e) => {
                if (!playerPagePointerDown) return;
                if (playerPageActivePointerId != null && e.pointerId !== playerPageActivePointerId) return;
                playerPagePointerDown = false;
                playerPageActivePointerId = null;
                const dx = e.clientX - playerPageStartX;
                const dy = e.clientY - playerPageStartY;
                const absDx = Math.abs(dx);
                const absDy = Math.abs(dy);

                if (!playerPageIsDragging || absDx < 20 || absDx < absDy * 0.6) {
                    setPlayerPageView(playerPageViewIndex, true);
                    playerPageIsDragging = false;
                    playerPageDragLocked = null;
                    return;
                }

                const w = getTrackWidth();
                const threshold = Math.max(60, w * 0.18);
                if (dx <= -threshold) setPlayerPageView(1, true);
                else if (dx >= threshold) setPlayerPageView(0, true);
                else setPlayerPageView(playerPageViewIndex, true);

                playerPageIsDragging = false;
                playerPageDragLocked = null;
            };

            playerPageCarousel.addEventListener('pointerdown', onPointerDown, { passive: true });
            playerPageCarousel.addEventListener('pointermove', onPointerMove, { passive: false });
            playerPageCarousel.addEventListener('pointerup', onPointerUp, { passive: true });
            playerPageCarousel.addEventListener('pointercancel', onPointerUp, { passive: true });

            window.addEventListener('resize', () => setPlayerPageView(playerPageViewIndex, false));
        }

        let mobilePlayerPageOpen = false;

        function isMobileViewport() {
            return !!(window.matchMedia && window.matchMedia('(max-width: 767px)').matches);
        }

        function setMobilePlayerPageOpen(open) {
            if (!isMobileViewport()) return;
            const next = !!open;
            mobilePlayerPageOpen = next;
            document.body.classList.toggle('mm-player-page-open', next);
            const icon = document.getElementById('player-cover-overlay-icon');
            if (icon) icon.innerText = next ? 'expand_more' : 'expand_less';
            if (next) setPlayerPageView(0, false);
        }

        function initMobilePlayerPageFullscreen() {
            const trigger = document.getElementById('player-cover-trigger');
            if (!trigger) return;

            trigger.addEventListener('click', () => {
                if (!isMobileViewport()) return;
                if (!currentTrack) return;
                setMobilePlayerPageOpen(!mobilePlayerPageOpen);
            });

            window.addEventListener('resize', () => {
                if (!isMobileViewport() && mobilePlayerPageOpen) {
                    mobilePlayerPageOpen = false;
                    document.body.classList.remove('mm-player-page-open');
                    const icon = document.getElementById('player-cover-overlay-icon');
                    if (icon) icon.innerText = 'expand_less';
                }
            });
        }

        const SIDEBAR_COLLAPSED_KEY = 'magicMusic_sidebarCollapsed_v1';

        function setSidebarToggleButtonState(btn, collapsed) {
            if (!btn) return;
            const icon = btn.querySelector('.material-icons');
            if (icon) icon.innerText = collapsed ? 'chevron_right' : 'chevron_left';
            btn.title = collapsed ? '显示侧边栏' : '隐藏侧边栏';
        }

        function setSidebarCollapsed(collapsed, persist = true) {
            const next = !!collapsed;
            document.body.classList.toggle('mm-sidebar-collapsed', next);
            setSidebarToggleButtonState(sidebarToggleBtn, next);
            setSidebarToggleButtonState(sidebarToggleBtnSidebar, next);
            if (persist) localStorage.setItem(SIDEBAR_COLLAPSED_KEY, next ? '1' : '0');
        }

        function initSidebarToggle() {
            const collapsed = localStorage.getItem(SIDEBAR_COLLAPSED_KEY) === '1';
            setSidebarCollapsed(collapsed, false);
            const onToggle = () => setSidebarCollapsed(!document.body.classList.contains('mm-sidebar-collapsed'));
            if (sidebarToggleBtn) sidebarToggleBtn.addEventListener('click', onToggle);
            if (sidebarToggleBtnSidebar) sidebarToggleBtnSidebar.addEventListener('click', onToggle);
        }

        function isQueueModalOpen() {
            return !!queueModal && !queueModal.classList.contains('hidden');
        }

        function closeQueueModal() {
            if (!queueModal) return;
            queueModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function renderQueueModal() {
            if (!queueModalList || !queueModalEmpty) return;
            queueModalList.innerHTML = '';

            const list = Array.isArray(playQueue) ? playQueue.filter(Boolean) : [];
            if (!list.length) {
                queueModalEmpty.classList.remove('hidden');
                return;
            }
            queueModalEmpty.classList.add('hidden');

            const curKey = currentTrack ? trackKey(currentTrack) : '';

            for (let i = 0; i < list.length; i += 1) {
                const t = list[i];
                const key = trackKey(t);
                const isCurrent = !!curKey && !!key && curKey === key;

                const row = document.createElement('button');
                row.type = 'button';
                row.className = `w-full px-4 py-3 flex items-center gap-3 text-left hover:bg-material-text/5 transition ${isCurrent ? 'text-material-primary' : 'text-material-text'}`;

                const coverWrap = document.createElement('div');
                coverWrap.className = 'w-10 h-10 rounded-md overflow-hidden bg-material-text/10 shrink-0 flex items-center justify-center';

                const coverUrl = proxify(t?.coverUrl || '');
                if (coverUrl) {
                    const img = document.createElement('img');
                    img.src = coverUrl;
                    img.alt = 'cover';
                    img.className = 'w-full h-full object-cover';
                    coverWrap.appendChild(img);
                } else {
                    const ico = document.createElement('span');
                    ico.className = 'material-icons text-material-text-secondary';
                    ico.innerText = 'music_note';
                    coverWrap.appendChild(ico);
                }

                const meta = document.createElement('div');
                meta.className = 'min-w-0 flex-1';

                const name = document.createElement('div');
                name.className = `text-sm font-medium truncate ${isCurrent ? 'text-material-primary' : 'text-material-text'}`;
                name.innerText = t?.name || '未知歌曲';

                const artist = document.createElement('div');
                artist.className = 'text-xs text-material-text-secondary truncate mt-0.5';
                artist.innerText = t?.artist || '—';

                meta.appendChild(name);
                meta.appendChild(artist);

                const badge = document.createElement('div');
                badge.className = 'shrink-0 text-[11px] px-2 py-1 rounded-full bg-material-text/5 text-material-text-secondary';
                badge.innerText = isCurrent ? '正在播放' : String(i + 1);

                row.appendChild(coverWrap);
                row.appendChild(meta);
                row.appendChild(badge);

                row.addEventListener('click', async () => {
                    closeQueueModal();
                    await playByIndex(i);
                });

                queueModalList.appendChild(row);
            }
        }

        function openQueueModal() {
            if (!queueModal) return;
            if (isQueueModalOpen()) {
                closeQueueModal();
                return;
            }
            renderQueueModal();
            queueModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        let playerPageLyricLines = [];
        let playerPageLyricLineEls = [];
        let playerPageLyricActiveIndex = -1;

        function resetPlayerPageLyricsState() {
            playerPageLyricLines = [];
            playerPageLyricLineEls = [];
            playerPageLyricActiveIndex = -1;
            if (playerPageSingleLyric) playerPageSingleLyric.innerText = '';
        }

        function stripLrc(raw) {
            const lyric = typeof raw === 'string' ? raw : '';
            return lyric
                .split('\n')
                .map((l) => String(l || '').replace(/\[(\d{1,2}:)?\d{1,2}:\d{1,2}(\.\d{1,3})?\]/g, '').trim())
                .filter(Boolean)
                .join('\n');
        }

        function parseLrc(raw) {
            const lyric = typeof raw === 'string' ? raw : '';
            const rows = lyric.split(/\r?\n/);
            const out = [];
            const timeRe = /\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/g;
            const metaRe = /^\[(ar|ti|al|by|offset|re|ve):/i;

            for (const row of rows) {
                const line = String(row || '');
                if (!line) continue;
                if (metaRe.test(line)) continue;

                timeRe.lastIndex = 0;
                let match;
                const times = [];
                while ((match = timeRe.exec(line)) != null) {
                    const mm = Number(match[1]);
                    const ss = Number(match[2]);
                    const frac = match[3] == null ? '0' : String(match[3]);
                    const ms = Number(frac.padEnd(3, '0').slice(0, 3));
                    if (!Number.isFinite(mm) || !Number.isFinite(ss) || !Number.isFinite(ms)) continue;
                    times.push(mm * 60 * 1000 + ss * 1000 + ms);
                }

                if (!times.length) continue;
                const text = line.replace(timeRe, '').trim();
                if (!text) continue;
                for (const t of times) out.push({ timeMs: t, text });
            }

            out.sort((a, b) => a.timeMs - b.timeMs);
            return out;
        }

        function renderPlayerPageLyrics(lines) {
            if (!playerPageLyrics) return;

            playerPageLyrics.innerHTML = '';
            playerPageLyricLines = Array.isArray(lines) ? lines : [];
            playerPageLyricLineEls = [];
            playerPageLyricActiveIndex = -1;

            const wrap = document.createElement('div');
            wrap.className = 'flex flex-col items-center gap-6 py-[50vh]';

            for (let i = 0; i < playerPageLyricLines.length; i += 1) {
                const row = playerPageLyricLines[i];
                const el = document.createElement('div');
                el.className = 'mm-lyric-line w-full text-2xl text-center px-4 select-none';
                el.innerText = row?.text || '';
                
                // Click to seek functionality could be added here
                el.addEventListener('click', () => {
                   if (row.timeMs && audio) {
                       audio.currentTime = row.timeMs / 1000;
                       if (audio.paused) playAudio();
                   }
                });

                wrap.appendChild(el);
                playerPageLyricLineEls.push(el);
            }

            playerPageLyrics.appendChild(wrap);
        }

        function findLyricIndexByTime(lines, nowMs) {
            if (!Array.isArray(lines) || !lines.length) return -1;
            let lo = 0;
            let hi = lines.length - 1;
            let ans = -1;
            while (lo <= hi) {
                const mid = (lo + hi) >> 1;
                const t = Number(lines[mid]?.timeMs || 0);
                if (t <= nowMs) {
                    ans = mid;
                    lo = mid + 1;
                } else {
                    hi = mid - 1;
                }
            }
            return ans;
        }

        function updatePlayerPageLyricsSync() {
            if (!playerPageLyrics) return;
            if (!playerPageLyricLines.length || !playerPageLyricLineEls.length) return;
            if (!audio.src) return;
            if (playerPageSection && playerPageSection.classList.contains('hidden')) return;

            const nowMs = Math.max(0, (Number.isFinite(audio.currentTime) ? audio.currentTime : 0) * 1000);
            const idx = findLyricIndexByTime(playerPageLyricLines, nowMs + 300); // slight offset
            if (idx === playerPageLyricActiveIndex) return;

            if (playerPageLyricActiveIndex >= 0 && playerPageLyricLineEls[playerPageLyricActiveIndex]) {
                const prev = playerPageLyricLineEls[playerPageLyricActiveIndex];
                prev.classList.remove('is-active');
            }

            playerPageLyricActiveIndex = idx;

            // Update single line lyric
            if (playerPageSingleLyric) {
                 if (idx >= 0 && playerPageLyricLines[idx]) {
                     playerPageSingleLyric.textContent = playerPageLyricLines[idx].text;
                     playerPageSingleLyric.style.opacity = '1';
                 } else {
                     // Keep previous text but fade out? Or clear? 
                     // Let's clear it or keep it empty if no match found yet
                     if (idx === -1) {
                        playerPageSingleLyric.textContent = '';
                        playerPageSingleLyric.style.opacity = '0';
                     }
                 }
            }

            if (idx < 0 || !playerPageLyricLineEls[idx]) return;

            const curEl = playerPageLyricLineEls[idx];
            curEl.classList.add('is-active');

            const container = playerPageLyrics;
            const targetTop = Math.max(0, curEl.offsetTop - (container.clientHeight / 2 - curEl.offsetHeight / 2));
            requestAnimationFrame(() => {
                if (!playerPageLyrics) return;
                playerPageLyrics.scrollTop = targetTop;
            });
        }

        async function loadLyricsForTrack(track) {
            if (!playerPageLyrics) return;
            if (!track || !track.platform || !track.id) {
                resetPlayerPageLyricsState();
                playerPageLyrics.innerText = '暂无歌词';
                return;
            }
            resetPlayerPageLyricsState();
            playerPageLyrics.innerText = '歌词加载中...';
            try {
                let raw = '';

                if (track.platform === 'netease') {
                    const res = await fetch(`/netease/lyric?id=${encodeURIComponent(track.id)}`, { credentials: 'same-origin' });
                    const json = await res.json().catch(() => null);
                    raw = (json && json.lrc && json.lrc.lyric) ? String(json.lrc.lyric) : '';
                }

                if (track.platform === 'kugou') {
                    const keywords = track.name ? String(track.name) : '';
                    const searchRes = await fetch(
                        `/kugou/search/lyric?hash=${encodeURIComponent(track.id)}&keywords=${encodeURIComponent(keywords)}&keyword=${encodeURIComponent(keywords)}`,
                        { credentials: 'same-origin' },
                    );
                    const searchJson = await searchRes.json().catch(() => null);
                    const candidates = Array.isArray(searchJson?.candidates)
                        ? searchJson.candidates
                        : (Array.isArray(searchJson?.data?.candidates) ? searchJson.data.candidates : []);
                    const first = candidates && candidates[0] ? candidates[0] : null;
                    const lyricId = first && (first.id || first.ID) ? String(first.id || first.ID) : '';
                    const accessKey = first && (first.accesskey || first.accessKey) ? String(first.accesskey || first.accessKey) : '';
                    if (!lyricId || !accessKey) {
                        playerPageLyrics.innerText = '暂无歌词';
                        return;
                    }
                    const lyricRes = await fetch(
                        `/kugou/lyric?id=${encodeURIComponent(lyricId)}&accesskey=${encodeURIComponent(accessKey)}&fmt=lrc&decode=true`,
                        { credentials: 'same-origin' },
                    );
                    const lyricJson = await lyricRes.json().catch(() => null);
                    raw = String(lyricJson?.decodeContent || lyricJson?.data?.decodeContent || lyricJson?.content || lyricJson?.data?.content || '');
                }

                if (!raw) {
                    playerPageLyrics.innerText = '暂无歌词';
                    return;
                }

                const parsed = parseLrc(raw);
                if (parsed.length) {
                    renderPlayerPageLyrics(parsed);
                    updatePlayerPageLyricsSync();
                    return;
                }

                const cleaned = stripLrc(raw);
                playerPageLyrics.innerText = cleaned || '暂无歌词';
            } catch {
                resetPlayerPageLyricsState();
                playerPageLyrics.innerText = '暂无歌词';
            }
        }

        function updatePlayerPageUI() {
            if (!playerPageTitle || !playerPageArtist || !playerPageMeta) return;
            if (!currentTrack) {
                playerPageTitle.innerText = '未播放';
                playerPageArtist.innerText = '—';
                playerPageMeta.innerText = '';
                playerPageMeta.classList.add('hidden');
                if (playerPageCover) playerPageCover.classList.add('hidden');
                if (playerPageCoverFallback) playerPageCoverFallback.classList.remove('hidden');
                resetPlayerPageLyricsState();
                if (playerPageLyrics) playerPageLyrics.innerText = '暂无歌词';
                updatePlayerPageLikeUI();
                updatePlayerPagePlayUI();
                updatePlayerPageModeUI();
                return;
            }
            playerPageTitle.innerText = currentTrack.name || '未知歌曲';
            const artist = currentTrack.artist || '未知歌手';
            const album = currentTrack.album ? String(currentTrack.album).trim() : '';
            playerPageArtist.innerText = album ? `${artist} - ${album}` : artist;
            if (isAndroidApp) {
                playerPageMeta.innerText = '';
                playerPageMeta.classList.add('hidden');
            } else {
            const p = platformLabel(currentTrack.platform);
            const metaParts = [];
            if (p && p !== '酷狗') metaParts.push(p);
            if (metaParts.length) {
                playerPageMeta.innerText = metaParts.join(' · ');
                playerPageMeta.classList.remove('hidden');
            } else {
                playerPageMeta.innerText = '';
                playerPageMeta.classList.add('hidden');
            }
            }

            const coverUrl = proxify(currentTrack.coverUrl) || '';
            if (playerPageCover && coverUrl) {
                playerPageCover.src = coverUrl;
                playerPageCover.classList.remove('hidden');
                if (playerPageCoverFallback) playerPageCoverFallback.classList.add('hidden');
            } else {
                if (playerPageCover) playerPageCover.classList.add('hidden');
                if (playerPageCoverFallback) playerPageCoverFallback.classList.remove('hidden');
            }

            updatePlayerPageLikeUI();
            updatePlayerPagePlayUI();
            updatePlayerPageModeUI();
            loadLyricsForTrack(currentTrack).catch(() => {});
        }

        function setPlayerBarDisabled(disabled) {
            const btns = [playerLikeBtn, playerDownloadBtn, playerAddToPlaylistBtn, prevBtn, nextBtn];
            for (const b of btns) {
                if (!b) continue;
                b.classList.toggle('opacity-40', disabled);
                b.classList.toggle('pointer-events-none', disabled);
            }
        }

        function updatePlayerBarUI() {
            if (!playerTitle || !playerArtist) return;
            if (!currentTrack) {
                playerTitle.innerText = '未播放';
                playerArtist.innerText = '—';
                if (playerCover) playerCover.classList.add('hidden');
                if (playerCoverFallback) playerCoverFallback.classList.remove('hidden');
                setPlayerBarDisabled(true);
                updateLikeButtonUI();
                return;
            }
            playerTitle.innerText = currentTrack.name || '未知歌曲';
            playerArtist.innerText = currentTrack.artist || '未知歌手';
            const coverUrl = proxify(currentTrack.coverUrl) || '';
            if (playerCover && coverUrl) {
                playerCover.src = coverUrl;
                playerCover.classList.remove('hidden');
                if (playerCoverFallback) playerCoverFallback.classList.add('hidden');
            } else {
                if (playerCover) playerCover.classList.add('hidden');
                if (playerCoverFallback) playerCoverFallback.classList.remove('hidden');
            }
            setPlayerBarDisabled(false);
            updateLikeButtonUI();
        }

        function renderMyLists() {
            renderTrackList(favoritesList, likedTracks, currentUser && currentUser.id ? '还没有喜欢的歌曲' : '请登录以查看喜欢的歌曲');
            renderTrackList(downloadsList, downloadedTracks, currentUser && currentUser.id ? '还没有下载记录' : '请登录以查看下载记录');
            renderTrackList(recentList, recentTracks, currentUser && currentUser.id ? '还没有最近播放' : '请登录以查看最近播放');
            updateLikeButtonUI();
        }

        async function toggleLikeForCurrent() {
            if (!currentTrack) return;
            const t = sanitizeTrack(currentTrack);
            if (currentUser && currentUser.id) {
                const data = await apiRequest('/api/user/likes/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ track: sanitizeTrack(currentTrack) }),
                });
                likedTracks = Array.isArray(data.likes) ? data.likes.map(sanitizeTrack).filter(Boolean) : [];
                renderMyLists();
                const pid = await ensureDefaultServerPlaylistId().catch(() => '');
                if (pid && t) {
                    const liked = likedTracks.some((x) => trackKey(x) === trackKey(t));
                    const path = liked ? '/api/user/playlists/add' : '/api/user/playlists/remove';
                    apiRequest(path, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ playlistId: String(pid), track: t }),
                    }).catch(() => {});
                }
                return;
            }

            const k = trackKey(currentTrack);
            const idx = likedTracks.findIndex((t) => trackKey(t) === k);
            if (idx >= 0) likedTracks.splice(idx, 1);
            else likedTracks.unshift(sanitizeTrack(currentTrack));
            likedTracks = likedTracks.filter(Boolean).slice(0, 500);
            saveLocalList(LIKED_KEY, likedTracks);
            renderMyLists();
            const pid = ensureDefaultLocalPlaylist();
            if (pid && t) {
                const liked = likedTracks.some((x) => trackKey(x) === trackKey(t));
                if (liked) addTrackToPlaylist(pid, t);
                else removeTrackFromPlaylist(pid, t);
            }
        }

        async function recordDownload(track) {
            const t = sanitizeTrack(track);
            if (!t) return;
            if (currentUser && currentUser.id) {
                const data = await apiRequest('/api/user/downloads/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ track: t }),
                });
                downloadedTracks = Array.isArray(data.downloads) ? data.downloads.map(sanitizeTrack).filter(Boolean) : [];
                renderMyLists();
                return;
            }
            const k = trackKey(t);
            const idx = downloadedTracks.findIndex((x) => trackKey(x) === k);
            if (idx >= 0) downloadedTracks.splice(idx, 1);
            downloadedTracks.unshift(t);
            downloadedTracks = downloadedTracks.filter(Boolean).slice(0, 500);
            saveLocalList(DOWNLOADS_KEY, downloadedTracks);
            renderMyLists();
        }

        async function recordRecent(track) {
            const t = sanitizeTrack(track);
            if (!t) return;
            if (currentUser && currentUser.id) {
                const data = await apiRequest('/api/user/recents/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ track: t }),
                });
                recentTracks = Array.isArray(data.recents) ? data.recents.map(sanitizeTrack).filter(Boolean) : [];
                renderMyLists();
                return;
            }
            const k = trackKey(t);
            const idx = recentTracks.findIndex((x) => trackKey(x) === k);
            if (idx >= 0) recentTracks.splice(idx, 1);
            recentTracks.unshift(t);
            recentTracks = recentTracks.filter(Boolean).slice(0, 200);
            saveLocalList(RECENT_KEY, recentTracks);
            renderMyLists();
        }

        function renderTrackList(container, tracks, emptyText) {
            if (!container) return;
            const list = Array.isArray(tracks) ? tracks.filter(Boolean) : [];
            container.innerHTML = '';

            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-4 text-sm text-material-text-secondary';
                empty.innerText = emptyText || '暂无数据';
                container.appendChild(empty);
                return;
            }

            for (let i = 0; i < list.length; i++) {
                const track = list[i];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3 p-3 hover:bg-material-text/5 transition cursor-pointer';

                const cover = document.createElement('img');
                cover.className = 'w-10 h-10 rounded-md object-cover bg-material-text/10 shrink-0';
                cover.alt = 'cover';
                cover.src = proxify(track.coverUrl) || '';

                const meta = document.createElement('div');
                meta.className = 'flex-1 min-w-0';
                const title = document.createElement('div');
                title.className = 'text-sm font-medium text-material-text truncate';
                title.innerText = track.name || '';
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary truncate';
                sub.innerText = `${track.artist || ''}${track.album ? ' · ' + track.album : ''}`;
                meta.appendChild(title);
                meta.appendChild(sub);

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-1 shrink-0';

                const play = document.createElement('button');
                play.type = 'button';
                play.className = 'w-9 h-9 rounded-full bg-material-primary/15 text-material-primary hover:bg-material-primary/25 transition flex items-center justify-center ripple shrink-0';
                play.innerHTML = '<span class="material-icons text-xl">play_arrow</span>';
                setupTrackPlayButton(play, track, list, i);

                const dl = document.createElement('button');
                dl.type = 'button';
                dl.className = 'w-9 h-9 rounded-full bg-material-text/5 text-material-text-secondary hover:text-material-text hover:bg-material-text/10 transition flex items-center justify-center shrink-0';
                dl.innerHTML = '<span class="material-icons text-[20px]">download</span>';
                dl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await downloadTrack(track);
                });

                actions.appendChild(play);
                actions.appendChild(dl);

                row.appendChild(cover);
                row.appendChild(meta);
                row.appendChild(actions);

                row.addEventListener('click', async () => {
                    setQueue(list, i);
                    try {
                        await playTrack(track);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`播放失败：${msg}`);
                    }
                });

                container.appendChild(row);
            }
            updateInlinePlayButtonsUI();
        }

        function trackToDownloadUrl(track) {
            if (!track) return '';
            const baseName = `${track.name || 'music'} - ${track.artist || ''}`.trim();
            if (track._resolvedUrl) return toProxyDownloadUrl(track._resolvedUrl, baseName);
            return '';
        }

        async function resolveOnlineSongUrl(track) {
            if (!track || !track.platform) throw new Error('invalid track');
            if (track.platform === 'netease') {
                if (isAndroidApp) {
                    const legacyBrs = [128000, 320000, 999000];
                    for (const br of legacyBrs) {
                        const tryLegacy = await fetch(`/netease/song/url?id=${encodeURIComponent(track.id)}&br=${encodeURIComponent(br)}`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const list2 = tryLegacy && Array.isArray(tryLegacy.data) ? tryLegacy.data : [];
                        const url2 = (list2[0] || {}).url || '';
                        if (url2) {
                            track._resolvedUrl = url2;
                            return url2;
                        }
                    }
                }

                const v1FirstLevel = isAndroidApp ? 'standard' : 'exhigh';
                const v1SecondLevel = isAndroidApp ? 'exhigh' : 'standard';

                const tryV1 = await fetch(`/netease/song/url/v1?id=${encodeURIComponent(track.id)}&level=${encodeURIComponent(v1FirstLevel)}`, { credentials: 'same-origin' })
                    .then((r) => r.json())
                    .catch(() => null);
                const list1 = tryV1 && Array.isArray(tryV1.data) ? tryV1.data : [];
                const url1 = (list1[0] || {}).url || '';
                if (url1) {
                    track._resolvedUrl = url1;
                    return url1;
                }

                const tryV1Second = await fetch(`/netease/song/url/v1?id=${encodeURIComponent(track.id)}&level=${encodeURIComponent(v1SecondLevel)}`, { credentials: 'same-origin' })
                    .then((r) => r.json())
                    .catch(() => null);
                const list1b = tryV1Second && Array.isArray(tryV1Second.data) ? tryV1Second.data : [];
                const url1b = (list1b[0] || {}).url || '';
                if (url1b) {
                    track._resolvedUrl = url1b;
                    return url1b;
                }

                const legacyBrs = isAndroidApp ? [999000] : [999000];
                for (const br of legacyBrs) {
                    const tryLegacy = await fetch(`/netease/song/url?id=${encodeURIComponent(track.id)}&br=${encodeURIComponent(br)}`, { credentials: 'same-origin' })
                        .then((r) => r.json())
                        .catch(() => null);
                    const list2 = tryLegacy && Array.isArray(tryLegacy.data) ? tryLegacy.data : [];
                    const url2 = (list2[0] || {}).url || '';
                    if (url2) {
                        track._resolvedUrl = url2;
                        return url2;
                    }
                }

                throw new Error('该歌曲可能无可用播放链接（版权/VIP/地区限制）');
            }
            if (track.platform === 'kugou') {
                const albumAudioId = track.album_audio_id || '0';
                const legacyRes = await fetch(`/kugou/song/url?hash=${encodeURIComponent(track.id)}&album_audio_id=${encodeURIComponent(albumAudioId)}&album_id=0&quality=128&free_part=1`, { credentials: 'same-origin' });
                const legacyJson = await legacyRes.json().catch(() => null);
                const legacyUrl = (legacyJson && Array.isArray(legacyJson.url) ? legacyJson.url[0] : '') || (legacyJson && Array.isArray(legacyJson.backupUrl) ? legacyJson.backupUrl[0] : '') || '';
                if (legacyUrl) {
                    track._resolvedUrl = legacyUrl;
                    return legacyUrl;
                }

                const newRes = await fetch(`/kugou/song/url/new?hash=${encodeURIComponent(track.id)}&album_audio_id=${encodeURIComponent(albumAudioId)}`, { credentials: 'same-origin' });
                const newJson = await newRes.json().catch(() => null);
                const newList = newJson && Array.isArray(newJson.data) ? newJson.data : (newJson && Array.isArray(newJson?.data?.data) ? newJson.data.data : []);
                const first = newList[0] || {};
                const info = first.info || first;
                const urls = info.tracker_url || info.en_tracker_url || [];
                const url = urls[0] || '';
                if (url) {
                    track._resolvedUrl = url;
                    return url;
                }
                throw new Error('no song url');
            }
            throw new Error('不支持的平台');
        }

        async function preloadDefaultTrack(tracks) {
            if (defaultTrackPreloaded) return false;
            if (audio.src || currentTrack) return false;
            const list = Array.isArray(tracks) ? tracks.filter(Boolean) : [];
            if (!list.length) return false;

            for (let i = 0; i < Math.min(6, list.length); i++) {
                const t = list[i];
                if (!t) continue;
                try {
                    const url = t._resolvedUrl || (await resolveOnlineSongUrl(t));
                    if (!url) continue;
                    currentTrack = t;
                    ensureQueueIndexForTrack(t);
                    updatePlayerBarUI();
                    updatePlayerPageUI();
                    updateLikeButtonUI();
                    updatePlayerPageLikeUI();
                    audio.preload = 'metadata';
                    audio.src = toProxyMediaUrl(url);
                    try {
                        audio.load();
                    } catch {}
                    setPlayIcon(false);
                    updatePlayerPagePlayUI();
                    updateInlinePlayButtonsUI();
                    setQueue(list, i);
                    defaultTrackPreloaded = true;
                    return true;
                } catch {}
            }

            currentTrack = list[0];
            ensureQueueIndexForTrack(list[0]);
            updatePlayerBarUI();
            updatePlayerPageUI();
            updateLikeButtonUI();
            updatePlayerPageLikeUI();
            setPlayIcon(false);
            updatePlayerPagePlayUI();
            updateInlinePlayButtonsUI();
            setQueue(list, 0);
            defaultTrackPreloaded = true;
            return false;
        }

        async function playTrack(track) {
            unlockAudioPlayback();
            currentTrack = track;
            ensureQueueIndexForTrack(track);
            updatePlayerBarUI();
            updatePlayerPageUI();
            let url = track._resolvedUrl || '';
            if (!url) {
                url = await resolveOnlineSongUrl(track);
            }
            if (!url) throw new Error('no song url');
            audio.src = toProxyMediaUrl(url);
            try {
                audio.load();
            } catch {}
            await mmPlay('playTrack');
            setPlayIcon(true);
            updatePlayerPagePlayUI();
            updateInlinePlayButtonsUI();
            recordRecent(track).catch(() => {});
        }

        async function downloadTrack(track) {
            if (!track) return;
            try {
                const url = track._resolvedUrl || (await resolveOnlineSongUrl(track));
                if (!url) throw new Error('no song url');
                const baseName = `${track.name || 'music'} - ${track.artist || ''}`.trim();
                const downloadHref = toProxyDownloadUrl(url, baseName);
                const absoluteDownloadUrl = (() => {
                    try {
                        return new URL(downloadHref, window.location.href).toString();
                    } catch {
                        return downloadHref;
                    }
                })();
                try {
                    if (window.MagicMusicAndroid && typeof window.MagicMusicAndroid.download === 'function') {
                        window.MagicMusicAndroid.download(absoluteDownloadUrl, baseName || 'music');
                        recordDownload(track).catch(() => {});
                        return;
                    }
                } catch {}
                const a = document.createElement('a');
                a.href = downloadHref;
                a.download = baseName || 'music';
                document.body.appendChild(a);
                a.click();
                a.remove();
                recordDownload(track).catch(() => {});
            } catch (err) {
                const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                alert(`下载失败：${msg}`);
            }
        }

        function renderSearchResults(items, keywords) {
            if (!searchResultsList || !searchResultsSection || !searchResultsTitle) return;
            searchResultsTitle.innerText = `搜索结果：${keywords}`;
            const list = Array.isArray(items) ? items : [];
            searchResultsList.innerHTML = '';

            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-4 text-sm text-material-text-secondary';
                empty.innerText = '没有找到结果';
                searchResultsList.appendChild(empty);
                searchResultsSection.classList.remove('hidden');
                return;
            }

            setQueue(list, 0);

            for (let i = 0; i < list.length; i++) {
                const track = list[i];
                const row = document.createElement('div');
                row.className = 'flex items-center gap-3 p-3 hover:bg-material-text/5 transition';

                const cover = document.createElement('img');
                cover.className = 'w-10 h-10 rounded-md object-cover bg-material-text/10 shrink-0';
                cover.alt = 'cover';
                cover.src = proxify(track.coverUrl) || '';

                const meta = document.createElement('div');
                meta.className = 'flex-1 min-w-0';
                const title = document.createElement('div');
                title.className = 'text-sm font-medium text-material-text truncate';
                title.innerText = track.name || '';
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary truncate';
                sub.innerText = `${track.artist || ''}${track.album ? ' · ' + track.album : ''}`;
                meta.appendChild(title);
                meta.appendChild(sub);

                const play = document.createElement('button');
                play.className = 'w-9 h-9 rounded-full bg-material-primary/15 text-material-primary hover:bg-material-primary/25 transition flex items-center justify-center ripple shrink-0';
                play.innerHTML = '<span class="material-icons text-xl">play_arrow</span>';
                setupTrackPlayButton(play, track, list, i);

                const dl = document.createElement('button');
                dl.type = 'button';
                dl.className = 'w-9 h-9 rounded-full bg-material-text/5 text-material-text-secondary hover:text-material-text hover:bg-material-text/10 transition flex items-center justify-center shrink-0';
                dl.innerHTML = '<span class="material-icons text-[20px]">download</span>';
                dl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await downloadTrack(track);
                });

                row.appendChild(cover);
                row.appendChild(meta);
                row.appendChild(play);
                row.appendChild(dl);
                row.addEventListener('click', async () => {
                    setQueue(list, i);
                    try {
                        await playTrack(track);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`播放失败：${msg}`);
                    }
                });
                searchResultsList.appendChild(row);
            }

            searchResultsSection.classList.remove('hidden');
            updateInlinePlayButtonsUI();
        }

        function normalizeTrack(raw) {
            if (!raw) return null;
            if (raw.platform === 'netease' || raw.platform === 'kugou' || raw.platform === 'local' || raw.platform === 'spotify') return raw;
            return raw;
        }

        function normalizeNetEaseSearch(json) {
            const result = json?.result || json?.data || json;
            const songs = result?.songs || [];
            if (!Array.isArray(songs)) return [];
            return songs.map((s) => {
                const ar = Array.isArray(s?.ar) ? s.ar : [];
                const artists = ar.map((a) => a?.name).filter(Boolean).join(' / ');
                return normalizeTrack({
                    platform: 'netease',
                    id: s?.id,
                    name: s?.name || '',
                    artist: artists || '',
                    album: s?.al?.name || '',
                    coverUrl: s?.al?.picUrl || '',
                });
            }).filter(Boolean);
        }

        function normalizeKuGouSearch(json) {
            const data = json?.data || json;
            const lists = data?.lists || [];
            if (!Array.isArray(lists)) return [];
            return lists.map((it) => {
                const singers = Array.isArray(it?.Singers) ? it.Singers : [];
                const artists = singers.map((a) => a?.name).filter(Boolean).join(' / ');
                return normalizeTrack({
                    platform: 'kugou',
                    id: it?.FileHash || '',
                    name: it?.OriSongName || '',
                    artist: artists || '',
                    album: it?.AlbumName || '',
                    coverUrl: it?.Image || '',
                    album_audio_id: it?.AlbumAudioID || it?.AlbumAudioId || it?.album_audio_id || it?.album_audioid || it?.Audioid || it?.AudioId || it?.audioid || '',
                });
            }).filter(Boolean);
        }

        let homeSlides = [];
        let homeSlideIndex = 0;
        let homeSlideTimer = null;
        let homeGuessTracks = [];
        let homeDailyTracks = [];

        function getHomeSlideSrc(slide) {
            if (!slide) return '';
            const raw = slide.imageDataUrl || slide.imageUrl || '';
            return String(raw || '');
        }

        function stopHomeSlideTimer() {
            if (homeSlideTimer) clearInterval(homeSlideTimer);
            homeSlideTimer = null;
        }

        function setHomeSlideIndex(next) {
            const list = Array.isArray(homeSlides) ? homeSlides : [];
            if (!list.length) return;
            const idx = Number(next);
            const normalized = Number.isFinite(idx) ? ((idx % list.length) + list.length) % list.length : 0;
            homeSlideIndex = normalized;
            const slide = list[homeSlideIndex];
            const src = getHomeSlideSrc(slide);
            if (homeSlideImg && src) homeSlideImg.src = src;
            if (homeSlideDots) {
                const dots = Array.from(homeSlideDots.querySelectorAll('button'));
                dots.forEach((btn, i) => btn.classList.toggle('bg-white', i === homeSlideIndex));
                dots.forEach((btn, i) => btn.classList.toggle('bg-white/50', i !== homeSlideIndex));
            }
        }

        async function playHomeSlidePlaylist(slide) {
            const playlistId = slide && slide.playlistId ? String(slide.playlistId) : '';
            if (!playlistId) return;
            const data = await apiRequest(`/api/home/playlists/${encodeURIComponent(playlistId)}`, { method: 'GET' });
            const playlist = data && data.playlist ? data.playlist : null;
            const tracks = Array.isArray(playlist?.tracks) ? playlist.tracks.map(sanitizeTrack).filter(Boolean) : [];
            if (!tracks.length) throw new Error('歌单没有可播放的歌曲');
            setQueue(tracks, 0);
            await playTrack(tracks[0]);
        }

        function renderHomeSlides(list) {
            homeSlides = Array.isArray(list) ? list : [];
            homeSlideIndex = 0;
            stopHomeSlideTimer();

            const slides = homeSlides.filter((s) => !!getHomeSlideSrc(s));
            homeSlides = slides;

            if (!homeSlideDots) return;
            homeSlideDots.innerHTML = '';

            if (homeSlides.length <= 1) {
                if (homeSlidePrev) homeSlidePrev.classList.add('hidden');
                if (homeSlideNext) homeSlideNext.classList.add('hidden');
            } else {
                if (homeSlidePrev) homeSlidePrev.classList.remove('hidden');
                if (homeSlideNext) homeSlideNext.classList.remove('hidden');
            }

            for (let i = 0; i < homeSlides.length; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = i === 0 ? 'w-2 h-2 rounded-full bg-white' : 'w-2 h-2 rounded-full bg-white/50 hover:bg-white cursor-pointer transition';
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    setHomeSlideIndex(i);
                    stopHomeSlideTimer();
                    if (homeSlides.length > 1) homeSlideTimer = setInterval(() => setHomeSlideIndex(homeSlideIndex + 1), 5000);
                });
                homeSlideDots.appendChild(btn);
            }

            setHomeSlideIndex(0);

            if (homeSlides.length > 1) {
                homeSlideTimer = setInterval(() => setHomeSlideIndex(homeSlideIndex + 1), 5000);
            }
        }

        async function initHomeSlides() {
            try {
                const data = await apiRequest('/api/home/slides', { method: 'GET' });
                renderHomeSlides(data && Array.isArray(data.slides) ? data.slides : []);
            } catch {
                renderHomeSlides([]);
            }
        }

        const recommendPlaylistsGrid = document.getElementById('recommend-playlists-grid');
        const recommendNewSongsList = document.getElementById('recommend-newsongs-list');
        const radioRecommendGrid = document.getElementById('radio-recommend-grid');
        const playlistSquareGrid = document.getElementById('playlist-square-grid');
        const hotSongsList = document.getElementById('hot-songs-list');
        const chartsGrid = document.getElementById('charts-grid');
        const artistsGrid = document.getElementById('artists-grid');
        const artistsHotGrid = document.getElementById('artists-hot-grid');
        const artistsInitialBar = document.getElementById('artists-initial-bar');
        const artistsLoadMore = document.getElementById('artists-load-more');
        const favoritesList = document.getElementById('favorites-list');
        const downloadsList = document.getElementById('downloads-list');
        const recentList = document.getElementById('recent-list');
        const homeSlideshow = document.getElementById('home-slideshow');
        const homeSlideImg = document.getElementById('home-slide-img');
        const homeSlideDots = document.getElementById('home-slide-dots');
        const homeSlidePrev = document.getElementById('home-slide-prev');
        const homeSlideNext = document.getElementById('home-slide-next');
        const homeCardGuess = document.getElementById('home-card-guess');
        const homeCardDaily = document.getElementById('home-card-daily');
        const homeCardGuessSub = document.getElementById('home-card-guess-sub');
        const homeCardDailySub = document.getElementById('home-card-daily-sub');
        const homeCardGuessPlay = document.getElementById('home-card-guess-play');
        const homeCardDailyPlay = document.getElementById('home-card-daily-play');

        if (homeSlidePrev) {
            homeSlidePrev.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                setHomeSlideIndex(homeSlideIndex - 1);
                stopHomeSlideTimer();
                if (homeSlides.length > 1) homeSlideTimer = setInterval(() => setHomeSlideIndex(homeSlideIndex + 1), 5000);
            });
        }

        if (homeSlideNext) {
            homeSlideNext.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                setHomeSlideIndex(homeSlideIndex + 1);
                stopHomeSlideTimer();
                if (homeSlides.length > 1) homeSlideTimer = setInterval(() => setHomeSlideIndex(homeSlideIndex + 1), 5000);
            });
        }

        if (homeSlideshow) {
            homeSlideshow.addEventListener('click', async () => {
                const slide = Array.isArray(homeSlides) ? homeSlides[homeSlideIndex] : null;
                if (!slide) return;
                try {
                    await playHomeSlidePlaylist(slide);
                } catch (err) {
                    alert(err instanceof Error ? err.message : '播放失败');
                }
            });
        }
        if (homeCardGuess) {
            homeCardGuess.addEventListener('click', async () => {
                const tracks = Array.isArray(homeGuessTracks) ? homeGuessTracks.filter(Boolean) : [];
                if (!tracks.length) return;
                setQueue(tracks, 0, 'home:guess');
                // openListResults('猜你喜欢', tracks);
                try {
                    const same = !!(currentTrack && trackKey(currentTrack) === trackKey(tracks[0]));
                    if (same && audio.src) {
                        activeQueueKey = 'home:guess';
                        if (audio.paused) await mmPlay('首页猜你喜欢');
                        else audio.pause();
                        updateInlinePlayButtonsUI();
                        return;
                    }
                    await playTrack(tracks[0]);
                } catch (err) {
                    if (isAndroidApp) mmAlert(err instanceof Error ? err.message : '播放失败');
                    else console.error(err);
                } finally {
                    updateInlinePlayButtonsUI();
                }
            });
        }
        if (homeCardDaily) {
            homeCardDaily.addEventListener('click', async () => {
                const tracks = Array.isArray(homeDailyTracks) ? homeDailyTracks.filter(Boolean) : [];
                if (!tracks.length) return;
                setQueue(tracks, 0, 'home:daily');
                // openListResults('每日推荐', tracks);
                try {
                    const same = !!(currentTrack && trackKey(currentTrack) === trackKey(tracks[0]));
                    if (same && audio.src) {
                        activeQueueKey = 'home:daily';
                        if (audio.paused) await mmPlay('首页每日推荐');
                        else audio.pause();
                        updateInlinePlayButtonsUI();
                        return;
                    }
                    await playTrack(tracks[0]);
                } catch (err) {
                    if (isAndroidApp) mmAlert(err instanceof Error ? err.message : '播放失败');
                    else console.error(err);
                } finally {
                    updateInlinePlayButtonsUI();
                }
            });
        }

        function getArtistsText(arr) {
            const list = Array.isArray(arr) ? arr : [];
            return list.map((a) => a?.name).filter(Boolean).join(' / ');
        }

        function normalizeNetEaseSongToTrack(song) {
            if (!song) return null;
            const ar = Array.isArray(song?.ar) ? song.ar : (Array.isArray(song?.artists) ? song.artists : []);
            const al = song?.al || song?.album || {};
            return normalizeTrack({
                platform: 'netease',
                id: song?.id,
                name: song?.name || '',
                artist: getArtistsText(ar) || '',
                album: al?.name || '',
                coverUrl: al?.picUrl || song?.picUrl || '',
            });
        }

        function parseArtistTitle(text) {
            const raw = String(text || '').trim();
            if (!raw) return { artist: '', title: '' };
            const idx = raw.indexOf(' - ');
            if (idx > 0) {
                return { artist: raw.slice(0, idx).trim(), title: raw.slice(idx + 3).trim() };
            }
            return { artist: '', title: raw };
        }

        function normalizeKuGouSongToTrack(song) {
            if (!song) return null;
            if (song.platform === 'kugou' && song.id) return normalizeTrack(song);
            const hash = song?.hash
                || song?.FileHash
                || song?.Hash
                || song?.hash_320
                || song?.hash_flac
                || song?.hash_high
                || song?.audio_info?.hash_128
                || song?.audio_info?.hash_320
                || song?.audio_info?.hash_flac
                || song?.audio_info?.hash_high
                || song?.deprecated?.hash
                || song?.mvdata?.[0]?.hash
                || '';
            const albumAudioId = song?.album_audio_id
                || song?.album_audioid
                || song?.AlbumAudioID
                || song?.AlbumAudioId
                || song?.Audioid
                || song?.AudioId
                || song?.audioid
                || song?.audio_info?.album_audio_id
                || song?.audio_info?.album_audioid
                || song?.business?.album_audio_id
                || song?.business?.album_audioid
                || '';
            const display = song?.business?.filename || song?.filename || song?.name || song?.OriSongName || song?.SongName || '';
            const parsed = parseArtistTitle(display);
            const artist = song?.author_name || song?.singername || song?.singer_name || parsed.artist || '';
            const title = song?.songname || song?.song_name || song?.audio_name || song?.name || song?.OriSongName || parsed.title || '';
            const album = song?.album_info?.album_name || song?.album_name || song?.AlbumName || '';
            const cover = song?.album_info?.sizable_cover
                || song?.trans_param?.union_cover
                || song?.imgurl
                || song?.pic
                || song?.Image
                || song?.cover
                || '';
            return normalizeTrack({
                platform: 'kugou',
                id: hash,
                name: title,
                artist,
                album,
                coverUrl: String(cover || '').replace(/\{size\}/g, '400'),
                album_audio_id: albumAudioId,
            });
        }

        function normalizeAnySongToTrack(song) {
            if (!song) return null;
            if (song.platform === 'netease' || song.platform === 'kugou' || song.platform === 'local') return normalizeTrack(song);
            if (song?.hash || song?.FileHash || song?.filename) return normalizeKuGouSongToTrack(song);
            return normalizeNetEaseSongToTrack(song);
        }

        function openListResults(title, tracks) {
            renderSearchResults(tracks, title);
            const el = document.getElementById('search-results-section');
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function renderRecommendPlaylists(playlists) {
            if (!recommendPlaylistsGrid) return;
            recommendPlaylistsGrid.innerHTML = '';

            const list = Array.isArray(playlists) ? playlists : [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'col-span-full text-sm text-material-text-secondary';
                empty.innerText = '暂无推荐歌单';
                recommendPlaylistsGrid.appendChild(empty);
                return;
            }

            for (const pl of list) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left group';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl overflow-hidden transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative aspect-square bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = pl?.name || 'playlist';
                img.loading = 'lazy';
                img.src = proxify(pl?.picUrl || pl?.coverImgUrl || '') || '';
                coverWrap.appendChild(img);

                const meta = document.createElement('div');
                meta.className = 'p-3';
                const name = document.createElement('div');
                name.className = 'text-sm font-medium text-material-text line-clamp-2 min-h-[40px]';
                name.innerText = pl?.name || '';
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary mt-1';
                const pc = Number(pl?.playCount || 0);
                sub.innerText = pc ? `${pc.toLocaleString()} 播放` : '';
                meta.appendChild(name);
                meta.appendChild(sub);

                wrap.appendChild(coverWrap);
                wrap.appendChild(meta);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    const id = pl?.id;
                    if (!id) return;
                    try {
                        if (pl?.platform === 'kugou') {
                            const detail = await fetch(`/kugou/playlist/track/all?id=${encodeURIComponent(id)}&page=1&pagesize=30`, { credentials: 'same-origin' })
                                .then((r) => r.json())
                                .catch(() => null);
                            const tracksRaw = detail?.data?.songs || detail?.songs || [];
                            const tracks = Array.isArray(tracksRaw) ? tracksRaw.map(normalizeKuGouSongToTrack).filter(Boolean) : [];
                            if (tracks.length) setQueue(tracks, 0);
                            openListResults(`歌单：${pl?.name || id}`, tracks);
                            return;
                        }

                        const detail = await fetch(`/netease/playlist/detail?id=${encodeURIComponent(id)}&s=8`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const tracksRaw = detail?.playlist?.tracks || [];
                        const tracks = Array.isArray(tracksRaw) ? tracksRaw.map(normalizeNetEaseSongToTrack).filter(Boolean) : [];
                        if (tracks.length) setQueue(tracks, 0);
                        openListResults(`歌单：${pl?.name || id}`, tracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取歌单失败：${msg}`);
                    }
                });

                recommendPlaylistsGrid.appendChild(btn);
            }
        }

        function renderPlaylistSquare(playlists) {
            if (!playlistSquareGrid) return;
            playlistSquareGrid.innerHTML = '';

            const list = Array.isArray(playlists) ? playlists : [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'col-span-full text-sm text-material-text-secondary';
                empty.innerText = '暂无歌单';
                playlistSquareGrid.appendChild(empty);
                return;
            }

            for (const pl of list) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left group';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl overflow-hidden transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative aspect-square bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = pl?.name || 'playlist';
                img.loading = 'lazy';
                img.src = proxify(pl?.coverImgUrl || pl?.picUrl || '') || '';
                coverWrap.appendChild(img);

                const meta = document.createElement('div');
                meta.className = 'p-3';
                const name = document.createElement('div');
                name.className = 'text-sm font-medium text-material-text line-clamp-2 min-h-[40px]';
                name.innerText = pl?.name || '';
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary mt-1';
                const pc = Number(pl?.playCount || 0);
                sub.innerText = pc ? `${pc.toLocaleString()} 播放` : '';
                meta.appendChild(name);
                meta.appendChild(sub);

                wrap.appendChild(coverWrap);
                wrap.appendChild(meta);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    const id = pl?.id;
                    if (!id) return;
                    try {
                        if (pl?.platform === 'kugou') {
                            const detail = await fetch(`/kugou/playlist/track/all?id=${encodeURIComponent(id)}&page=1&pagesize=30`, { credentials: 'same-origin' })
                                .then((r) => r.json())
                                .catch(() => null);
                            const tracksRaw = detail?.data?.songs || detail?.songs || [];
                            const tracks = Array.isArray(tracksRaw) ? tracksRaw.map(normalizeKuGouSongToTrack).filter(Boolean) : [];
                            setQueue(tracks, 0);
                            openListResults(`歌单：${pl?.name || id}`, tracks);
                            return;
                        }

                        const detail = await fetch(`/netease/playlist/detail?id=${encodeURIComponent(id)}&s=8`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const tracksRaw = detail?.playlist?.tracks || [];
                        const tracks = Array.isArray(tracksRaw) ? tracksRaw.map(normalizeNetEaseSongToTrack).filter(Boolean) : [];
                        setQueue(tracks, 0);
                        openListResults(`歌单：${pl?.name || id}`, tracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取歌单失败：${msg}`);
                    }
                });

                playlistSquareGrid.appendChild(btn);
            }
        }

        function renderNewSongs(items) {
            if (!recommendNewSongsList) return;
            recommendNewSongsList.innerHTML = '';

            const list = Array.isArray(items) ? items : [];
            const tracksForQueue = [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'col-span-full text-sm text-material-text-secondary';
                empty.innerText = '暂无最新音乐';
                recommendNewSongsList.appendChild(empty);
                return;
            }

            for (let i = 0; i < list.length; i++) {
                const it = list[i];
                const song = it?.song || it;
                const track = normalizeAnySongToTrack(song);
                if (!track) continue;
                tracksForQueue.push(track);
                const queueIdx = tracksForQueue.length - 1;

                const row = document.createElement('div');
                row.className = 'flex items-center p-2 rounded-md hover:bg-material-text/5 group cursor-pointer transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative w-12 h-12 rounded overflow-hidden mr-3 shrink-0 bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = track.name || 'cover';
                img.loading = 'lazy';
                img.src = proxify(track.coverUrl) || '';
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition';
                overlay.innerHTML = '<span class="material-icons text-white text-lg">play_arrow</span>';
                coverWrap.appendChild(img);
                coverWrap.appendChild(overlay);

                const meta = document.createElement('div');
                meta.className = 'flex-1 min-w-0 flex flex-col justify-center';
                const title = document.createElement('h4');
                title.className = 'text-sm font-medium text-material-text truncate';
                title.innerText = track.name || '';
                const subWrap = document.createElement('div');
                subWrap.className = 'flex items-center gap-1';
                const sub = document.createElement('p');
                sub.className = 'text-xs text-material-text-secondary truncate';
                sub.innerText = track.artist || '';
                subWrap.appendChild(sub);
                meta.appendChild(title);
                meta.appendChild(subWrap);

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-1 shrink-0';
                const play = document.createElement('button');
                play.type = 'button';
                play.className = 'w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition';
                play.innerHTML = '<span class="material-icons text-[20px]">play_arrow</span>';
                setupTrackPlayButton(play, track, tracksForQueue, queueIdx);
                const dl = document.createElement('button');
                dl.type = 'button';
                dl.className = 'w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition';
                dl.innerHTML = '<span class="material-icons text-[20px]">download</span>';
                dl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await downloadTrack(track);
                });
                actions.appendChild(play);
                actions.appendChild(dl);

                row.appendChild(coverWrap);
                row.appendChild(meta);
                row.appendChild(actions);

                row.addEventListener('click', async () => {
                    setQueue(tracksForQueue, queueIdx);
                    try {
                        await playTrack(track);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`播放失败：${msg}`);
                    }
                });

                recommendNewSongsList.appendChild(row);
            }
            if (tracksForQueue.length) {
                setQueue(tracksForQueue, 0);
            }
            updateInlinePlayButtonsUI();
        }

        function renderRadioRecommends(radios) {
            if (!radioRecommendGrid) return;
            radioRecommendGrid.innerHTML = '';

            const list = Array.isArray(radios) ? radios : [];
            const allTracksByRadio = new Map();
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'col-span-full text-sm text-material-text-secondary';
                empty.innerText = '暂无电台推荐';
                radioRecommendGrid.appendChild(empty);
                return;
            }

            for (const r of list) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left group';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl overflow-hidden transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative aspect-square bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = r?.name || 'radio';
                img.loading = 'lazy';
                const kgCover = (Array.isArray(r?.rcmdlist) && r.rcmdlist[0]) ? (r.rcmdlist[0]?.trans_param?.union_cover || '') : '';
                img.src = proxify(r?.picUrl || kgCover || '') || '';
                coverWrap.appendChild(img);

                const meta = document.createElement('div');
                meta.className = 'p-3';
                const name = document.createElement('div');
                name.className = 'text-sm font-medium text-material-text line-clamp-2 min-h-[40px]';
                name.innerText = r?.name || (r?.classid ? `电台推荐 ${r.classid}` : '');
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary mt-1';
                const cat = r?.category || '';
                sub.innerText = cat ? cat : '';
                meta.appendChild(name);
                meta.appendChild(sub);

                wrap.appendChild(coverWrap);
                wrap.appendChild(meta);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    try {
                        if (Array.isArray(r?.rcmdlist)) {
                            const tracks = r.rcmdlist.map(normalizeKuGouSongToTrack).filter(Boolean);
                            setQueue(tracks, 0);
                            openListResults(`电台：${r?.name || '推荐电台'}`, tracks);
                            return;
                        }

                        const rid = r?.id;
                        if (!rid) return;
                        const json = await fetch(`/netease/dj/program?rid=${encodeURIComponent(rid)}&limit=30&offset=0`, { credentials: 'same-origin' })
                            .then((res) => res.json())
                            .catch(() => null);
                        const programs = json?.programs || [];
                        const tracks = (Array.isArray(programs) ? programs : []).map((p) => {
                            const s = p?.mainSong;
                            const base = normalizeNetEaseSongToTrack(s);
                            if (!base) return null;
                            const cover = p?.coverUrl || p?.blurCoverUrl || r?.picUrl || base.coverUrl;
                            return normalizeTrack({
                                ...base,
                                coverUrl: cover,
                                artist: r?.name || base.artist || '',
                            });
                        }).filter(Boolean);
                        const validTracks = tracks.filter(Boolean);
                        allTracksByRadio.set(rid, validTracks);
                        setQueue(validTracks, 0);
                        openListResults(`电台：${r?.name || rid}`, validTracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取电台节目失败：${msg}`);
                    }
                });

                radioRecommendGrid.appendChild(btn);
            }
        }

        function renderTracksList(listEl, tracks, emptyText) {
            if (!listEl) return;
            listEl.innerHTML = '';
            const list = Array.isArray(tracks) ? tracks : [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'p-4 text-sm text-material-text-secondary';
                empty.innerText = emptyText || '暂无歌曲';
                listEl.appendChild(empty);
                return;
            }

            const queueTracks = list.map(normalizeAnySongToTrack).filter(Boolean);
            for (let i = 0; i < queueTracks.length; i++) {
                const track = queueTracks[i];
                const row = document.createElement('div');
                row.className = 'flex items-center p-3 hover:bg-material-text/5 group cursor-pointer transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative w-12 h-12 rounded overflow-hidden mr-3 shrink-0 bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = track.name || 'cover';
                img.loading = 'lazy';
                img.src = proxify(track.coverUrl) || '';
                const overlay = document.createElement('button');
                overlay.type = 'button';
                overlay.className = 'absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition';
                overlay.innerHTML = '<span class="material-icons text-white text-lg">play_arrow</span>';
                setupTrackPlayButton(overlay, track, queueTracks, i);
                coverWrap.appendChild(img);
                coverWrap.appendChild(overlay);

                const meta = document.createElement('div');
                meta.className = 'flex-1 min-w-0';
                const title = document.createElement('div');
                title.className = 'text-sm font-medium text-material-text truncate';
                title.innerText = track.name || '';
                const sub = document.createElement('div');
                sub.className = 'text-xs text-material-text-secondary truncate mt-0.5';
                sub.innerText = track.artist || '';
                meta.appendChild(title);
                meta.appendChild(sub);

                const actions = document.createElement('div');
                actions.className = 'flex items-center gap-1 shrink-0';
                const play = document.createElement('button');
                play.type = 'button';
                play.className = 'w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition';
                play.innerHTML = '<span class="material-icons text-[20px]">play_arrow</span>';
                setupTrackPlayButton(play, track, queueTracks, i);
                const dl = document.createElement('button');
                dl.type = 'button';
                dl.className = 'w-8 h-8 flex items-center justify-center rounded-full text-material-text-secondary hover:text-material-text hover:bg-material-text/5 transition';
                dl.innerHTML = '<span class="material-icons text-[20px]">download</span>';
                dl.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    await downloadTrack(track);
                });
                actions.appendChild(play);
                actions.appendChild(dl);

                row.appendChild(coverWrap);
                row.appendChild(meta);
                row.appendChild(actions);
                row.addEventListener('click', async () => {
                    setQueue(queueTracks, i);
                    try {
                        await playTrack(track);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`播放失败：${msg}`);
                    } finally {
                        updateInlinePlayButtonsUI();
                    }
                });
                listEl.appendChild(row);
            }
            updateInlinePlayButtonsUI();
        }

        function renderCharts(charts) {
            if (!chartsGrid) return;
            chartsGrid.innerHTML = '';
            const list = Array.isArray(charts) ? charts : [];
            if (list.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'col-span-full text-sm text-material-text-secondary';
                empty.innerText = '暂无榜单';
                chartsGrid.appendChild(empty);
                return;
            }

            for (const it of list) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left group';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl overflow-hidden transition';

                const coverWrap = document.createElement('div');
                coverWrap.className = 'relative aspect-square bg-material-text/10';
                const img = document.createElement('img');
                img.className = 'w-full h-full object-cover';
                img.alt = it?.name || 'chart';
                img.loading = 'lazy';
                img.src = proxify(it?.coverUrl || it?.picUrl || '') || '';
                coverWrap.appendChild(img);

                const meta = document.createElement('div');
                meta.className = 'p-3';
                const name = document.createElement('div');
                name.className = 'text-sm font-medium text-material-text line-clamp-2 min-h-[40px]';
                name.innerText = it?.name || '';
                meta.appendChild(name);

                wrap.appendChild(coverWrap);
                wrap.appendChild(meta);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    try {
                        if (it?.platform === 'kugou') {
                            const json = await fetch(`/kugou/rank/audio?rankid=${encodeURIComponent(it?.id || '')}&page=1&pagesize=30`, { credentials: 'same-origin' })
                                .then((r) => r.json())
                                .catch(() => null);
                            const raw = json?.data?.songs
                                || json?.data?.info?.songs
                                || json?.data?.song_list
                                || json?.data?.songlist
                                || json?.songs
                                || [];
                            const tracks = (Array.isArray(raw) ? raw : []).map(normalizeKuGouSongToTrack).filter(Boolean);
                            if (tracks.length) setQueue(tracks, 0);
                            openListResults(`榜单：${it?.name || it?.id}`, tracks);
                            return;
                        }
                        const json = await fetch(`/netease/playlist/track/all?id=${encodeURIComponent(it?.id || '')}&limit=50&offset=0`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const raw = json?.songs || json?.data?.songs || json?.result?.songs || [];
                        const tracks = (Array.isArray(raw) ? raw : []).map(normalizeNetEaseSongToTrack).filter(Boolean);
                        if (tracks.length) setQueue(tracks, 0);
                        openListResults(`榜单：${it?.name || it?.id}`, tracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取榜单失败：${msg}`);
                    }
                });

                chartsGrid.appendChild(btn);
            }
        }

        function renderArtists(artists, opts = {}) {
            if (!artistsGrid) return;
            const append = !!opts.append;
            const showEmpty = opts.showEmpty !== false;
            if (!append) artistsGrid.innerHTML = '';
            const emptyNode = artistsGrid.querySelector('[data-empty="1"]');
            if (emptyNode) emptyNode.remove();

            const list = Array.isArray(artists) ? artists : [];
            if (list.length === 0) {
                if (!append && showEmpty) {
                    const empty = document.createElement('div');
                    empty.dataset.empty = '1';
                    empty.className = 'col-span-full text-center py-6 text-sm text-material-text-secondary';
                    empty.innerText = '暂无歌手';
                    artistsGrid.appendChild(empty);
                }
                return;
            }

            for (const a of list) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-left group';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl transition px-3 py-3 h-full flex items-center';
                const name = document.createElement('div');
                name.className = 'text-sm font-medium text-material-text truncate';
                name.innerText = a?.name || '';

                wrap.appendChild(name);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    try {
                        if (a?.platform === 'kugou') {
                            const json = await fetch(`/kugou/artist/audios?id=${encodeURIComponent(a?.id || '')}&page=1&pagesize=30&sort=hot`, { credentials: 'same-origin' })
                                .then((r) => r.json())
                                .catch(() => null);
                            const raw = json?.data?.info
                                || json?.data?.songs
                                || json?.data?.song_list
                                || json?.data?.data
                                || json?.songs
                                || json?.data
                                || [];
                            const tracks = (Array.isArray(raw) ? raw : []).map(normalizeKuGouSongToTrack).filter(Boolean);
                            if (tracks.length) setQueue(tracks, 0);
                            navigateTo('/');
                            openListResults(`歌手：${a?.name || a?.id}`, tracks);
                            return;
                        }
                        const json = await fetch(`/netease/artist/top/song?id=${encodeURIComponent(a?.id || '')}`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const raw = json?.songs || json?.data?.songs || [];
                        const tracks = (Array.isArray(raw) ? raw : []).map(normalizeNetEaseSongToTrack).filter(Boolean);
                        if (tracks.length) setQueue(tracks, 0);
                        navigateTo('/');
                        openListResults(`歌手：${a?.name || a?.id}`, tracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取歌手歌曲失败：${msg}`);
                    }
                });

                artistsGrid.appendChild(btn);
            }
        }

        function renderHotArtists(artists) {
            if (!artistsHotGrid) return;
            const list = Array.isArray(artists) ? artists : [];
            artistsHotGrid.innerHTML = '';
            artistsHotGrid.classList.toggle('hidden', list.length === 0);
            const items = list.slice(0, 12);

            for (const a of items) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'group text-left';

                const wrap = document.createElement('div');
                wrap.className = 'bg-material-surface/50 hover:bg-material-surface border border-material-border/60 rounded-xl overflow-hidden transition p-2';

                const img = document.createElement('img');
                img.className = 'w-full aspect-square rounded-lg object-cover bg-material-text/10';
                img.alt = a?.name || 'artist';
                img.loading = 'lazy';
                img.src = proxify(a?.picUrl || '') || '';

                const name = document.createElement('div');
                name.className = 'mt-2 text-[11px] font-medium text-material-text text-center line-clamp-2 min-h-[28px]';
                name.innerText = a?.name || '';

                wrap.appendChild(img);
                wrap.appendChild(name);
                btn.appendChild(wrap);

                btn.addEventListener('click', async () => {
                    try {
                        if (a?.platform === 'kugou') {
                            const json = await fetch(`/kugou/artist/audios?id=${encodeURIComponent(a?.id || '')}&page=1&pagesize=30&sort=hot`, { credentials: 'same-origin' })
                                .then((r) => r.json())
                                .catch(() => null);
                            const raw = json?.data?.info
                                || json?.data?.songs
                                || json?.data?.song_list
                                || json?.data?.data
                                || json?.songs
                                || json?.data
                                || [];
                            const tracks = (Array.isArray(raw) ? raw : []).map(normalizeKuGouSongToTrack).filter(Boolean);
                            if (tracks.length) setQueue(tracks, 0);
                            navigateTo('/');
                            openListResults(`歌手：${a?.name || a?.id}`, tracks);
                            return;
                        }
                        const json = await fetch(`/netease/artist/top/song?id=${encodeURIComponent(a?.id || '')}`, { credentials: 'same-origin' })
                            .then((r) => r.json())
                            .catch(() => null);
                        const raw = json?.songs || json?.data?.songs || [];
                        const tracks = (Array.isArray(raw) ? raw : []).map(normalizeNetEaseSongToTrack).filter(Boolean);
                        if (tracks.length) setQueue(tracks, 0);
                        navigateTo('/');
                        openListResults(`歌手：${a?.name || a?.id}`, tracks);
                    } catch (err) {
                        const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                        alert(`获取歌手歌曲失败：${msg}`);
                    }
                });

                artistsHotGrid.appendChild(btn);
            }
        }

        let artistsBrowseState = {
            initial: '',
            page: 1,
            loading: false,
            hasMore: true,
            seen: new Set(),
            inited: false,
        };

        function showArtistsHint() {
            if (!artistsGrid) return;
            artistsGrid.innerHTML = '';
            const hint = document.createElement('div');
            hint.dataset.empty = '1';
            hint.className = 'col-span-full text-center py-10 text-sm text-material-text-secondary';
            hint.innerText = '点击上方字母查看歌手';
            artistsGrid.appendChild(hint);
        }

        function setArtistsBrowseLoading(loading) {
            if (!artistsLoadMore) return;
            artistsLoadMore.disabled = !!loading;
            if (loading) artistsLoadMore.classList.add('opacity-60');
            else artistsLoadMore.classList.remove('opacity-60');
        }

        function setArtistsLoadMoreVisible(visible) {
            if (!artistsLoadMore) return;
            artistsLoadMore.classList.toggle('hidden', !visible);
        }

        function setArtistsInitialActive(initial) {
            if (!artistsInitialBar) return;
            const items = Array.from(artistsInitialBar.querySelectorAll('button[data-initial]'));
            for (const btn of items) {
                const isActive = String(btn.dataset.initial || '') === String(initial || '');
                btn.classList.toggle('bg-material-primary/15', isActive);
                btn.classList.toggle('text-material-primary', isActive);
                btn.classList.toggle('bg-material-text/5', !isActive);
                btn.classList.toggle('text-material-text-secondary', !isActive);
            }
        }

        function initArtistsInitialBar() {
            if (!artistsInitialBar) return;
            if (artistsBrowseState.inited) return;
            artistsBrowseState.inited = true;

            artistsInitialBar.innerHTML = '';
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            for (const ch of letters) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.initial = ch;
                btn.className = 'w-10 h-10 grid place-items-center text-sm rounded-lg transition bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text';
                btn.innerText = ch;
                btn.addEventListener('click', async () => {
                    if (artistsBrowseState.loading) return;
                    artistsBrowseState.initial = ch;
                    setArtistsInitialActive(ch);
                    await loadArtistsByInitial(ch, { reset: true });
                });
                artistsInitialBar.appendChild(btn);
            }

            {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.dataset.initial = 'other';
                btn.className = 'w-10 h-10 grid place-items-center text-sm rounded-lg transition bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text';
                btn.innerText = '其他';
                btn.addEventListener('click', async () => {
                    if (artistsBrowseState.loading) return;
                    artistsBrowseState.initial = 'other';
                    setArtistsInitialActive('other');
                    await loadArtistsByInitial('other', { reset: true });
                });
                artistsInitialBar.appendChild(btn);
            }

            setArtistsInitialActive(artistsBrowseState.initial);

            if (artistsLoadMore) {
                artistsLoadMore.addEventListener('click', async () => {
                    await loadArtistsByInitial(artistsBrowseState.initial, { reset: false });
                });
            }
        }

        const artistsByInitialCache = new Map();

        function normalizeKuGouSingerList(json) {
            const data = json?.data || json;
            const info = Array.isArray(data?.info) ? data.info : null;
            const out = [];

            const pushOne = (it, groupTitle) => {
                const id = it?.singerid || it?.author_id || it?.SingerId || it?.AuthorID || it?.id || '';
                const name = it?.singername || it?.SingerName || it?.author_name || it?.AuthorName || it?.name || '';
                const rawPic = it?.imgurl || it?.pic || it?.avatar || it?.Image || '';
                const picUrl = String(rawPic || '').replace(/\{size\}/g, '400');
                const fin = (it?.Findex || it?.findex || it?.FIndex || it?.index || it?.Index || '') + '';
                const title = String(groupTitle || '').trim();
                const initial = title ? (title === '热门' ? '热门' : title.toUpperCase()) : (fin ? fin.trim().slice(0, 1).toUpperCase() : '');
                out.push({ platform: 'kugou', id: String(id || ''), name: String(name || ''), picUrl: String(picUrl || ''), initial });
            };

            if (info) {
                for (const group of info) {
                    const title = group?.title;
                    const singers = Array.isArray(group?.singer) ? group.singer : [];
                    if (singers.length) {
                        for (const it of singers) pushOne(it, title);
                        continue;
                    }
                    pushOne(group, title);
                }
                return out.filter((x) => x && x.id && x.name);
            }

            const rows = Array.isArray(data?.list) ? data.list : (Array.isArray(data?.lists) ? data.lists : []);
            if (!Array.isArray(rows)) return [];
            for (const it of rows) pushOne(it, '');
            return out.filter((x) => x && x.id && x.name);
        }

        async function fetchKuGouArtistsByInitial(initial, page, pagesize) {
            const raw = String(initial || '');
            const letter = raw.toUpperCase();
            if (!letter) return { items: [], total: 0 };
            const isOther = raw.toLowerCase() === 'other';

            const ALL_KEY = '__ALL__';
            if (!artistsByInitialCache.has(ALL_KEY)) {
                const json = await fetch(
                    `/kugou/artist/lists?hotsize=200&type=0&sextypes=0&musician=0`,
                    { credentials: 'same-origin' },
                )
                    .then((r) => r.json())
                    .catch(() => null);
                const all = normalizeKuGouSingerList(json);
                artistsByInitialCache.set(ALL_KEY, all);
            }

            const all = artistsByInitialCache.get(ALL_KEY) || [];
            const filtered = all.filter((a) => {
                const ini = String(a?.initial || '').trim();
                const up = ini.toUpperCase();
                if (isOther) {
                    if (ini === '热门') return false;
                    return !(up.length === 1 && up >= 'A' && up <= 'Z');
                }
                return up === letter;
            });

            const start = (Number(page) - 1) * Number(pagesize);
            const end = start + Number(pagesize);
            return { items: filtered.slice(start, end), total: filtered.length };
        }

        async function loadArtistsByInitial(initial, opts = {}) {
            if (!artistsGrid) return;
            if (artistsBrowseState.loading) return;
            const reset = !!opts.reset;
            if (reset) {
                artistsBrowseState.page = 1;
                artistsBrowseState.hasMore = true;
                artistsBrowseState.seen = new Set();
                renderArtists([], { append: false, showEmpty: false });
            }
            if (!artistsBrowseState.hasMore) return;

            artistsBrowseState.loading = true;
            setArtistsBrowseLoading(true);

            try {
                const page = artistsBrowseState.page;
                const kgPageSize = 50;
                const { items: kgItems, total: kgTotal } = await fetchKuGouArtistsByInitial(initial, page, kgPageSize);

                const merged = [...kgItems].filter((a) => {
                    const key = a && a.platform ? `${a.platform}:${a.id}` : '';
                    if (!key) return false;
                    if (artistsBrowseState.seen.has(key)) return false;
                    artistsBrowseState.seen.add(key);
                    return true;
                });

                renderArtists(merged, { append: !reset, showEmpty: true });

                artistsBrowseState.page += 1;
                artistsBrowseState.hasMore = (page * kgPageSize) < Number(kgTotal || 0);
                setArtistsLoadMoreVisible(artistsBrowseState.hasMore);
            } catch {
                if (reset) renderArtists([], { append: false, showEmpty: true });
                setArtistsLoadMoreVisible(false);
            } finally {
                artistsBrowseState.loading = false;
                setArtistsBrowseLoading(false);
            }
        }

        const LOCAL_PLAYLISTS_KEY = 'magicMusic_localPlaylists_v1';
        const DEFAULT_LOCAL_PLAYLIST_ID = 'magicMusic_defaultPlaylist_v1';

        function getLocalPlaylists() {
            const raw = localStorage.getItem(LOCAL_PLAYLISTS_KEY);
            if (!raw) return [];
            try {
                const parsed = JSON.parse(raw);
                if (!Array.isArray(parsed)) return [];
                return parsed.filter((p) => p && typeof p === 'object' && p.id && p.name).map((p) => ({
                    id: String(p.id),
                    name: String(p.name),
                    tracks: Array.isArray(p.tracks) ? p.tracks.filter(Boolean) : [],
                    created: p.created ? String(p.created) : '',
                }));
            } catch {
                return [];
            }
        }

        function saveLocalPlaylists(list) {
            const next = Array.isArray(list) ? list : [];
            localStorage.setItem(LOCAL_PLAYLISTS_KEY, JSON.stringify(next));
        }

        function ensureDefaultLocalPlaylist() {
            const playlists = getLocalPlaylists();
            const found = playlists.find((p) => String(p.id) === DEFAULT_LOCAL_PLAYLIST_ID) || playlists.find((p) => String(p.name) === DEFAULT_PLAYLIST_NAME);
            if (found) return String(found.id);
            const now = new Date().toISOString();
            const pl = { id: DEFAULT_LOCAL_PLAYLIST_ID, name: DEFAULT_PLAYLIST_NAME, tracks: [], created: now };
            const next = [pl, ...playlists];
            saveLocalPlaylists(next);
            renderLocalPlaylists();
            return pl.id;
        }

        function updateUserPlaylistsSummary() {
            if (!userPlaylistsSummary) return;
            const playlists = getLocalPlaylists();
            const label = currentUser && currentUser.id ? '云端歌单' : '本地歌单';
            userPlaylistsSummary.innerText = `${label}：${playlists.length}`;
        }

        function renderLocalPlaylists() {
            const playlists = getLocalPlaylists();
            const targets = [createdPlaylistsList, userCreatedPlaylistsList].filter(Boolean);
            if (targets.length === 0) return;

            targets.forEach((el) => {
                el.innerHTML = '';
            });

            if (playlists.length === 0) {
                targets.forEach((el) => {
                    const empty = document.createElement('div');
                    empty.className = 'px-3 py-2 text-xs text-material-text-secondary';
                    empty.innerText = '还没有创建歌单';
                    el.appendChild(empty);
                });
                updateUserPlaylistsSummary();
                return;
            }

            for (const pl of playlists) {
                targets.forEach((el) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group';
                    btn.innerHTML = `<span class="material-icons text-[20px]">queue_music</span><span class="text-sm font-medium truncate">${pl.name}</span>`;
                    btn.addEventListener('click', () => {
                        const tracks = Array.isArray(pl.tracks) ? pl.tracks.filter(Boolean) : [];
                        setQueue(tracks, 0);
                        openListResults(`歌单：${pl.name}`, tracks);
                    });
                    el.appendChild(btn);
                });
            }
            updateUserPlaylistsSummary();
        }

        async function fetchServerPlaylists() {
            try {
                const data = await apiRequest('/api/user/playlists', { method: 'GET' });
                return Array.isArray(data.playlists) ? data.playlists : [];
            } catch {
                return [];
            }
        }

        async function ensureDefaultServerPlaylistId() {
            if (!(currentUser && currentUser.id)) {
                defaultServerPlaylistId = '';
                return '';
            }
            if (defaultServerPlaylistId) return defaultServerPlaylistId;
            const list = await fetchServerPlaylists();
            const found = Array.isArray(list) ? list.find((p) => String(p?.name || '') === DEFAULT_PLAYLIST_NAME) : null;
            if (found && found.id) {
                defaultServerPlaylistId = String(found.id);
                return defaultServerPlaylistId;
            }
            const created = await apiRequest('/api/user/playlists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: DEFAULT_PLAYLIST_NAME }),
            }).catch(() => null);
            const pid = created && created.playlist && created.playlist.id ? String(created.playlist.id) : '';
            if (pid) {
                defaultServerPlaylistId = pid;
                return defaultServerPlaylistId;
            }
            defaultServerPlaylistId = '';
            return '';
        }

        function setUserPlaylistsSummary(label, count) {
            if (!userPlaylistsSummary) return;
            userPlaylistsSummary.innerText = `${label}：${Number(count) || 0}`;
        }

        async function renderCreatedPlaylists() {
            const targets = [createdPlaylistsList, userCreatedPlaylistsList].filter(Boolean);
            if (targets.length === 0) return;
            if (!(currentUser && currentUser.id)) {
                renderLocalPlaylists();
                return;
            }

            const playlists = await fetchServerPlaylists();
            targets.forEach((el) => {
                el.innerHTML = '';
            });

            if (!playlists.length) {
                targets.forEach((el) => {
                    const empty = document.createElement('div');
                    empty.className = 'px-3 py-2 text-xs text-material-text-secondary';
                    empty.innerText = '还没有创建歌单';
                    el.appendChild(empty);
                });
                setUserPlaylistsSummary('云端歌单', 0);
                return;
            }

            for (const pl of playlists) {
                targets.forEach((el) => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'w-full flex items-center gap-3 px-3 py-2 text-material-text-secondary hover:text-material-text hover:bg-material-text/5 rounded-md transition-colors group';
                    btn.innerHTML = `<span class="material-icons text-[20px]">queue_music</span><span class="text-sm font-medium truncate">${pl?.name || ''}</span>`;
                    btn.addEventListener('click', () => {
                        const tracks = Array.isArray(pl?.tracks) ? pl.tracks.map(sanitizeTrack).filter(Boolean) : [];
                        setQueue(tracks, 0);
                        openListResults(`歌单：${pl?.name || ''}`, tracks);
                    });
                    el.appendChild(btn);
                });
            }
            setUserPlaylistsSummary('云端歌单', playlists.length);
        }

        function createLocalPlaylist(name) {
            const nm = String(name || '').trim();
            if (!nm) return null;
            const playlists = getLocalPlaylists();
            const pl = { id: String(Date.now()), name: nm, tracks: [], created: new Date().toISOString() };
            playlists.push(pl);
            saveLocalPlaylists(playlists);
            renderLocalPlaylists();
            return pl;
        }

        function updateLocalPlaylistName(playlistId, name) {
            const nm = String(name || '').trim();
            if (!nm) return;
            const playlists = getLocalPlaylists();
            const idx = playlists.findIndex((p) => String(p.id) === String(playlistId));
            if (idx < 0) return;
            playlists[idx] = { ...playlists[idx], name: nm };
            saveLocalPlaylists(playlists);
            renderLocalPlaylists();
        }

        function deleteLocalPlaylist(playlistId) {
            const playlists = getLocalPlaylists();
            const next = playlists.filter((p) => String(p.id) !== String(playlistId));
            saveLocalPlaylists(next);
            renderLocalPlaylists();
        }

        async function renameServerPlaylist(playlistId, name) {
            const nm = String(name || '').trim();
            if (!nm) return;
            await apiRequest('/api/user/playlists/rename', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playlistId: String(playlistId), name: nm }),
            });
        }

        async function deleteServerPlaylist(playlistId) {
            await apiRequest('/api/user/playlists/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playlistId: String(playlistId) }),
            });
        }

        function clearPlaylistEditing() {
            playlistEditing = null;
            playlistEditingName = '';
        }

        function clearPlaylistDeleting() {
            playlistDeleting = null;
        }

        function isEditing(scope, id) {
            return !!playlistEditing && playlistEditing.scope === scope && String(playlistEditing.id) === String(id);
        }

        function isDeleting(scope, id) {
            return !!playlistDeleting && playlistDeleting.scope === scope && String(playlistDeleting.id) === String(id);
        }

        function addTrackToPlaylist(playlistId, track) {
            if (!track || !playlistId) return;
            const playlists = getLocalPlaylists();
            const idx = playlists.findIndex((p) => String(p.id) === String(playlistId));
            if (idx < 0) return;
            const pl = playlists[idx];
            const tracks = Array.isArray(pl.tracks) ? pl.tracks : [];
            const key = `${track.platform || ''}:${String(track.id || '')}`;
            const exists = tracks.some((t) => `${t?.platform || ''}:${String(t?.id || '')}` === key);
            if (!exists) tracks.unshift(track);
            playlists[idx] = { ...pl, tracks };
            saveLocalPlaylists(playlists);
            renderLocalPlaylists();
        }

        function removeTrackFromPlaylist(playlistId, track) {
            if (!track || !playlistId) return;
            const playlists = getLocalPlaylists();
            const idx = playlists.findIndex((p) => String(p.id) === String(playlistId));
            if (idx < 0) return;
            const pl = playlists[idx];
            const tracks = Array.isArray(pl.tracks) ? pl.tracks : [];
            const key = `${track.platform || ''}:${String(track.id || '')}`;
            const nextTracks = tracks.filter((t) => `${t?.platform || ''}:${String(t?.id || '')}` !== key);
            playlists[idx] = { ...pl, tracks: nextTracks };
            saveLocalPlaylists(playlists);
            renderLocalPlaylists();
        }

        function showCreatePlaylistForm(which) {
            if (which === 'sidebar') {
                if (!sidebarCreatePlaylistForm || !sidebarPlaylistNameInput) return;
                sidebarCreatePlaylistForm.classList.remove('hidden');
                sidebarPlaylistNameInput.value = '';
                setTimeout(() => sidebarPlaylistNameInput.focus(), 0);
                return;
            }
            if (!userCreatePlaylistForm || !userPlaylistNameInput) return;
            userCreatePlaylistForm.classList.remove('hidden');
            userPlaylistNameInput.value = '';
            setTimeout(() => userPlaylistNameInput.focus(), 0);
        }

        function hideCreatePlaylistForm(which) {
            if (which === 'sidebar') {
                if (sidebarCreatePlaylistForm) sidebarCreatePlaylistForm.classList.add('hidden');
                return;
            }
            if (userCreatePlaylistForm) userCreatePlaylistForm.classList.add('hidden');
        }

        async function submitCreatePlaylist(name) {
            const nm = String(name || '').trim();
            if (!nm || nm.length > 40) {
                alert('歌单名称不合法');
                return false;
            }
            if (currentUser && currentUser.id) {
                await apiRequest('/api/user/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: nm }),
                });
                await renderCreatedPlaylists();
                return true;
            }
            createLocalPlaylist(nm);
            return true;
        }

        function isPlaylistSelectModalOpen() {
            return !!playlistSelectModal && !playlistSelectModal.classList.contains('hidden');
        }

        function closePlaylistSelectModal() {
            if (!playlistSelectModal) return;
            playlistSelectModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        async function renderPlaylistSelectModal() {
            if (!playlistSelectList || !playlistSelectEmpty) return;
            playlistSelectList.innerHTML = '';
            const authed = !!(currentUser && currentUser.id);
            const scope = authed ? 'server' : 'local';
            const playlists = authed ? await fetchServerPlaylists() : getLocalPlaylists();
            const list = Array.isArray(playlists) ? playlists : [];

            if (!list.length) {
                playlistSelectEmpty.classList.remove('hidden');
                return;
            }
            playlistSelectEmpty.classList.add('hidden');

            for (const pl of list) {
                const id = pl && pl.id ? String(pl.id) : '';
                if (!id) continue;
                const name = pl && pl.name ? String(pl.name) : '';

                const row = document.createElement('div');
                row.className = 'px-4 py-3 flex items-start gap-3';

                const icon = document.createElement('span');
                icon.className = 'material-icons text-material-primary shrink-0 mt-0.5';
                icon.innerText = 'queue_music';

                const mid = document.createElement('div');
                mid.className = 'min-w-0 flex-1';

                const right = document.createElement('div');
                right.className = 'flex items-center gap-2 shrink-0';

                if (isEditing(scope, id)) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full text-sm rounded-md px-3 py-2 bg-material-text/5 text-material-text focus:outline-none focus:bg-material-text/10';
                    input.value = playlistEditingName || name;

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-2 mt-2';

                    const save = document.createElement('button');
                    save.type = 'button';
                    save.className = 'text-xs px-3 py-2 rounded-full bg-material-primary text-material-on-primary hover:bg-material-primary/80 transition';
                    save.innerText = '保存';

                    const cancel = document.createElement('button');
                    cancel.type = 'button';
                    cancel.className = 'text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition';
                    cancel.innerText = '取消';

                    save.addEventListener('click', async () => {
                        const nextName = String(input.value || '').trim();
                        try {
                            if (scope === 'server') await renameServerPlaylist(id, nextName);
                            else updateLocalPlaylistName(id, nextName);
                            clearPlaylistEditing();
                            await renderCreatedPlaylists();
                            await renderPlaylistSelectModal();
                        } catch (err) {
                            alert(err instanceof Error ? err.message : '保存失败');
                        }
                    });
                    cancel.addEventListener('click', async () => {
                        clearPlaylistEditing();
                        await renderPlaylistSelectModal();
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') save.click();
                        if (e.key === 'Escape') cancel.click();
                    });

                    actions.appendChild(save);
                    actions.appendChild(cancel);
                    mid.appendChild(input);
                    mid.appendChild(actions);
                } else if (isDeleting(scope, id)) {
                    const title = document.createElement('div');
                    title.className = 'text-sm font-medium text-material-text truncate';
                    title.innerText = `删除「${name || '未命名'}」？`;

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center gap-2 mt-2';

                    const del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'text-xs px-3 py-2 rounded-full bg-red-600 text-white hover:bg-red-500 transition';
                    del.innerText = '删除';

                    const cancel = document.createElement('button');
                    cancel.type = 'button';
                    cancel.className = 'text-xs px-3 py-2 rounded-full bg-material-text/5 text-material-text-secondary hover:bg-material-text/10 hover:text-material-text transition';
                    cancel.innerText = '取消';

                    del.addEventListener('click', async () => {
                        try {
                            if (scope === 'server') await deleteServerPlaylist(id);
                            else deleteLocalPlaylist(id);
                            clearPlaylistDeleting();
                            await renderCreatedPlaylists();
                            await renderPlaylistSelectModal();
                        } catch (err) {
                            alert(err instanceof Error ? err.message : '删除失败');
                        }
                    });
                    cancel.addEventListener('click', async () => {
                        clearPlaylistDeleting();
                        await renderPlaylistSelectModal();
                    });

                    actions.appendChild(del);
                    actions.appendChild(cancel);
                    mid.appendChild(title);
                    mid.appendChild(actions);
                } else {
                    const title = document.createElement('div');
                    title.className = 'text-sm font-medium text-material-text truncate';
                    title.innerText = name || '未命名歌单';
                    mid.appendChild(title);

                    const primary = document.createElement('button');
                    primary.type = 'button';
                    primary.className = 'text-xs px-3 py-2 rounded-full bg-material-primary/10 text-material-primary hover:bg-material-primary/15 transition';
                    primary.innerText = currentTrack ? '加入' : '打开';

                    const edit = document.createElement('button');
                    edit.type = 'button';
                    edit.className = 'w-9 h-9 rounded-full bg-material-text/5 hover:bg-material-text/10 text-material-text-secondary hover:text-material-text transition flex items-center justify-center';
                    edit.title = '重命名';
                    edit.innerHTML = '<span class="material-icons text-[18px]">edit</span>';

                    const del = document.createElement('button');
                    del.type = 'button';
                    del.className = 'w-9 h-9 rounded-full bg-material-text/5 hover:bg-material-text/10 text-material-text-secondary hover:text-material-text transition flex items-center justify-center';
                    del.title = '删除';
                    del.innerHTML = '<span class="material-icons text-[18px]">delete</span>';

                    primary.addEventListener('click', async () => {
                        if (!currentTrack) {
                            const tracks = Array.isArray(pl?.tracks) ? pl.tracks.map(sanitizeTrack).filter(Boolean) : [];
                            setQueue(tracks, 0);
                            openListResults(`歌单：${name || ''}`, tracks);
                            closePlaylistSelectModal();
                            return;
                        }
                        try {
                            if (scope === 'server') {
                                await apiRequest('/api/user/playlists/add', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ playlistId: String(id), track: sanitizeTrack(currentTrack) }),
                                });
                                await renderCreatedPlaylists();
                            } else {
                                addTrackToPlaylist(id, currentTrack);
                            }
                            closePlaylistSelectModal();
                        } catch (err) {
                            alert(err instanceof Error ? err.message : '加入失败');
                        }
                    });

                    edit.addEventListener('click', async () => {
                        clearPlaylistDeleting();
                        playlistEditing = { scope, id };
                        playlistEditingName = name;
                        await renderPlaylistSelectModal();
                    });

                    del.addEventListener('click', async () => {
                        clearPlaylistEditing();
                        playlistDeleting = { scope, id };
                        await renderPlaylistSelectModal();
                    });

                    right.appendChild(primary);
                    right.appendChild(edit);
                    right.appendChild(del);
                }

                row.appendChild(icon);
                row.appendChild(mid);
                row.appendChild(right);
                playlistSelectList.appendChild(row);
            }
        }

        function openPlaylistSelectModal() {
            if (!playlistSelectModal) return;
            clearPlaylistEditing();
            clearPlaylistDeleting();
            if (playlistSelectCreateName) playlistSelectCreateName.value = '';
            renderPlaylistSelectModal().catch(() => {});
            playlistSelectModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            if (playlistSelectCreateName) setTimeout(() => playlistSelectCreateName.focus(), 0);
        }

        function initLocalPlaylists() {
            renderCreatedPlaylists();

            if (createPlaylistBtn) createPlaylistBtn.addEventListener('click', () => showCreatePlaylistForm('sidebar'));
            if (userCreatePlaylistBtn) userCreatePlaylistBtn.addEventListener('click', () => showCreatePlaylistForm('user'));

            if (sidebarPlaylistCreateCancel) sidebarPlaylistCreateCancel.addEventListener('click', () => hideCreatePlaylistForm('sidebar'));
            if (userPlaylistCreateCancel) userPlaylistCreateCancel.addEventListener('click', () => hideCreatePlaylistForm('user'));

            if (sidebarPlaylistCreateConfirm) {
                sidebarPlaylistCreateConfirm.addEventListener('click', async () => {
                    try {
                        const ok = await submitCreatePlaylist(sidebarPlaylistNameInput ? sidebarPlaylistNameInput.value : '');
                        if (ok) hideCreatePlaylistForm('sidebar');
                    } catch (err) {
                        alert(err instanceof Error ? err.message : '创建失败');
                    }
                });
            }

            if (userPlaylistCreateConfirm) {
                userPlaylistCreateConfirm.addEventListener('click', async () => {
                    try {
                        const ok = await submitCreatePlaylist(userPlaylistNameInput ? userPlaylistNameInput.value : '');
                        if (ok) hideCreatePlaylistForm('user');
                    } catch (err) {
                        alert(err instanceof Error ? err.message : '创建失败');
                    }
                });
            }

            if (sidebarPlaylistNameInput) {
                sidebarPlaylistNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && sidebarPlaylistCreateConfirm) sidebarPlaylistCreateConfirm.click();
                    if (e.key === 'Escape') hideCreatePlaylistForm('sidebar');
                });
            }

            if (userPlaylistNameInput) {
                userPlaylistNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && userPlaylistCreateConfirm) userPlaylistCreateConfirm.click();
                    if (e.key === 'Escape') hideCreatePlaylistForm('user');
                });
            }

            if (userAddCurrentToPlaylistBtn) {
                userAddCurrentToPlaylistBtn.addEventListener('click', () => openPlaylistSelectModal());
            }

            if (playlistSelectClose) playlistSelectClose.addEventListener('click', closePlaylistSelectModal);
            if (playlistSelectBackdrop) playlistSelectBackdrop.addEventListener('click', closePlaylistSelectModal);

            if (playlistSelectCreateBtn) {
                playlistSelectCreateBtn.addEventListener('click', async () => {
                    try {
                        const ok = await submitCreatePlaylist(playlistSelectCreateName ? playlistSelectCreateName.value : '');
                        if (!ok) return;
                        if (playlistSelectCreateName) {
                            playlistSelectCreateName.value = '';
                            setTimeout(() => playlistSelectCreateName.focus(), 0);
                        }
                        await renderPlaylistSelectModal();
                    } catch (err) {
                        alert(err instanceof Error ? err.message : '创建失败');
                    }
                });
            }

            if (playlistSelectCreateName) {
                playlistSelectCreateName.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && playlistSelectCreateBtn) playlistSelectCreateBtn.click();
                    if (e.key === 'Escape') closePlaylistSelectModal();
                });
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        async function initRecommendations() {
            const tasks = [
                fetch('/kugou/fm/recommend', { credentials: 'same-origin' })
                    .then((r) => r.json())
                    .then((j) => {
                        const rows = Array.isArray(j?.data) ? j.data : [];
                        const allGuessRaw = rows.flatMap((row) => (Array.isArray(row?.rcmdlist) ? row.rcmdlist : []));
                        let guessTracks = allGuessRaw
                            .map(normalizeKuGouSongToTrack)
                            .filter(Boolean)
                            .filter((t, idx, arr) => idx === arr.findIndex((x) => trackKey(x) === trackKey(t)));
                        
                        // Shuffle to ensure variety
                        guessTracks = shuffleArray(guessTracks).slice(0, 40);
                        
                        homeGuessTracks = guessTracks;
                        if (homeCardGuessPlay && guessTracks[0] && homeCardGuessPlay.getAttribute('data-mm-home-bound') !== '1') {
                            homeCardGuessPlay.setAttribute('data-mm-home-bound', '1');
                            setupTrackPlayButton(homeCardGuessPlay, guessTracks[0], guessTracks, 0, 'home:guess');
                        }
                        if (homeCardGuessSub) {
                            const first = guessTracks[0];
                            homeCardGuessSub.innerText = first ? `共 ${guessTracks.length} 首 · ${first.name || ''}${first.artist ? ' · ' + first.artist : ''}` : '暂无推荐';
                        }
                        const out = rows.map((row) => ({
                            name: '推荐电台',
                            classid: row?.classid,
                            rcmdlist: Array.isArray(row?.rcmdlist) ? row.rcmdlist : [],
                        }));
                        renderRadioRecommends(out);
                    })
                    .catch(() => {
                        homeGuessTracks = [];
                        if (homeCardGuessSub) homeCardGuessSub.innerText = '暂无推荐';
                        renderRadioRecommends([]);
                    }),
                (async () => {
                    const [neRes, kgRes] = await Promise.all([
                        fetch('/netease/personalized?limit=10', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                        fetch('/kugou/top/playlist?category_id=0&pagesize=10&page=1', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                    ]);
                    const neList = Array.isArray(neRes?.result) ? neRes.result : [];
                    const neOut = neList.map((it) => ({
                        platform: 'netease',
                        id: it?.id || '',
                        name: it?.name || '',
                        picUrl: it?.picUrl || it?.coverImgUrl || '',
                        playCount: it?.playCount || 0,
                    })).filter((x) => x && x.id);
                    const kgList = Array.isArray(kgRes?.data?.special_list) ? kgRes.data.special_list : [];
                    const kgOut = kgList.map((it) => ({
                        platform: 'kugou',
                        id: it?.global_collection_id || it?.specialid || '',
                        name: it?.specialname || '',
                        picUrl: it?.imgurl || it?.pic || it?.flexible_cover || '',
                        playCount: it?.play_count || 0,
                    })).filter((x) => x && x.id);
                    const merged = [...kgOut, ...neOut].slice(0, 20);
                    renderRecommendPlaylists(merged);
                })().catch(() => renderRecommendPlaylists([])),
                (async () => {
                    const [neRes, kgRes] = await Promise.all([
                        fetch('/netease/personalized/newsong?limit=20', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                        fetch('/kugou/everyday/recommend?platform=android', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                    ]);
                    const neList = Array.isArray(neRes?.result) ? neRes.result : [];
                    const kgList = Array.isArray(kgRes?.data?.song_list) ? kgRes.data.song_list : [];
                    const merged = [...kgList, ...neList].slice(0, 40);
                    renderNewSongs(merged);
                    const tracks = merged
                        .map((it) => normalizeAnySongToTrack(it?.song || it))
                        .filter(Boolean);
                    homeDailyTracks = shuffleArray(tracks).slice(0, 40);
                    if (homeCardDailyPlay && homeDailyTracks[0] && homeCardDailyPlay.getAttribute('data-mm-home-bound') !== '1') {
                        homeCardDailyPlay.setAttribute('data-mm-home-bound', '1');
                        setupTrackPlayButton(homeCardDailyPlay, homeDailyTracks[0], homeDailyTracks, 0, 'home:daily');
                    }
                    if (homeCardDailySub) {
                        const first = tracks[0];
                        homeCardDailySub.innerText = first ? `${first.name || ''}${first.artist ? ' · ' + first.artist : ''}` : '暂无推荐';
                    }
                    preloadDefaultTrack(tracks).catch(() => {});
                })().catch(() => {
                    homeDailyTracks = [];
                    if (homeCardDailySub) homeCardDailySub.innerText = '暂无推荐';
                    renderNewSongs([]);
                }),
                (async () => {
                    const [neRes, kgRes] = await Promise.all([
                        fetch('/netease/top/playlist?cat=%E5%85%A8%E9%83%A8&order=hot&limit=30&offset=0', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                        fetch('/kugou/top/playlist?category_id=0&pagesize=30&page=1', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                    ]);
                    const neList = Array.isArray(neRes?.playlists) ? neRes.playlists : (Array.isArray(neRes?.result) ? neRes.result : []);
                    const neOut = neList.map((it) => ({
                        platform: 'netease',
                        id: it?.id || '',
                        name: it?.name || '',
                        coverImgUrl: it?.coverImgUrl || it?.picUrl || '',
                        playCount: it?.playCount || 0,
                    })).filter((x) => x && x.id);
                    const kgList = Array.isArray(kgRes?.data?.special_list) ? kgRes.data.special_list : [];
                    const kgOut = kgList.map((it) => ({
                        platform: 'kugou',
                        id: it?.global_collection_id || it?.specialid || '',
                        name: it?.specialname || '',
                        coverImgUrl: it?.imgurl || it?.pic || it?.flexible_cover || '',
                        playCount: it?.play_count || 0,
                    })).filter((x) => x && x.id);
                    renderPlaylistSquare([...kgOut, ...neOut].slice(0, 30));
                })().catch(() => renderPlaylistSquare([])),
                (async () => {
                    const [neRes, kgRes] = await Promise.all([
                        fetch('/netease/toplist/detail', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                        fetch('/kugou/rank/list', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                    ]);
                    const neList = Array.isArray(neRes?.list) ? neRes.list : [];
                    const neOut = neList.slice(0, 12).map((it) => ({
                        platform: 'netease',
                        id: it?.id || '',
                        name: it?.name || '',
                        coverUrl: it?.coverImgUrl || it?.coverUrl || '',
                    })).filter((x) => x && x.id);
                    const kgRows = Array.isArray(kgRes?.data?.info) ? kgRes.data.info : (Array.isArray(kgRes?.data) ? kgRes.data : []);
                    const kgOut = kgRows.slice(0, 12).map((it) => ({
                        platform: 'kugou',
                        id: it?.rankid || it?.id || '',
                        name: it?.rankname || it?.name || '',
                        coverUrl: it?.imgurl || it?.pic || it?.cover || '',
                    })).filter((x) => x && x.id);
                    renderCharts([...kgOut, ...neOut]);
                })().catch(() => renderCharts([])),
                (async () => {
                    const kgRes = await fetch('/kugou/artist/lists?hotsize=30&type=0&sextypes=0&musician=0', { credentials: 'same-origin' })
                        .then((r) => r.json())
                        .catch(() => null);
                    const kgAll = normalizeKuGouSingerList(kgRes);
                    const kgHot = kgAll.filter((a) => String(a?.initial || '') === '热门');
                    renderHotArtists((kgHot.length ? kgHot : kgAll).slice(0, 30));
                })().catch(() => renderHotArtists([])),
                (async () => {
                    const [neCharts, kgCharts] = await Promise.all([
                        fetch('/netease/toplist/detail', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                        fetch('/kugou/rank/list', { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null),
                    ]);
                    const neList = Array.isArray(neCharts?.list) ? neCharts.list : [];
                    const neHot = neList.find((x) => String(x?.name || '').includes('热歌')) || neList[0];
                    const kgList = Array.isArray(kgCharts?.data?.info) ? kgCharts.data.info : (Array.isArray(kgCharts?.data) ? kgCharts.data : []);
                    const kgHot = kgList.find((x) => String(x?.rankname || x?.name || '').toUpperCase().includes('TOP')) || kgList[0];
                    const [neRes, kgRes] = await Promise.all([
                        neHot?.id ? fetch(`/netease/playlist/track/all?id=${encodeURIComponent(neHot.id)}&limit=30&offset=0`, { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null) : Promise.resolve(null),
                        kgHot?.rankid ? fetch(`/kugou/rank/audio?rankid=${encodeURIComponent(kgHot.rankid)}&page=1&pagesize=30`, { credentials: 'same-origin' }).then((r) => r.json()).catch(() => null) : Promise.resolve(null),
                    ]);
                    const neRaw = neRes?.songs || neRes?.data?.songs || [];
                    const kgRaw = kgRes?.data?.songs
                        || kgRes?.data?.info?.songs
                        || kgRes?.data?.song_list
                        || kgRes?.data?.songlist
                        || kgRes?.songs
                        || [];
                    const neTracks = (Array.isArray(neRaw) ? neRaw : []).map(normalizeNetEaseSongToTrack).filter(Boolean);
                    const kgTracks = (Array.isArray(kgRaw) ? kgRaw : []).map(normalizeKuGouSongToTrack).filter(Boolean);
                    renderTracksList(hotSongsList, [...kgTracks, ...neTracks].slice(0, 50), '暂无热歌');
                })().catch(() => renderTracksList(hotSongsList, [], '暂无热歌')),
            ];
            await Promise.allSettled(tasks);
        }

        async function doSearch(keywords) {
            const kw = (keywords || '').trim();
            if (!kw) return;
            try {
                const [neRes, kgRes] = await Promise.all([
                    fetch(`/netease/cloudsearch?keywords=${encodeURIComponent(kw)}&limit=20&offset=0&type=1`, { credentials: 'same-origin' })
                        .then((r) => r.json())
                        .catch(() => null),
                    fetch(`/kugou/search?keywords=${encodeURIComponent(kw)}&page=1&pagesize=20&type=song`, { credentials: 'same-origin' })
                        .then((r) => r.json())
                        .catch(() => null),
                ]);

                const ne = normalizeNetEaseSearch(neRes);
                const kg = normalizeKuGouSearch(kgRes);
                const seen = new Set();
                const merged = [...kg, ...ne].filter((t) => {
                    const key = t && t.platform ? `${t.platform}:${t.id}` : '';
                    if (!key) return false;
                    if (seen.has(key)) return false;
                    seen.add(key);
                    return true;
                });
                const items = merged.slice(0, 40);
                renderSearchResults(items, kw);
            } catch (err) {
                const msg = err instanceof Error && err.message ? err.message : '请确认后端服务已启动';
                alert(`搜索失败：${msg}`);
            }
        }

        if (searchResultsClose && searchResultsSection) {
            searchResultsClose.addEventListener('click', () => searchResultsSection.classList.add('hidden'));
        }

        if (searchInputDesktop) {
            searchInputDesktop.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') doSearch(searchInputDesktop.value);
            });
        }

        if (searchInputMobile) {
            searchInputMobile.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') doSearch(searchInputMobile.value);
            });
        }

        function scrollToSection(el) {
            if (!el) return;
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function setActiveNavByPath(pathname) {
            const path = pathname || window.location.pathname || '/';
            const desktopLinks = [navRecommend, navPlaylistSquare, navRadio, navArtists, navLiked, navDownloads, navRecent];
            const topTabs = [topTabRecommend, topTabPlaylists, topTabHot, topTabCharts, topTabArtists];
            const mobileTabs = [mobileTabRecommend, mobileTabPlaylists, mobileTabHot, mobileTabCharts, mobileTabArtists];
            const bottomNavLinks = [bottomNavHome, bottomNavPlaylists, bottomNavHot, bottomNavUser];

            const isPath = (p) => path === p;
            const isAnyPath = (...paths) => paths.includes(path);

            desktopLinks.forEach((el) => {
                if (!el) return;
                el.classList.remove('nav-active');
                el.classList.add('text-material-text-secondary');
            });
            topTabs.forEach((el) => {
                if (!el) return;
                el.classList.remove('text-material-text', 'font-bold', 'border-b-2', 'border-material-primary');
                el.classList.add('text-material-text-secondary', 'font-medium');
            });
            mobileTabs.forEach((el) => {
                if (!el) return;
                el.classList.remove('text-material-text', 'font-bold', 'border-b-2', 'border-material-primary');
                el.classList.add('text-material-text-secondary', 'font-medium');
            });
            bottomNavLinks.forEach((el) => {
                if (!el) return;
                el.classList.remove('text-material-primary', 'text-material-text');
                el.classList.add('text-material-text-secondary');
            });

            const markActive = (el) => {
                if (!el) return;
                if (el.closest('aside')) {
                    el.classList.add('nav-active');
                    el.classList.remove('text-material-text-secondary');
                } else {
                    el.classList.add('text-material-text', 'font-bold', 'border-b-2', 'border-material-primary');
                    el.classList.remove('text-material-text-secondary', 'font-medium');
                }
            };
            const markBottomActive = (el) => {
                if (!el) return;
                el.classList.add('text-material-primary');
                el.classList.remove('text-material-text-secondary', 'text-material-text');
            };

            if (isAnyPath('/', '/recommend')) {
                markActive(navRecommend);
                markActive(mobileTabRecommend);
                markActive(topTabRecommend);
                markBottomActive(bottomNavHome);
            } else if (isAnyPath('/playlists', '/playlist-square')) {
                markActive(navPlaylistSquare);
                markActive(mobileTabPlaylists);
                markActive(topTabPlaylists);
                markBottomActive(bottomNavPlaylists);
            } else if (isPath('/hot')) {
                markActive(navRadio);
                markActive(mobileTabHot);
                markActive(topTabHot);
                markBottomActive(bottomNavHot);
            } else if (isPath('/charts')) {
                markActive(mobileTabCharts);
                markActive(topTabCharts);
            } else if (isPath('/artists')) {
                markActive(navArtists);
                markActive(mobileTabArtists);
                markActive(topTabArtists);
            } else if (isPath('/favorites')) {
                markActive(navLiked);
                markBottomActive(bottomNavUser);
            } else if (isPath('/downloads')) {
                markActive(navDownloads);
                markBottomActive(bottomNavUser);
            } else if (isPath('/recent')) {
                markActive(navRecent);
                markBottomActive(bottomNavUser);
            } else if (isPath('/login')) {
                markBottomActive(bottomNavUser);
            }
        }

        function applyRoute(pathname) {
            const path = pathname || window.location.pathname || '/';
            const showRecommend = path === '/' || path === '/recommend';
            const showRadio = path === '/radio';
            const showSquare = path === '/playlist-square' || path === '/playlists';
            const showHot = path === '/hot';
            const showCharts = path === '/charts';
            const showArtists = path === '/artists';
            const showFav = path === '/favorites';
            const showDownloads = path === '/downloads';
            const showRecent = path === '/recent';
            const showLogin = path === '/login';
            const showPlayer = path === '/player';

            const toggle = (el, visible) => {
                if (!el) return;
                el.classList.toggle('hidden', !visible);
            };

            toggle(recommendPageSection, showRecommend);
            toggle(document.getElementById('radio-recommend-section'), showRadio);
            toggle(document.getElementById('playlist-square-section'), showSquare);
            toggle(document.getElementById('hot-songs-section'), showHot);
            toggle(document.getElementById('charts-section'), showCharts);
            toggle(document.getElementById('artists-section'), showArtists);
            toggle(document.getElementById('favorites-section'), showFav);
            toggle(document.getElementById('downloads-section'), showDownloads);
            toggle(document.getElementById('recent-section'), showRecent);
            toggle(loginPageSection, showLogin);
            toggle(playerPageSection, showPlayer);
            document.body.classList.toggle('mm-route-player', showPlayer);

            if (searchResultsSection) {
                searchResultsSection.classList.add('hidden');
            }

            const playerCoverOverlayIcon = document.getElementById('player-cover-overlay-icon');
            if (playerCoverOverlayIcon) {
                playerCoverOverlayIcon.innerText = showPlayer ? 'keyboard_arrow_down' : 'expand_less';
            }
        }

        function navigateTo(path) {
            if (!path) return;
            if (window.location.pathname === path) {
                applyRoute(path);
                setActiveNavByPath(path);
                if (path === '/artists') {
                    initArtistsInitialBar();
                    artistsBrowseState.initial = '';
                    artistsBrowseState.page = 1;
                    artistsBrowseState.hasMore = true;
                    artistsBrowseState.seen = new Set();
                    setArtistsInitialActive('');
                    setArtistsLoadMoreVisible(false);
                    showArtistsHint();
                }
                return;
            }
            window.history.pushState({}, '', path);
            applyRoute(path);
            setActiveNavByPath(path);
            if (path === '/artists') {
                initArtistsInitialBar();
                artistsBrowseState.initial = '';
                artistsBrowseState.page = 1;
                artistsBrowseState.hasMore = true;
                artistsBrowseState.seen = new Set();
                setArtistsInitialActive('');
                setArtistsLoadMoreVisible(false);
                showArtistsHint();
            }
        }

        window.addEventListener('popstate', () => {
            applyRoute(window.location.pathname);
            setActiveNavByPath(window.location.pathname);
            if (window.location.pathname === '/artists') {
                initArtistsInitialBar();
                artistsBrowseState.initial = '';
                artistsBrowseState.page = 1;
                artistsBrowseState.hasMore = true;
                artistsBrowseState.seen = new Set();
                setArtistsInitialActive('');
                setArtistsLoadMoreVisible(false);
                showArtistsHint();
            }
        });

        document.addEventListener('click', (e) => {
            if (!e || e.defaultPrevented) return;
            if (e.button !== 0) return;
            if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey) return;

            const a = e.target && e.target.closest ? e.target.closest('a') : null;
            if (!a) return;
            if (a.target && a.target !== '_self') return;
            if (a.hasAttribute('download')) return;

            const rawHref = a.getAttribute('href');
            if (!rawHref) return;
            const href = String(rawHref).trim();
            if (!href || href.startsWith('#') || href.startsWith('javascript:')) return;
            if (!href.startsWith('/')) return;

            let path = href;
            try {
                const url = new URL(href, window.location.origin);
                path = url.pathname || href;
            } catch {}

            const knownRoutes = new Set([
                '/',
                '/recommend',
                '/radio',
                '/playlist-square',
                '/playlists',
                '/hot',
                '/charts',
                '/artists',
                '/favorites',
                '/downloads',
                '/recent',
                '/login',
                '/player',
            ]);
            if (!knownRoutes.has(path)) return;

            e.preventDefault();
            navigateTo(path);
        });

        const historyBackBtn = document.getElementById('history-back-btn');
        const historyForwardBtn = document.getElementById('history-forward-btn');

        if (historyBackBtn) {
            historyBackBtn.addEventListener('click', () => {
                window.history.back();
            });
        }

        if (historyForwardBtn) {
            historyForwardBtn.addEventListener('click', () => {
                window.history.forward();
            });
        }

        if (brandHomeDesktop) {
            brandHomeDesktop.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/');
            });
        }

        if (brandHomeMobile) {
            brandHomeMobile.addEventListener('click', (e) => {
                if (e && e.preventDefault) e.preventDefault();
                navigateTo('/');
            });
        }

        if (userCenterTriggerDesktop) {
            userCenterTriggerDesktop.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/login');
            });
        }

        if (bottomNavHome) {
            bottomNavHome.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/');
            });
        }

        if (bottomNavUser) {
            bottomNavUser.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/login');
            });
        }

        if (navRecommend) {
            navRecommend.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/');
            });
        }
        if (navRadio) {
            navRadio.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/hot');
            });
        }
        if (navPlaylistSquare) {
            navPlaylistSquare.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/playlists');
            });
        }
        if (navArtists) {
            navArtists.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/artists');
            });
        }
        if (navLiked) {
            navLiked.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/favorites');
            });
        }
        if (navDownloads) {
            navDownloads.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/downloads');
            });
        }
        if (navRecent) {
            navRecent.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/recent');
            });
        }

        if (mobileTabRecommend) {
            mobileTabRecommend.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/');
            });
        }
        if (mobileTabPlaylists) {
            mobileTabPlaylists.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/playlists');
            });
        }
        if (mobileTabHot) {
            mobileTabHot.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/hot');
            });
        }
        if (mobileTabCharts) {
            mobileTabCharts.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/charts');
            });
        }
        if (mobileTabArtists) {
            mobileTabArtists.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/artists');
            });
        }

        if (topTabRecommend) {
            topTabRecommend.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/');
            });
        }
        if (topTabPlaylists) {
            topTabPlaylists.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/playlists');
            });
        }
        if (topTabHot) {
            topTabHot.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/hot');
            });
        }
        if (topTabCharts) {
            topTabCharts.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/charts');
            });
        }
        if (topTabArtists) {
            topTabArtists.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo('/artists');
            });
        }

        if (playBtn) {
            playBtn.addEventListener('click', async () => {
                try {
                    if (audio.src) {
                        if (audio.paused) await mmPlay('底栏播放按钮');
                        else audio.pause();
                        return;
                    }
                    if (currentTrack) {
                        await playTrack(currentTrack);
                        return;
                    }
                    const fallback = searchInputDesktop ? searchInputDesktop.value.trim() : '';
                    if (fallback) doSearch(fallback);
                } catch (err) {
                    const msg = err instanceof Error && err.message ? err.message : '后端未启动或资源不可用';
                    alert(`播放失败：${msg}`);
                } finally {
                    setPlayIcon(!!audio.src && !audio.paused);
                    updatePlayerPagePlayUI();
                }
            });
        }

        if (prevBtn) prevBtn.addEventListener('click', () => skip(-1));
        if (nextBtn) nextBtn.addEventListener('click', () => skip(1));
        if (repeatBtn) repeatBtn.addEventListener('click', cycleRepeatMode);
        if (shuffleBtn) shuffleBtn.addEventListener('click', toggleShuffle);

        if (playerDownloadBtn) {
            playerDownloadBtn.addEventListener('click', () => {
                downloadTrack(currentTrack);
            });
        }
        if (playerAddToPlaylistBtn) {
            playerAddToPlaylistBtn.addEventListener('click', async () => {
                if (!currentTrack) {
                    alert('暂无播放歌曲');
                    return;
                }
                try {
                    await toggleLikeForCurrent();
                } catch (err) {
                    alert(err instanceof Error ? err.message : '操作失败');
                } finally {
                    updateLikeButtonUI();
                    updatePlayerPageLikeUI();
                }
            });
        }

        const openPlayerPage = () => {
            if (window.location.pathname === '/player') {
                window.history.back();
            } else {
                navigateTo('/player');
            }
        };

        if (playerCover) {
            const coverWrap = playerCover.closest('.group');
            if (coverWrap) coverWrap.addEventListener('click', openPlayerPage);
        }
        if (playerTitle) playerTitle.addEventListener('click', openPlayerPage);
        if (playerArtist) playerArtist.addEventListener('click', openPlayerPage);

        if (playerPagePrev) playerPagePrev.addEventListener('click', () => skip(-1));
        if (playerPageNext) playerPageNext.addEventListener('click', () => skip(1));
        if (playerPageRepeat) playerPageRepeat.addEventListener('click', () => {
            cycleRepeatMode();
            updatePlayerPageModeUI();
        });
        if (playerPageShuffle) playerPageShuffle.addEventListener('click', () => {
            toggleShuffle();
            updatePlayerPageModeUI();
        });
        if (playerPagePlay) {
            playerPagePlay.addEventListener('click', async () => {
                try {
                    if (audio.src) {
                        if (audio.paused) await mmPlay('播放器页播放按钮');
                        else audio.pause();
                        return;
                    }
                    if (currentTrack) {
                        await playTrack(currentTrack);
                    }
                } catch (err) {
                    if (isAndroidApp) mmAlert(err instanceof Error ? err.message : '播放失败');
                } finally {
                    setPlayIcon(!!audio.src && !audio.paused);
                    updatePlayerPagePlayUI();
                }
            });
        }

        if (playerQueueBtn) playerQueueBtn.addEventListener('click', openQueueModal);
        if (queueModalBackdrop) queueModalBackdrop.addEventListener('click', closeQueueModal);
        if (queueModalClose) queueModalClose.addEventListener('click', closeQueueModal);
        if (queueModalWrap) queueModalWrap.addEventListener('click', (e) => {
            if (e.target === queueModalWrap) closeQueueModal();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            if (isQueueModalOpen()) closeQueueModal();
            else if (isPlaylistSelectModalOpen()) closePlaylistSelectModal();
        });
        if (playerPageLikeBtn) {
            playerPageLikeBtn.addEventListener('click', async () => {
                await toggleLikeForCurrent();
                updatePlayerPageLikeUI();
            });
        }
        if (playerPageDownloadBtn) {
            playerPageDownloadBtn.addEventListener('click', () => downloadTrack(currentTrack));
        }
        if (playerPageVolume) {
            playerPageVolume.addEventListener('input', () => {
                setVolume(Number(playerPageVolume.value));
            });
        }
        function seekRatioFromEvent(e, bar) {
            const rect = bar.getBoundingClientRect();
            const width = rect.width || 0;
            if (!width) return 0;
            const x = Math.min(width, Math.max(0, (e?.clientX ?? 0) - rect.left));
            return Math.min(1, Math.max(0, x / width));
        }

        function initSeekBar(bar) {
            if (!bar) return;
            const usePointer = 'PointerEvent' in window;
            if (!usePointer) {
                bar.addEventListener('click', (e) => {
                    const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
                    if (!dur) return;
                    const ratio = seekRatioFromEvent(e, bar);
                    audio.currentTime = ratio * dur;
                    updateProgressUI();
                });
                return;
            }

            bar.style.touchAction = 'none';

            const onDown = (e) => {
                const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
                if (!dur) return;
                try {
                    if (typeof e?.preventDefault === 'function') e.preventDefault();
                } catch {}
                seekDragging = true;
                document.body.classList.add('mm-seeking');
                seekDragWasPlaying = !!(audio.src && !audio.paused);
                seekDragRatio = seekRatioFromEvent(e, bar);
                updateProgressUI();
                try {
                    if (typeof bar.setPointerCapture === 'function') bar.setPointerCapture(e.pointerId);
                } catch {}
            };

            const onMove = (e) => {
                if (!seekDragging) return;
                seekDragRatio = seekRatioFromEvent(e, bar);
                updateProgressUI();
            };

            const onEnd = async (e) => {
                if (!seekDragging) return;
                try {
                    const dur = Number.isFinite(audio.duration) ? audio.duration : 0;
                    if (dur) {
                        const nextTime = Math.min(dur, Math.max(0, seekDragRatio * dur));
                        audio.currentTime = nextTime;
                    }
                    seekDragging = false;
                    updateProgressUI();
                    if (seekDragWasPlaying) {
                        try {
                            await mmPlay('拖动进度条续播');
                        } catch (err) {
                            mmAlert(err instanceof Error ? err.message : '音频播放失败');
                        }
                    }
                    seekDragWasPlaying = false;
                } finally {
                    document.body.classList.remove('mm-seeking');
                }
                try {
                    if (typeof bar.releasePointerCapture === 'function') bar.releasePointerCapture(e.pointerId);
                } catch {}
            };

            bar.addEventListener('pointerdown', onDown);
            bar.addEventListener('pointermove', onMove);
            bar.addEventListener('pointerup', onEnd);
            bar.addEventListener('pointercancel', onEnd);
        }

        initSeekBar(playerPageProgress);
        initSeekBar(progress);

        audio.addEventListener('timeupdate', updateProgressUI);
        audio.addEventListener('loadedmetadata', updateProgressUI);
        audio.addEventListener('play', () => {
            setPlayIcon(true);
            updateInlinePlayButtonsUI();
            notifyNativePlaying(true);
        });
        audio.addEventListener('pause', () => {
            setPlayIcon(false);
            updateInlinePlayButtonsUI();
            notifyNativePlaying(false);
        });
        audio.addEventListener('play', updatePlayerPagePlayUI);
        audio.addEventListener('pause', updatePlayerPagePlayUI);
        audio.addEventListener('ended', () => {
            setPlayIcon(false);
            notifyNativePlaying(false);
            skip(1, true);
        });

        function updateToggleIcons(isLight) {
            const iconName = isLight ? 'light_mode' : 'dark_mode';
            if (themeToggleDesktop) {
                const icon = themeToggleDesktop.querySelector('.material-icons');
                if (icon) icon.innerText = iconName;
            }
            if (themeToggleMobile) {
                const icon = themeToggleMobile.querySelector('.material-icons');
                if (icon) icon.innerText = iconName;
            }
        }

        function notifyNativeTheme(isLight) {
            try {
                if (window.MagicMusicAndroid && typeof window.MagicMusicAndroid.setTheme === 'function') {
                    window.MagicMusicAndroid.setTheme(isLight ? 'light' : 'dark');
                }
            } catch {}
        }

        function notifyNativePlaying(isPlaying) {
            try {
                if (window.MagicMusicAndroid && typeof window.MagicMusicAndroid.setPlaying === 'function') {
                    window.MagicMusicAndroid.setPlaying(isPlaying ? '1' : '0');
                }
            } catch {}
        }

        if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
            html.classList.add('light');
            updateToggleIcons(true);
            notifyNativeTheme(true);
        } else {
            html.classList.remove('light');
            updateToggleIcons(false);
            notifyNativeTheme(false);
        }

        function toggleTheme() {
            const isLight = html.classList.toggle('light');
            localStorage.theme = isLight ? 'light' : 'dark';
            updateToggleIcons(isLight);
            notifyNativeTheme(isLight);
        }

        if (themeToggleDesktop) themeToggleDesktop.addEventListener('click', toggleTheme);
        if (themeToggleMobile) themeToggleMobile.addEventListener('click', toggleTheme);

        Array.from(document.querySelectorAll('img')).forEach((img) => {
            const src = img.getAttribute('src') || '';
            const next = proxify(src);
            if (next && next !== src) img.setAttribute('src', next);
        });

        if (playerLikeBtn) {
            playerLikeBtn.addEventListener('click', async () => {
                try {
                    await toggleLikeForCurrent();
                } catch (err) {
                    alert(err instanceof Error ? err.message : '操作失败');
                }
            });
        }

        async function refreshAuthCaptcha() {
            if (!authCaptchaIdInput || !authCaptchaImg) return;
            try {
                const data = await apiRequest('/api/auth/captcha', { method: 'GET' });
                authCaptchaIdInput.value = String(data?.id || '');
                authCaptchaImg.innerHTML = String(data?.svg || '');
                if (authCaptchaCodeInput) authCaptchaCodeInput.value = '';
            } catch {
                authCaptchaIdInput.value = '';
                authCaptchaImg.innerText = '验证码加载失败';
            }
        }

        function setAuthMode(nextMode) {
            authMode = nextMode === 'register' ? 'register' : 'login';
            if (authModeLoginBtn) {
                const active = authMode === 'login';
                authModeLoginBtn.classList.toggle('bg-material-primary', active);
                authModeLoginBtn.classList.toggle('text-material-on-primary', active);
                authModeLoginBtn.classList.toggle('text-material-text-secondary', !active);
                authModeLoginBtn.classList.toggle('hover:text-material-text', !active);
                authModeLoginBtn.classList.toggle('hover:bg-material-text/5', !active);
            }
            if (authModeRegisterBtn) {
                const active = authMode === 'register';
                authModeRegisterBtn.classList.toggle('bg-material-primary', active);
                authModeRegisterBtn.classList.toggle('text-material-on-primary', active);
                authModeRegisterBtn.classList.toggle('text-material-text-secondary', !active);
                authModeRegisterBtn.classList.toggle('hover:text-material-text', !active);
                authModeRegisterBtn.classList.toggle('hover:bg-material-text/5', !active);
            }
            if (authModeHint) {
                authModeHint.innerText = authMode === 'register' ? '创建新账号后自动登录' : '使用已有账号登录';
            }
            if (loginSubmitBtn) {
                loginSubmitBtn.innerText = authMode === 'register' ? '注册并登录' : '登录';
            }
            refreshAuthCaptcha();
        }

        if (authModeLoginBtn) authModeLoginBtn.addEventListener('click', () => setAuthMode('login'));
        if (authModeRegisterBtn) authModeRegisterBtn.addEventListener('click', () => setAuthMode('register'));
        setAuthMode('login');

        if (authCaptchaRefreshBtn) authCaptchaRefreshBtn.addEventListener('click', refreshAuthCaptcha);

        if (loginSubmitBtn) {
            loginSubmitBtn.addEventListener('click', async () => {
                const username = String(loginUsernameInput?.value || '').trim();
                const password = String(loginPasswordInput?.value || '');
                if (!username || username.length < 3) {
                    alert('请输入用户名（至少 3 个字符）');
                    return;
                }
                if (!password || password.length < 6) {
                    alert('请输入密码（至少 6 个字符）');
                    return;
                }
                const captchaId = String(authCaptchaIdInput?.value || '').trim();
                const captchaCode = String(authCaptchaCodeInput?.value || '').trim();
                if (!captchaId) {
                    await refreshAuthCaptcha();
                    alert('请先获取验证码');
                    return;
                }
                if (!captchaCode) {
                    alert('请输入验证码');
                    return;
                }
                try {
                    if (authMode === 'register') {
                        const data = await apiRequest('/api/auth/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password, autoLogin: true, captchaId, captchaCode }),
                        });
                        currentUser = data && data.user ? data.user : null;
                        updateUserUI();
                        await syncUserDataFromServer();
                        if (authMode === 'register') setAuthMode('login');
                        return;
                    }
                    const data = await apiRequest('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, captchaId, captchaCode }),
                    });
                    currentUser = data && data.user ? data.user : null;
                    updateUserUI();
                    await syncUserDataFromServer();
                    if (authMode === 'register') setAuthMode('login');
                } catch (err) {
                    const fallback = authMode === 'register' ? '注册失败' : '登录失败';
                    alert(err instanceof Error ? err.message : fallback);
                    await refreshAuthCaptcha();
                }
            });
        }

        if (registerSubmitBtn) {
            registerSubmitBtn.addEventListener('click', async () => {
                const username = String(registerUsernameInput?.value || '').trim();
                const password = String(registerPasswordInput?.value || '');
                if (!username || username.length < 3) {
                    alert('请输入用户名（3-20 个字符）');
                    return;
                }
                if (!password || password.length < 6) {
                    alert('请输入密码（至少 6 个字符）');
                    return;
                }
                const captchaId = String(authCaptchaIdInput?.value || '').trim();
                const captchaCode = String(authCaptchaCodeInput?.value || '').trim();
                if (!captchaId) {
                    await refreshAuthCaptcha();
                    alert('请先获取验证码');
                    return;
                }
                if (!captchaCode) {
                    alert('请输入验证码');
                    return;
                }
                try {
                    const data = await apiRequest('/api/auth/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, captchaId, captchaCode }),
                    });
                    currentUser = data && data.user ? data.user : null;
                    updateUserUI();
                    await syncUserDataFromServer();
                    alert('注册成功，请登录');
                } catch (err) {
                    alert(err instanceof Error ? err.message : '注册失败');
                    await refreshAuthCaptcha();
                }
            });
        }

        if (userLogoutBtn) {
            userLogoutBtn.addEventListener('click', async () => {
                try {
                    await apiRequest('/api/auth/logout', { method: 'POST' });
                } catch {}
                currentUser = null;
                updateUserUI();
                loadLocalLists();
                renderMyLists();
                renderCreatedPlaylists();
            });
        }

        loadPlayerSettings();
        loadLocalLists();
        updateUserUI();
        initVolume();
        initPlayerPageCarousel();
        initMobilePlayerPageFullscreen();
        initSidebarToggle();
        initRecommendations();
        initLocalPlaylists();
        if (window.location.pathname === '/player' && window.history.length <= 1) {
            window.history.replaceState({}, '', '/playlists');
            window.history.pushState({}, '', '/player');
        }
        applyRoute(window.location.pathname);
        setActiveNavByPath(window.location.pathname);
        if (window.location.pathname === '/artists') {
            initArtistsInitialBar();
            artistsBrowseState.initial = '';
            artistsBrowseState.page = 1;
            artistsBrowseState.hasMore = true;
            artistsBrowseState.seen = new Set();
            setArtistsInitialActive('');
            setArtistsLoadMoreVisible(false);
            showArtistsHint();
        }
        refreshCurrentUser();
        updatePlayerPageUI();
        updatePlayerBarUI();
        updateProgressUI();
        window.addEventListener('DOMContentLoaded', () => {
            const btns = [
                document.getElementById('copyright-btn'),
                document.getElementById('copyright-btn-mobile'),
            ].filter(Boolean);
            const copyrightModal = document.getElementById('copyright-modal');
            const copyrightClose = document.getElementById('copyright-modal-close');

            if (!btns.length || !copyrightModal || !copyrightClose) return;
            btns.forEach((b) => b.addEventListener('click', () => copyrightModal.classList.add('open')));
            copyrightClose.addEventListener('click', () => {
                copyrightModal.classList.remove('open');
            });
            copyrightModal.addEventListener('click', (e) => {
                if (e.target === copyrightModal) {
                    copyrightModal.classList.remove('open');
                }
            });
        });
    </script>
    <!-- Copyright Modal -->
    <div id="copyright-modal">
        <div class="bg-material-surface border border-material-border/60 rounded-xl p-6 max-w-sm w-full mx-4 shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold text-material-text mb-4">版权声明</h3>
            <p class="text-material-text-secondary text-sm leading-relaxed mb-6">
                本站所有资源均来自互联网，版权归原作者所有。本站仅供学习交流使用，请勿用于商业用途。如有侵权，请联系我们删除。
            </p>
            <div class="flex justify-end">
                <button id="copyright-modal-close" class="px-4 py-2 bg-material-primary text-material-on-primary rounded-lg text-sm font-medium hover:bg-material-primary/90 transition">
                    我知道了
                </button>
            </div>
        </div>
    </div>
</body>
</html>
